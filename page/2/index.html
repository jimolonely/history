<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-111673440-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>在我的世界</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="who,where,what">
<meta property="og:type" content="website">
<meta property="og:title" content="在我的世界">
<meta property="og:url" content="http://jimolonely.github.io/history/page/2/index.html">
<meta property="og:site_name" content="在我的世界">
<meta property="og:description" content="who,where,what">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jackpler">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/history/atom.xml" title="在我的世界" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/history/css/style.css">

<meta name="generator" content="Hexo 6.1.0"><link rel="stylesheet" href="/history/css/prism-atom-dark.css" type="text/css">
<link rel="stylesheet" href="/history/css/prism-line-numbers.css" type="text/css"><script src="/history/js/prism.js"></script>
<script src="/history/js/prism-line-numbers.min.js"></script></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/history/" id="logo">在我的世界</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/history/">home</a>
        
          <a class="main-nav-link" href="/history/archives">archives</a>
        
          <a class="main-nav-link" href="/history/about">about</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/history/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://jimolonely.github.io/history"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-basic/022-jwt-pro-between-different-lib" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/28/basic/022-jwt-pro-between-different-lib/" class="article-date">
  <time datetime="2019-09-28T08:49:31.000Z" itemprop="datePublished">2019-09-28</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/28/basic/022-jwt-pro-between-different-lib/">JWT在不同库中的实现差异问题</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>今天需要跨系统验证JWT时发现验证不通过：</p>
<p>A（java，采用<a target="_blank" rel="noopener" href="https://github.com/jwtk/jjwt/issues?utf8=%E2%9C%93&q=secret+base64">jjwt</a>生成）</p>
<p>B（python，采用<a target="_blank" rel="noopener" href="https://github.com/mpdavis/python-jose/">python-jose</a>生成）</p>
<p>同样的secret key，但是相互验证通不过。</p>
<p>原因：base64编码，jjwt编码的方式不一样。</p>
<p>解决办法：换一个java jwt库：<a target="_blank" rel="noopener" href="https://github.com/auth0/java-jwt">auth0&#x2F;java-jwt</a></p>
<p>这下就通过了，其实js也有问题，jjwt和<a target="_blank" rel="noopener" href="https://jwt.io/">官网</a>的结果也有区别。</p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>今天需要跨系统验证JWT时发现验证不通过：</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/28/basic/022-jwt-pro-between-different-lib/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/28/basic/022-jwt-pro-between-different-lib/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/28/basic/022-jwt-pro-between-different-lib/" data-id="cl1fw7fi4001mvkd36m1gc980" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/jwt/" rel="tag">jwt</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/python/" rel="tag">python</a><span class="article-tag-list-count">15</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-life/033-weekly-learn" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/27/life/033-weekly-learn/" class="article-date">
  <time datetime="2019-09-27T12:04:11.000Z" itemprop="datePublished">2019-09-27</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/27/life/033-weekly-learn/">2019-39-周报</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>这是2019年第39周周报.</p>
<p>这周干了好多事，新生活充满激情又充实，还能锻炼肌肉和心智。</p>
<ol>
<li><a href="/2019/09/29/java/073-SLF4JLoggerContext-cannot-be-cast-to-LoggerContext/" title="SLF4JLoggerContext cannot be cast to LoggerContext">SLF4JLoggerContext cannot be cast to LoggerContext</a></li>
</ol>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>这是2019年第39周周报.</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/27/life/033-weekly-learn/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/27/life/033-weekly-learn/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/27/life/033-weekly-learn/" data-id="cl1fw7fkf007xvkd348hrbgiw" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-db/011-mysql-decimal" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/24/db/011-mysql-decimal/" class="article-date">
  <time datetime="2019-09-24T01:01:32.000Z" itemprop="datePublished">2019-09-24</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/24/db/011-mysql-decimal/">mysql decimal用法与问题</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>推荐用decimal来存数字，为什么？</p>
<h1 id="数字类型decimal"><a href="#数字类型decimal" class="headerlink" title="数字类型decimal"></a>数字类型decimal</h1><p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.6/en/fixed-point-types.html">https://dev.mysql.com/doc/refman/5.6/en/fixed-point-types.html</a></p>
<p><code>DECIMAL</code>和<code>NUMERIC</code>类型存储精确的数值数据值。当保留精确度非常重要时，例如使用货币数据，则使用这些类型。在MySQL中，NUMERIC被实现为DECIMAL，因此以下有关DECIMAL的说明同样适用于NUMERIC。</p>
<p>MySQL以<code>二进制格式</code>存储DECIMAL值。</p>
<p>在DECIMAL列声明中，可以（通常是）指定精度和小数位数。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salary DECIMAL(5,2)</span><br></pre></td></tr></table></figure>

<p>在此示例中，5是精度，2是小数位。精度表示值存储的有效位数，小数位表示小数点后可存储的位数。</p>
<p>标准SQL要求DECIMAL（5,2）能够存储具有五位数字和两个小数的任何值，因此可以存储在薪水列中的值的范围是 **<code>-999.99</code>到<code>999.99</code>**。</p>
<p>在标准SQL中，语法DECIMAL（M）等效于DECIMAL（M，0）。同样，语法DECIMAL等效于DECIMAL（M，0），其中允许实现决定M的值。MySQL支持DECIMAL语法的这两种变体形式。 <strong>M的默认值为10</strong>。</p>
<p>如果小数位数为0，则DECIMAL值不包含小数点或小数部分。</p>
<p>DECIMAL的最大位数为65，但是给定DECIMAL列的实际范围可能受给定列的精度或小数位数的限制。如果为这样的列分配的值在小数点后的位数比指定刻度允许的位数多，则该值将转换为该刻度。 （精确的行为是特定于操作系统的，但是通常效果是将其截断为允许的位数。）</p>
<blockquote>
<p>简单一句话：decimal(M,N)总共能存M位数，其中N位小数，剩下M-N位整数</p>
</blockquote>
<p>如果有兴趣，可以研究下存储格式：<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.6/en/precision-math-decimal-characteristics.html">https://dev.mysql.com/doc/refman/5.6/en/precision-math-decimal-characteristics.html</a></p>
<h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><ol>
<li>存储金钱</li>
<li>存储经纬度：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wangqing_12345/article/details/57416370">https://blog.csdn.net/wangqing_12345&#x2F;article&#x2F;details&#x2F;57416370</a></li>
</ol>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><p>加入 字段类型为 decimal(10,6), 存储的值为：<code>100.12</code>, 实际数据库为：<code>100.120000</code>,但是比较时可以直接拿<code>100.12</code>去比较，不存在double或float的小数漂移问题。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tb <span class="keyword">where</span> col <span class="operator">=</span> <span class="number">100.12</span></span><br></pre></td></tr></table></figure>


      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>推荐用decimal来存数字，为什么？</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/24/db/011-mysql-decimal/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/24/db/011-mysql-decimal/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/24/db/011-mysql-decimal/" data-id="cl1fw7fj80042vkd3fwt4al5p" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/mysql/" rel="tag">mysql</a><span class="article-tag-list-count">5</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/072-cors-keep-session" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/23/java/072-cors-keep-session/" class="article-date">
  <time datetime="2019-09-23T08:31:01.000Z" itemprop="datePublished">2019-09-23</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/23/java/072-cors-keep-session/">前后端分离后如何继续使用session</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文说明前后端分离后如何继续使用session，示例代码使用vue+springboot，但是原理对所有技术栈都适用。</p>
<h1 id="0-session的原理"><a href="#0-session的原理" class="headerlink" title="0.session的原理"></a>0.session的原理</h1><p>维持前后端状态的东西叫：SESSIONID, 存在cookie里，在分离之前，浏览器会在每次请求时带上这个session id, 服务端实际上将用户信息以key-value形式存储，<br>key为session id，value为用户信息。</p>
<p>分离之后：</p>
<p>在进行session会话管理的时候，前端无法发送cookie到后端，前端每次访问后端都相当于一次新的会话，这样就导致登录后的信息是无法保存的。客户端每一次访问都需要重新登录。</p>
<h1 id="1-前端"><a href="#1-前端" class="headerlink" title="1.前端"></a>1.前端</h1><p>在配置中设置<code>withCredentials: true</code>:</p>
<p><strong>当然，因为每个请求都需要加，配置全局的拦截器里比较好</strong></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">login</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> p = &#123;</span><br><span class="line">    <span class="string">&quot;userName&quot;</span>: <span class="string">&quot;xxx&quot;</span>,</span><br><span class="line">    <span class="string">&quot;userPassword&quot;</span>: <span class="string">&quot;xxx&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">  axios.<span class="title function_">post</span>(<span class="variable language_">this</span>.<span class="property">baseUrl</span>+<span class="string">&#x27;/api/auth/login&#x27;</span>,p,&#123;</span><br><span class="line">    <span class="attr">withCredentials</span>: <span class="literal">true</span></span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或jquery ajax：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">   <span class="attr">url</span>: a_cross_domain_url,</span><br><span class="line">   <span class="attr">xhrFields</span>: &#123;</span><br><span class="line">      <span class="attr">withCredentials</span>: <span class="literal">true</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="2-后端"><a href="#2-后端" class="headerlink" title="2.后端"></a>2.后端</h1><ul>
<li>服务端的<code>Access-Control-Allow-Origin</code> 不可以设置为<code>&quot;*&quot;</code>，必须指定明确的、与请求网页一致的域名(Origin)</li>
<li>服务端的 <code>Access-Control-Allow-Credentials: true</code>，代表服务器接受Cookie和HTTP认证信息。因为在CORS下，是默认不接受的</li>
</ul>
<p>在springboot里可以这样：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorsConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">//设置允许跨域的路径</span></span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                <span class="comment">//是否允许证书,不再默认开启</span></span><br><span class="line">                .allowCredentials(<span class="literal">true</span>)</span><br><span class="line">                .allowedOrigins(<span class="string">&quot;localhost&quot;</span>)</span><br><span class="line">                <span class="comment">//设置允许的方法</span></span><br><span class="line">                .allowedMethods(<span class="string">&quot;POST&quot;</span>, <span class="string">&quot;GET&quot;</span>, <span class="string">&quot;PUT&quot;</span>, <span class="string">&quot;OPTIONS&quot;</span>, <span class="string">&quot;DELETE&quot;</span>)</span><br><span class="line">                <span class="comment">//跨域允许时间</span></span><br><span class="line">                .maxAge(<span class="number">3600</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者使用基础的HttpServletResponse:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> &#123;</span><br><span class="line"></span><br><span class="line">    response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, request.getHeader(<span class="string">&quot;Origin&quot;</span>));</span><br><span class="line">    response.setHeader(<span class="string">&quot;Access-Control-Max-Age&quot;</span>, <span class="string">&quot;3600&quot;</span>);</span><br><span class="line">    response.addHeader(<span class="string">&quot;Access-Control-Allow-Credentials&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-使用"><a href="#3-使用" class="headerlink" title="3.使用"></a>3.使用</h1><p>现在就可以用 <code>request.getSession()</code>的经典语句了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.getSession().setAttribute(<span class="string">&quot;user&quot;</span>, userName);</span><br><span class="line"></span><br><span class="line"> <span class="type">Object</span> <span class="variable">user</span> <span class="operator">=</span> request.getSession().getAttribute(<span class="string">&quot;user&quot;</span>);</span><br></pre></td></tr></table></figure>




      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文说明前后端分离后如何继续使用session，示例代码使用vue+springboot，但是原理对所有技术栈都适用。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/23/java/072-cors-keep-session/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/23/java/072-cors-keep-session/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/23/java/072-cors-keep-session/" data-id="cl1fw7fly00d9vkd34cwn8gus" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/cors/" rel="tag">cors</a><span class="article-tag-list-count">2</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/springboot/" rel="tag">springboot</a><span class="article-tag-list-count">3</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/071-springboot-preflight-options" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/23/java/071-springboot-preflight-options/" class="article-date">
  <time datetime="2019-09-23T05:38:02.000Z" itemprop="datePublished">2019-09-23</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/23/java/071-springboot-preflight-options/">axios设置请求头不成功,预检请求被拦截</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>在跨域时，使用axios在header里设置了自定义请求头，但是后台没获取到，因为浏览器端得request header里也没有。</p>
<h1 id="axios请求代码"><a href="#axios请求代码" class="headerlink" title="axios请求代码"></a>axios请求代码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">axios.<span class="title function_">get</span>(<span class="string">&#x27;http://localhost:8080/test&#x27;</span>,&#123;</span><br><span class="line">  headers : &#123;</span><br><span class="line">      <span class="string">&#x27;Authentication&#x27;</span>: <span class="string">&#x27;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJ7XCJpZFwiOjEsXCJwYXNzd29yZFwiOlwiM2JmMDY0MThlOTM2NGVmYWJhOTRhZGE5NWFlNzgwOWNcIixcInBob25lXCI6XCIxMTBcIixcInVzZXJuYW1lXCI6XCJqaW1vXCJ9Iiwicm9sZXMiOiJ1c2VyIiwiaWF0IjoxNTY5MjEzODU4LCJleHAiOjE1NjkyMTc0NTh9.ZW5F1h1GpEG1Qo-X4BAqWsKlZPOlCIIwRKV3bAtKUSU&#x27;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">res</span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>然而浏览器端没有Authentication这个header。</p>
<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>后台是这么写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// token 验证</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authentication&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthFailException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 允许返回token在响应头中</span></span><br><span class="line">            response.setHeader(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            response.setHeader(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, request.getHeader(<span class="string">&quot;Origin&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> JwtUtil.checkToken(token);</span><br><span class="line"></span><br><span class="line">            response.setHeader(<span class="string">&quot;token&quot;</span>, JwtUtil.getToken(userInfo));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthFailException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因就在于CORS请求会先发一个OPTIONS请求，这个请求是没有Authentication这个header的，所以验证失败，那么只需要允许预检请求就好：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 预检请求得放行</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;OPTIONS&quot;</span>.equals(request.getMethod())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// token 验证...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参考：<a target="_blank" rel="noopener" href="https://segmentfault.com/q/1010000012364132">https://segmentfault.com/q/1010000012364132</a></p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>在跨域时，使用axios在header里设置了自定义请求头，但是后台没获取到，因为浏览器端得request header里也没有。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/23/java/071-springboot-preflight-options/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/23/java/071-springboot-preflight-options/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/23/java/071-springboot-preflight-options/" data-id="cl1fw7flx00d6vkd30i9bc0v9" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/axios/" rel="tag">axios</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/cors/" rel="tag">cors</a><span class="article-tag-list-count">2</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/springboot/" rel="tag">springboot</a><span class="article-tag-list-count">3</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/070-springboot-interceptor-add-header-pro" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/22/java/070-springboot-interceptor-add-header-pro/" class="article-date">
  <time datetime="2019-09-22T09:00:42.000Z" itemprop="datePublished">2019-09-22</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/22/java/070-springboot-interceptor-add-header-pro/">springboot interceptor posthandle 添加自定义header</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>今天发现springboot里interceptor的一个问题：</p>
<p>在postHandle方法里设置header不会返回到前端，而在preHandle里设置就可以。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandlerInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// token 验证</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authentication&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthFailException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userInfo</span> <span class="operator">=</span> JwtUtil.checkToken(token);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 允许返回token在响应头中</span></span><br><span class="line">            response.setHeader(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            response.setHeader(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">            response.setHeader(<span class="string">&quot;token&quot;</span>, JwtUtil.getToken(userInfo));</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthFailException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>今天发现springboot里interceptor的一个问题：</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/22/java/070-springboot-interceptor-add-header-pro/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/22/java/070-springboot-interceptor-add-header-pro/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/22/java/070-springboot-interceptor-add-header-pro/" data-id="cl1fw7flw00d1vkd3bzof7b69" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/spring/" rel="tag">spring</a><span class="article-tag-list-count">12</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-python/009-jupyterhub-github-oauth-error-fix" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/" class="article-date">
  <time datetime="2019-09-19T12:48:28.000Z" itemprop="datePublished">2019-09-19</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/">jupyterhub接入github认证oauth2.0的问题记录与解决</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>使用环境：</p>
<ul>
<li>ubuntu18.04</li>
<li>python: 3.6</li>
<li>jupyterhub:1.0.0</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 list | grep jupyter</span><br><span class="line">jupyter-client          5.3.3              </span><br><span class="line">jupyter-core            4.5.0              </span><br><span class="line">jupyterhub              1.0.0</span><br></pre></td></tr></table></figure>

<h1 id="tornado-simple-httpclient-HTTPStreamClosedError-Stream-closed"><a href="#tornado-simple-httpclient-HTTPStreamClosedError-Stream-closed" class="headerlink" title="tornado.simple_httpclient.HTTPStreamClosedError: Stream closed"></a>tornado.simple_httpclient.HTTPStreamClosedError: Stream closed</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 20:43:31.611 JupyterHub oauth2:100] OAuth redirect: &#x27;http://localhost:8000/hub/oauth_callback&#x27;</span><br><span class="line">[I 2019-09-19 20:43:31.615 JupyterHub log:174] 302 GET /hub/oauth_login?next= -&gt; https://github.com/login/oauth/authorize?response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8000%2Fhub%2Foauth_callback&amp;client_id=b65e07b5e5de7471a7f1&amp;state=[secret] (@::1) 4.52ms</span><br><span class="line">[E 2019-09-19 20:43:39.924 JupyterHub web:1788] Uncaught exception GET /hub/oauth_callback?code=f44ca95caf1e0ea417c7&amp;state=eyJzdGF0ZV9pZCI6ICJiNWQ5NTY2ZjJjNWQ0ODMxOTNjYmZiZjcwNTY1Zjc4ZCIsICJuZXh0X3VybCI6ICIifQ%3D%3D (::1)</span><br><span class="line">    HTTPServerRequest(protocol=&#x27;http&#x27;, host=&#x27;localhost:8000&#x27;, method=&#x27;GET&#x27;, uri=&#x27;/hub/oauth_callback?code=f44ca95caf1e0ea417c7&amp;state=eyJzdGF0ZV9pZCI6ICJiNWQ5NTY2ZjJjNWQ0ODMxOTNjYmZiZjcwNTY1Zjc4ZCIsICJuZXh0X3VybCI6ICIifQ%3D%3D&#x27;, version=&#x27;HTTP/1.1&#x27;, remote_ip=&#x27;::1&#x27;)</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/tornado/web.py&quot;, line 1699, in _execute</span><br><span class="line">        result = await result</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/oauthenticator/oauth2.py&quot;, line 207, in get</span><br><span class="line">        user = await self.login_user()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 655, in login_user</span><br><span class="line">        authenticated = await self.authenticate(data)</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/auth.py&quot;, line 383, in get_authenticated_user</span><br><span class="line">        authenticated = await maybe_future(self.authenticate(handler, data))</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/oauthenticator/github.py&quot;, line 115, in authenticate</span><br><span class="line">        resp = await http_client.fetch(req)</span><br><span class="line">    tornado.simple_httpclient.HTTPStreamClosedError: Stream closed</span><br><span class="line">    </span><br><span class="line">[E 2019-09-19 20:43:39.932 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;_ga=[secret]; _xsrf=[secret]; oauthenticator-state=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;cross-site&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 20:43:39.932 JupyterHub log:174] 500 GET /hub/oauth_callback?code=[secret]&amp;state=[secret] (@::1) 902.66ms</span><br></pre></td></tr></table></figure>

<p>看这个issue：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/2448">https://github.com/jupyterhub/jupyterhub/issues/2448</a></p>
<p>卸载tornado 6.x版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 -m pip uninstall tornado</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip/http&#x27; or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">Uninstalling tornado-6.0.3:</span><br><span class="line">  Would remove:</span><br><span class="line">    /usr/local/lib/python3.6/dist-packages/tornado-6.0.3.dist-info/*</span><br><span class="line">    /usr/local/lib/python3.6/dist-packages/tornado/*</span><br><span class="line">Proceed (y/n)? y</span><br><span class="line">  Successfully uninstalled tornado-6.0.3</span><br></pre></td></tr></table></figure>

<p>安装5.1.1版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 -m pip install tornado==5.1.1</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip/http&#x27; or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip&#x27; or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">Collecting tornado==5.1.1</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/e6/78/6e7b5af12c12bdf38ca9bfe863fcaf53dc10430a312d0324e76c1e5ca426/tornado-5.1.1.tar.gz (516kB)</span><br><span class="line">     |████████████████████████████████| 522kB 207kB/s </span><br><span class="line">Building wheels for collected packages: tornado</span><br><span class="line">  Building wheel for tornado (setup.py) ... done</span><br><span class="line">  Created wheel for tornado: filename=tornado-5.1.1-cp36-cp36m-linux_x86_64.whl size=449843 sha256=b4edbb1e0fc62a3492f261537c508c37aa566f5272e5caeb24261c2e047a2e5f</span><br><span class="line">  Stored in directory: /home/jack/.cache/pip/wheels/6d/e1/ce/f4ee2fa420cc6b940123c64992b81047816d0a9fad6b879325</span><br><span class="line">Successfully built tornado</span><br><span class="line">Installing collected packages: tornado</span><br><span class="line">Successfully installed tornado-5.1.1</span><br></pre></td></tr></table></figure>

<p>重启服务后，已经可以登录，但是由于没有将github用户名添加进白名单，因此出现403.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[W 2019-09-19 20:54:40.059 JupyterHub auth:426] User &#x27;jimolonely&#x27; not in whitelist.</span><br><span class="line">[W 2019-09-19 20:54:40.060 JupyterHub base:670] Failed login for unknown user</span><br></pre></td></tr></table></figure>
<p>添加完白名单后。</p>
<p>接着：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=KeyError(&quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;,)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">    await spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 642, in spawn</span><br><span class="line">    raise e</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 546, in spawn</span><br><span class="line">    url = await gen.with_timeout(timedelta(seconds=spawner.start_timeout), f)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1377, in start</span><br><span class="line">    env = self.get_env()</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1326, in get_env</span><br><span class="line">    env = self.user_env(env)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1313, in user_env</span><br><span class="line">    home = pwd.getpwnam(self.user.name).pw_dir</span><br><span class="line">KeyError: &quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;</span><br><span class="line">[E 2019-09-19 20:58:24.051 JupyterHub pages:284] Previous spawn for jimolonely failed: &quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;</span><br><span class="line">[E 2019-09-19 20:58:24.052 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-hub-login=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 20:58:24.052 JupyterHub log:174] 500 GET /hub/spawn-pending/jimolonely (jimolonely@::1) 8.53ms</span><br></pre></td></tr></table></figure>

<p><code>spawn for jimolonely failed: &quot;getpwnam()</code>是给这个用户创建notebook实例时失败。</p>
<p>我们新建本地用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo useradd jimolonely</span><br><span class="line"></span><br><span class="line">$ sudo passwd jimolonely</span><br><span class="line">输入新的 UNIX 密码： </span><br><span class="line">重新输入新的 UNIX 密码： </span><br><span class="line">passwd：已成功更新密码</span><br></pre></td></tr></table></figure>

<p>然后又报错了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=SubprocessError(&#x27;Exception occurred in preexec_fn.&#x27;,)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">    await spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 642, in spawn</span><br><span class="line">    raise e</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 546, in spawn</span><br><span class="line">    url = await gen.with_timeout(timedelta(seconds=spawner.start_timeout), f)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1397, in start</span><br><span class="line">    self.proc = Popen(cmd, **popen_kwargs)</span><br><span class="line">  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 729, in __init__</span><br><span class="line">    restore_signals, start_new_session)</span><br><span class="line">  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 1365, in _execute_child</span><br><span class="line">    raise child_exception_type(err_msg)</span><br><span class="line">subprocess.SubprocessError: Exception occurred in preexec_fn.</span><br><span class="line">[E 2019-09-19 21:01:22.325 JupyterHub pages:284] Previous spawn for jimolonely failed: Exception occurred in preexec_fn.</span><br><span class="line">[E 2019-09-19 21:01:22.325 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-hub-login=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>发现是权限问题，使用sudo运行：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/1527">https://github.com/jupyterhub/jupyterhub/issues/1527</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> $ sudo jupyterhub -f jc.py</span><br><span class="line"> ...</span><br><span class="line"> [E 2019-09-19 21:07:26.114 JupyterHub proxy:658] Failed to find proxy [&#x27;configurable-http-proxy&#x27;]</span><br><span class="line">    The proxy can be installed with `npm install -g configurable-http-proxy`.To install `npm`, install nodejs which includes `npm`.If you see an `EACCES` error or permissions error, refer to the `npm` documentation on How To Prevent Permissions Errors.</span><br><span class="line">[C 2019-09-19 21:07:26.114 JupyterHub app:2349] Failed to start proxy</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/app.py&quot;, line 2347, in start</span><br><span class="line">        await self.proxy.start()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/proxy.py&quot;, line 650, in start</span><br><span class="line">        cmd, env=env, start_new_session=True, shell=shell</span><br><span class="line">      File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 729, in __init__</span><br><span class="line">        restore_signals, start_new_session)</span><br><span class="line">      File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 1364, in _execute_child</span><br><span class="line">        raise child_exception_type(errno_num, err_msg, err_filename)</span><br><span class="line">    FileNotFoundError: [Errno 2] No such file or directory: &#x27;configurable-http-proxy&#x27;: &#x27;configurable-http-proxy&#x27;</span><br></pre></td></tr></table></figure>

<p>有报错，既然找不到，就装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g configurable-http-proxy</span><br><span class="line">/home/jack/.npm-global/bin/configurable-http-proxy -&gt; /home/jack/.npm-global/lib/node_modules/configurable-http-proxy/bin/configurable-http-proxy</span><br><span class="line">/home/jack/.npm-global/lib</span><br><span class="line">└── configurable-http-proxy@4.1.0</span><br></pre></td></tr></table></figure>

<p>最后卡在npm上，虽然可以用sudospawner，但是配起来太麻烦，果断换一条路，使用dockerspawner</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner">https://github.com/jupyterhub/dockerspawner</a></p>
<p>记得先安装dockerspawner:<code>python3 -m pip install dockerspawner</code></p>
<p>然后配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.spawner_class = &#x27;dockerspawner.DockerSpawner&#x27;</span><br></pre></td></tr></table></figure>

<p>重启之后，生成docker容器实例超时：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:35:36.053 JupyterHub dockerspawner:998] Found existing container jupyter-jimolonely (id: 0fbb352)</span><br><span class="line">[I 2019-09-19 21:35:36.053 JupyterHub dockerspawner:1013] Starting container jupyter-jimolonely (id: 0fbb352)</span><br><span class="line">[I 2019-09-19 21:35:36.979 JupyterHub log:174] 302 GET /hub/spawn/jimolonely -&gt; /hub/spawn-pending/jimolonely (jimolonely@::1) 1019.86ms</span><br><span class="line">[I 2019-09-19 21:35:37.018 JupyterHub pages:303] jimolonely is pending spawn</span><br><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=HTTPError()&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">tornado.util.TimeoutError: Timeout</span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 922, in spawn_single_user</span><br><span class="line">    % (status, spawner._log_name),</span><br><span class="line">tornado.web.HTTPError: HTTP 500: Internal Server Error (Spawner failed to start [status=ExitCode=1, Error=&#x27;&#x27;, FinishedAt=2019-09-19T13:35:36.863473516Z]. The logs for jimolonely may contain details.)</span><br><span class="line">[W 2019-09-19 21:36:03.703 JupyterHub user:678] jimolonely&#x27;s server never showed up at http://127.0.0.1:32769/user/jimolonely/ after 30 seconds. Giving up</span><br><span class="line">[E 2019-09-19 21:36:03.747 JupyterHub gen:974] Exception in Future &lt;Task finished coro=&lt;BaseHandler.spawn_single_user.&lt;locals&gt;.finish_user_spawn() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:800&gt; exception=TimeoutError(&quot;Server at http://127.0.0.1:32769/user/jimolonely/ didn&#x27;t respond in 30 seconds&quot;,)&gt; after timeout</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/tornado/gen.py&quot;, line 970, in error_callback</span><br><span class="line">        future.result()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">        await spawn_future</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 654, in spawn</span><br><span class="line">        await self._wait_up(spawner)</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 701, in _wait_up</span><br><span class="line">        raise e</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 669, in _wait_up</span><br><span class="line">        http=True, timeout=spawner.http_timeout, ssl_context=ssl_context</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/utils.py&quot;, line 234, in wait_for_http_server</span><br><span class="line">        timeout=timeout,</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/utils.py&quot;, line 177, in exponential_backoff</span><br><span class="line">        raise TimeoutError(fail_message)</span><br><span class="line">    TimeoutError: Server at http://127.0.0.1:32769/user/jimolonely/ didn&#x27;t respond in 30 seconds</span><br></pre></td></tr></table></figure>

<p>实际上，我在本地能看到docker镜像启动过，但马上就死了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">0fbb3529c1d4        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   5 minutes ago       Exited (1) 2 minutes ago                       jupyter-jimolonely</span><br></pre></td></tr></table></figure>

<p>查看docker日志发现是因为docker容器内没有我们配的目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Executing the command: jupyter notebook --ip=0.0.0.0 --port=8888 --notebook-dir=/home/jack/workspace/temp/notebook/jimolonely</span><br><span class="line">[C 13:43:07.016 NotebookApp] Bad config encountered during initialization:</span><br><span class="line">[C 13:43:07.017 NotebookApp] No such notebook dir: &#x27;&#x27;/home/jack/workspace/temp/notebook/jimolonely&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>于是注释掉关于<code>#c.Spawner.notebook_dir=&#39;/home/jack/workspace/temp/notebook/&#123;username&#125;&#39;</code>的配置, <strong>同时删除旧的实例<code>docker rm ID</code></strong>.</p>
<p>再启动，发现docker容器起来了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                   PORTS                       NAMES</span><br><span class="line">4a45cb7e3cbd        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   7 seconds ago       Up 5 seconds             127.0.0.1:32772-&gt;8888/tcp   jupyter-jimolonely</span><br></pre></td></tr></table></figure>

<p>但是昙花一现，界面报500了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">500 : Internal Server Error</span><br><span class="line">The error was:</span><br><span class="line"></span><br><span class="line">Failed to connect to Hub API at &#x27;http://127.0.0.1:8081/hub/api&#x27;.  Is the Hub accessible at this URL (from host: 4a45cb7e3cbd)?  Make sure to set c.JupyterHub.hub_ip to an IP accessible to single-user servers if the servers are not on the same host as the Hub.</span><br></pre></td></tr></table></figure>
<p>下面是启动成功又被删除的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:44:03.884 JupyterHub pages:303] jimolonely is pending spawn</span><br><span class="line">[I 2019-09-19 21:44:04.417 JupyterHub base:810] User jimolonely took 1.547 seconds to start</span><br><span class="line">[I 2019-09-19 21:44:04.418 JupyterHub proxy:261] Adding user jimolonely to proxy /user/jimolonely/ =&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.424 [ConfigProxy] info: Adding route /user/jimolonely -&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.424 [ConfigProxy] info: Route added /user/jimolonely -&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.425 [ConfigProxy] info: 201 POST /api/routes/user/jimolonely </span><br><span class="line">[I 2019-09-19 21:44:04.427 JupyterHub users:606] Server jimolonely is ready</span><br><span class="line">[I 2019-09-19 21:44:04.429 JupyterHub log:174] 200 GET /hub/api/users/jimolonely/server/progress (jimolonely@::1) 451.21ms</span><br><span class="line">[I 2019-09-19 21:44:06.319 JupyterHub log:174] 302 GET /hub/spawn-pending/jimolonely -&gt; /user/jimolonely/ (jimolonely@::1) 13.14ms</span><br><span class="line">[I 2019-09-19 21:44:06.386 JupyterHub log:174] 302 GET /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] -&gt; /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (jimolonely@::1) 23.41ms</span><br><span class="line">[W 2019-09-19 21:45:03.446 JupyterHub base:962] User jimolonely server stopped, with exit code: ExitCode=1, Error=&#x27;&#x27;, FinishedAt=2019-09-19T13:44:50.187356762Z</span><br><span class="line">[I 2019-09-19 21:45:03.446 JupyterHub proxy:281] Removing user jimolonely from proxy (/user/jimolonely/)</span><br><span class="line">21:45:03.451 [ConfigProxy] info: Removing route /user/jimolonely</span><br></pre></td></tr></table></figure>

<p>依然是看docker日志： 这个原因很明显，不能访问<code>http://127.0.0.1:8081/hub/api</code>，这是hub的API接口，但是在容器里这个<code>127.0.0.1</code>是没有的，需要一个外部的IP，也就是运行容器的主机的IP。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs 4a45cb7e3cbd</span><br><span class="line">Executing the command: jupyterhub-singleuser --ip=0.0.0.0 --port=8888</span><br><span class="line">[W 2019-09-19 13:44:03.777 SingleUserNotebookApp configurable:168] Config option `open_browser` not recognized by `SingleUserNotebookApp`.  Did you mean `browser`?</span><br><span class="line">[I 2019-09-19 13:44:03.989 SingleUserNotebookApp extension:155] JupyterLab extension loaded from /opt/conda/lib/python3.7/site-packages/jupyterlab</span><br><span class="line">[I 2019-09-19 13:44:03.989 SingleUserNotebookApp extension:156] JupyterLab application directory is /opt/conda/share/jupyter/lab</span><br><span class="line">[I 2019-09-19 13:44:03.992 SingleUserNotebookApp singleuser:561] Starting jupyterhub-singleuser server version 1.0.1dev</span><br><span class="line">[E 2019-09-19 13:44:03.994 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 1/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[I 2019-09-19 13:44:04.415 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/ -&gt; /user/jimolonely/tree? (@172.17.0.1) 2.17ms</span><br><span class="line">[E 2019-09-19 13:44:05.999 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 2/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[I 2019-09-19 13:44:06.333 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/ -&gt; /user/jimolonely/tree? (@::1) 1.94ms</span><br><span class="line">[I 2019-09-19 13:44:06.353 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/tree? -&gt; /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] (@::1) 5.01ms</span><br><span class="line">[E 2019-09-19 13:44:06.396 SingleUserNotebookApp auth:334] Error connecting to http://127.0.0.1:8081/hub/api: HTTPConnectionPool(host=&#x27;127.0.0.1&#x27;, port=8081): Max retries exceeded with url: /hub/api/oauth2/token (Caused by NewConnectionError(&#x27;&lt;urllib3.connection.HTTPConnection object at 0x7f22d11f9320&gt;: Failed to establish a new connection: [Errno 111] Connection refused&#x27;))</span><br><span class="line">[W 2019-09-19 13:44:06.396 SingleUserNotebookApp web:1782] 500 GET /user/jimolonely/oauth_callback?code=ugtkAb9qodjKXXkZdJbReF92N2apKR&amp;state=eyJ1dWlkIjogImNmMzE3YTRhZDZkYjRlYjI4ZWNlZjdmY2ZmMjdhNzYxIiwgIm5leHRfdXJsIjogIi91c2VyL2ppbW9sb25lbHkvdHJlZT8ifQ (::1): Failed to connect to Hub API at &#x27;http://127.0.0.1:8081/hub/api&#x27;.  Is the Hub accessible at this URL (from host: 4a45cb7e3cbd)?  Make sure to set c.JupyterHub.hub_ip to an IP accessible to single-user servers if the servers are not on the same host as the Hub.</span><br><span class="line">[E 2019-09-19 13:44:06.427 SingleUserNotebookApp web:2991] Could not open static file &#x27;&#x27;</span><br><span class="line">[E 2019-09-19 13:44:06.428 SingleUserNotebookApp log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-user-jimolonely-oauth-state=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Cache-Control&quot;: &quot;max-age=0&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 13:44:06.428 SingleUserNotebookApp log:174] 500 GET /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (@::1) 35.80ms</span><br><span class="line">[W 2019-09-19 13:44:06.464 SingleUserNotebookApp log:174] 404 GET /user/jimolonely/static/components/react/react-dom.production.min.js (@::1) 3.72ms</span><br><span class="line">[W 2019-09-19 13:44:06.496 SingleUserNotebookApp log:174] 404 GET /user/jimolonely/static/components/react/react-dom.production.min.js (@::1) 1.49ms</span><br><span class="line">[E 2019-09-19 13:44:10.003 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 3/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[E 2019-09-19 13:44:18.015 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 4/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[E 2019-09-19 13:44:34.028 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 5/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br></pre></td></tr></table></figure>

<p>通过github上的示例：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/tree/master/examples/oauth">https://github.com/jupyterhub/dockerspawner/tree/master/examples/oauth</a></p>
<p>这里说得很清楚：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>可以看下<code>public_ips()</code>方法的结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>public_ips()</span><br><span class="line">[<span class="string">&#x27;192.168.199.249&#x27;</span>, <span class="string">&#x27;172.17.0.1&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>于是，我们修改完配置后重启，记得，依然要删除旧的容器实例，再次启动，成功了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:59:12.727 JupyterHub log:174] 200 GET /hub/spawn-pending/jimolonely (jimolonely@::1) 10.11ms</span><br><span class="line">[I 2019-09-19 21:59:12.835 JupyterHub log:174] 200 GET /hub/api (@172.17.0.2) 0.50ms</span><br><span class="line">[I 2019-09-19 21:59:12.866 JupyterHub log:174] 200 POST /hub/api/users/jimolonely/activity (jimolonely@172.17.0.2) 15.00ms</span><br><span class="line">[I 2019-09-19 21:59:13.316 JupyterHub base:810] User jimolonely took 1.607 seconds to start</span><br><span class="line">[I 2019-09-19 21:59:13.317 JupyterHub proxy:261] Adding user jimolonely to proxy /user/jimolonely/ =&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.322 [ConfigProxy] info: Adding route /user/jimolonely -&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.323 [ConfigProxy] info: Route added /user/jimolonely -&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.323 [ConfigProxy] info: 201 POST /api/routes/user/jimolonely </span><br><span class="line">[I 2019-09-19 21:59:13.325 JupyterHub users:606] Server jimolonely is ready</span><br><span class="line">[I 2019-09-19 21:59:13.328 JupyterHub log:174] 200 GET /hub/api/users/jimolonely/server/progress (jimolonely@::1) 486.99ms</span><br><span class="line">[I 2019-09-19 21:59:13.368 JupyterHub log:174] 302 GET /hub/spawn-pending/jimolonely -&gt; /user/jimolonely/ (jimolonely@::1) 16.38ms</span><br><span class="line">[I 2019-09-19 21:59:13.449 JupyterHub log:174] 302 GET /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] -&gt; /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (jimolonely@::1) 40.87ms</span><br><span class="line">[I 2019-09-19 21:59:13.511 JupyterHub log:174] 200 POST /hub/api/oauth2/token (jimolonely@172.17.0.2) 44.80ms</span><br></pre></td></tr></table></figure>

<p>界面正常</p>
<p>通过docker里的日志可以看到：创建文件的目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user/jimolonely/api/contents/test1.ipynb</span><br></pre></td></tr></table></figure>

<h1 id="完整配置"><a href="#完整配置" class="headerlink" title="完整配置"></a>完整配置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c.Spawner.notebook_dir=&#x27;/home/jack/workspace/temp/notebook/&#123;username&#125;&#x27;</span></span><br><span class="line">c.Authenticator.whitelist = &#123;<span class="string">&#x27;hehe&#x27;</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;jimolonely&#x27;</span>&#125;</span><br><span class="line">c.Authenticator.admin_users = &#123;<span class="string">&#x27;hehe&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">c.GitHubOAuthenticator.oauth_callback_url = <span class="string">&#x27;http://localhost:8000/hub/oauth_callback&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_id = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_secret = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用REST-API"><a href="#使用REST-API" class="headerlink" title="使用REST API"></a>使用REST API</h1><p>需要做几步：</p>
<ol>
<li>获取token：</li>
</ol>
<ul>
<li>通过界面</li>
<li>通过命令行: <code>jupyterhub token &lt;username&gt;</code></li>
</ul>
<ol start="2">
<li>配置token到配置文件：  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.api_tokens = &#123;</span><br><span class="line">    <span class="string">&#x27;secret-token&#x27;</span>: <span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 1.token是放在header里的，token前面还有个token标识</span><br><span class="line"># 2.默认API端口是8081，冲突了可以改</span><br><span class="line">curl -X GET -H &quot;Authorization: token &lt;token&gt;&quot; &quot;http://IP:8081/hub/api/users/&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="新增用户"><a href="#新增用户" class="headerlink" title="新增用户"></a>新增用户</h1><ol>
<li>通过jupyter接口增加用户</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/_static/rest-api/index.html">接口文档</a></li>
</ul>
<ol start="2">
<li>再登录</li>
</ol>
<h1 id="动态用户"><a href="#动态用户" class="headerlink" title="动态用户"></a>动态用户</h1><p>如果手动设置了白名单配置，那么只有白名单里的用户可以使用，因此去掉白名单声明，启动时可以看到下面的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-20 09:53:14.707 JupyterHub app:1563] Not using whitelist. Any authenticated user will be allowed.</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以自定义认证器：<br><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/1012">https://github.com/jupyterhub/jupyterhub/issues/1012</a></p>
<h1 id="现在的配置"><a href="#现在的配置" class="headerlink" title="现在的配置"></a>现在的配置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c.Spawner.notebook_dir=&#x27;/home/jack/workspace/temp/notebook/&#123;username&#125;&#x27;</span></span><br><span class="line"><span class="comment"># c.Authenticator.whitelist = &#123;&#x27;hehe&#x27;,&#x27;jack&#x27;,&#x27;jimolonely&#x27;&#125;</span></span><br><span class="line"><span class="comment"># c.Authenticator.admin_users = &#123;&#x27;hehe&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.api_tokens = &#123;</span><br><span class="line">    <span class="string">&#x27;95d7628d65224032857d7d36805f3324&#x27;</span>: <span class="string">&#x27;jimolonely&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.GitHubOAuthenticator.oauth_callback_url = <span class="string">&#x27;http://localhost:8000/hub/oauth_callback&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_id = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_secret = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="自定义认证代码"><a href="#自定义认证代码" class="headerlink" title="自定义认证代码"></a>自定义认证代码</h1><p>我们做一个最简单的认证：如果用户名和密码相同就通过。</p>
<p>整个过程如下：</p>
<ol>
<li>写一个自定义认证器，实现jupyterhub的Authenticator类</li>
<li>安装到本地python库</li>
<li>配置自己的认证器类</li>
</ol>
<h2 id="自定义认证器"><a href="#自定义认证器" class="headerlink" title="自定义认证器"></a>自定义认证器</h2><p>认证器代码结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my-authenticator$ tree</span><br><span class="line">.</span><br><span class="line">├── jauth</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── jauth.py</span><br><span class="line">└── setup.py</span><br></pre></td></tr></table></figure>

<p>jauth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> Authenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JimoAuth</span>(<span class="title class_ inherited__">Authenticator</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, handler, data</span>):</span><br><span class="line">        <span class="built_in">print</span>(handler)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line">        username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        <span class="comment"># check password:</span></span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;username&#x27;</span>] == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<p><code>__init__.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .jauth <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<p>setup.py: 安装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">&#x27;jauth&#x27;</span>,</span><br><span class="line">      version=<span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">      description=<span class="string">&#x27;jimo Authenticator for Jupyterhub&#x27;</span>,</span><br><span class="line">      author=<span class="string">&#x27;jimo&#x27;</span>,</span><br><span class="line">      license=<span class="string">&#x27;MIT&#x27;</span>,</span><br><span class="line">      author_email=<span class="string">&#x27;jimo@163.com&#x27;</span>,</span><br><span class="line">      url=<span class="string">&#x27;https://github.com/jimolonely&#x27;</span>,</span><br><span class="line">      packages=[<span class="string">&#x27;jauth&#x27;</span>],</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>

<h2 id="安装到本地python库"><a href="#安装到本地python库" class="headerlink" title="安装到本地python库"></a>安装到本地python库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">my-authenticator$ sudo python3 setup.py install</span><br><span class="line">[sudo] jack 的密码： </span><br><span class="line">running install</span><br><span class="line">running bdist_egg</span><br><span class="line">running egg_info</span><br><span class="line">creating jauth.egg-info</span><br><span class="line">writing jauth.egg-info/PKG-INFO</span><br><span class="line">writing dependency_links to jauth.egg-info/dependency_links.txt</span><br><span class="line">writing top-level names to jauth.egg-info/top_level.txt</span><br><span class="line">writing manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">reading manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">writing manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">installing library code to build/bdist.linux-x86_64/egg</span><br><span class="line">running install_lib</span><br><span class="line">running build_py</span><br><span class="line">creating build</span><br><span class="line">creating build/lib</span><br><span class="line">creating build/lib/jauth</span><br><span class="line">copying jauth/__init__.py -&gt; build/lib/jauth</span><br><span class="line">copying jauth/jauth.py -&gt; build/lib/jauth</span><br><span class="line">creating build/bdist.linux-x86_64</span><br><span class="line">creating build/bdist.linux-x86_64/egg</span><br><span class="line">creating build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">copying build/lib/jauth/__init__.py -&gt; build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">copying build/lib/jauth/jauth.py -&gt; build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">byte-compiling build/bdist.linux-x86_64/egg/jauth/__init__.py to __init__.cpython-36.pyc</span><br><span class="line">byte-compiling build/bdist.linux-x86_64/egg/jauth/jauth.py to jauth.cpython-36.pyc</span><br><span class="line">creating build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/PKG-INFO -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/SOURCES.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/dependency_links.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/top_level.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">zip_safe flag not set; analyzing archive contents...</span><br><span class="line">creating dist</span><br><span class="line">creating &#x27;dist/jauth-1.0-py3.6.egg&#x27; and adding &#x27;build/bdist.linux-x86_64/egg&#x27; to it</span><br><span class="line">removing &#x27;build/bdist.linux-x86_64/egg&#x27; (and everything under it)</span><br><span class="line">Processing jauth-1.0-py3.6.egg</span><br><span class="line">Copying jauth-1.0-py3.6.egg to /usr/local/lib/python3.6/dist-packages</span><br><span class="line">Adding jauth 1.0 to easy-install.pth file</span><br><span class="line"></span><br><span class="line">Installed /usr/local/lib/python3.6/dist-packages/jauth-1.0-py3.6.egg</span><br><span class="line">Processing dependencies for jauth==1.0</span><br><span class="line">Finished processing dependencies for jauth==1.0</span><br></pre></td></tr></table></figure>

<p>安装完成会生成一些文件，最后能在<code>/usr/local/lib/python3.6/dist-packages</code>下面找到。</p>
<h2 id="配置自己的认证器类"><a href="#配置自己的认证器类" class="headerlink" title="配置自己的认证器类"></a>配置自己的认证器类</h2><p>下面是所有配置：</p>
<p>jc_auth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置认证器类</span></span><br><span class="line"><span class="keyword">from</span> jauth <span class="keyword">import</span> JimoAuth</span><br><span class="line">c.JupyterHub.authenticator_class = JimoAuth</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ jupyterhub -f jc_auth.py</span><br></pre></td></tr></table></figure>

<p>可以看看登录失败和成功的日志：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;jupyterhub.handlers.login.LoginHandler <span class="built_in">object</span> at <span class="number">0x7f421a5b10b8</span>&gt;</span><br><span class="line">&#123;<span class="string">&#x27;next&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;jjjj&#x27;</span>&#125;</span><br><span class="line">[W <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">31.841</span> JupyterHub base:<span class="number">670</span>] Failed login <span class="keyword">for</span> jj</span><br><span class="line">[I <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">31.841</span> JupyterHub log:<span class="number">174</span>] <span class="number">200</span> POST /hub/login?<span class="built_in">next</span>= (@::<span class="number">1</span>) <span class="number">1.61</span>ms</span><br><span class="line">&lt;jupyterhub.handlers.login.LoginHandler <span class="built_in">object</span> at <span class="number">0x7f421ae15208</span>&gt;</span><br><span class="line">&#123;<span class="string">&#x27;next&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>&#125;</span><br><span class="line">[I <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">48.058</span> JupyterHub base:<span class="number">663</span>] User logged <span class="keyword">in</span>: jj</span><br></pre></td></tr></table></figure>

<p>最后docker也运行成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                       NAMES</span><br><span class="line">d3f65881f6c2        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   11 minutes ago      Up 11 minutes       127.0.0.1:32775-&gt;8888/tcp   jupyter-jj</span><br></pre></td></tr></table></figure>

<h1 id="使用JWT验证"><a href="#使用JWT验证" class="headerlink" title="使用JWT验证"></a>使用JWT验证</h1><p>JWT也是官方的一种验证方式：<a target="_blank" rel="noopener" href="https://github.com/mogthesprog/jwtauthenticator">https://github.com/mogthesprog/jwtauthenticator</a></p>
<p>安装完成后，下面是配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jwtauthenticator.jwtauthenticator.JSONWebTokenAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.secret = <span class="string">&#x27;jimo&#x27;</span>            <span class="comment"># The secrect key used to generate the given token</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.username_claim_field = <span class="string">&#x27;username&#x27;</span>                           <span class="comment"># The claim field contianing the username/sAMAccountNAme/userPrincipalName</span></span><br><span class="line">c.JSONWebTokenAuthenticator.expected_audience = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>secret是JWT的秘钥</li>
<li>username_claim_field是JWT里自定定义的用户名的key</li>
</ul>
<p>启动服务后，使用postman验证下：</p>
<p>在header里增加一个Authorization:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ</span><br></pre></td></tr></table></figure>

<p>这个token可以去官方网站生成一个做测试：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a>:</p>
<ul>
<li>填入secret</li>
<li>修改payload，增加<code>username: jimo</code></li>
</ul>
<p>POSTMAN可以成功，但是我们需要在web界面做到，于是随便一个网站，增加带JWT header的请求会出现跨域问题，比如，我写了一个简单的web界面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-sso-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>open jupyterhub<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;http://localhost:8000/hub/login&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title class_">Authorization</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">da</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(da)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS http://localhost:8000/hub/login 405 (Method Not Allowed)</span><br><span class="line">Access to XMLHttpRequest at &#x27;http://localhost:8000/hub/login&#x27; from origin &#x27;null&#x27; has been blocked by CORS policy: Response to preflight request doesn&#x27;t pass access control check: It does not have HTTP ok status.</span><br></pre></td></tr></table></figure>

<p>我尝试过关闭jupyterhub的跨域，然而没有成功。那就只剩下一条路：把他们放在同一个域下。</p>
<p>我使用nginx来做代理，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location ~/(hub|user) &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理到8080端口，包括前端页面和jupyterhub服务器，这里有个问题：就是所有的jupyterhub开头的URI都不能再被我们的应用使用了。</p>
<p>接着可以登录，也可以生成notebook，也能打开，但是连不上websocket：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebSocket connection to &#x27;ws://localhost:8080/user/jimo/api/kernels/750982b7-7696-4f88-9829-79e98c5f9932/channels?session_id=9db4d742f14940c88e643f3eddfa1de4&#x27; failed: Error during WebSocket handshake: Unexpected response code: 504</span><br></pre></td></tr></table></figure>

<p>增加下面的配置可以解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">   default upgrade;</span><br><span class="line">   &#x27;&#x27;      close;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> server &#123;</span><br><span class="line"></span><br><span class="line">   location ~/(hub|user) &#123;</span><br><span class="line"></span><br><span class="line">     proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">     proxy_set_header Connection $connection_upgrade;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以正常写代码运行了，但是有几个API访问是403的，比如：</p>
<ul>
<li>停止服务</li>
<li>请求Token</li>
</ul>
<p>查看后台日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[W 2019-09-22 09:56:43.145 JupyterHub base:60] Blocking Cross Origin API request.  Referer: http://localhost:8080/hub/token, Host: localhost/hub/</span><br><span class="line">[E 2019-09-22 09:56:43.145 JupyterHub users:273] Error authenticating request for /hub/api/users/jimo/tokens: </span><br><span class="line">[W 2019-09-22 09:56:43.146 JupyterHub log:174] 403 POST /hub/api/users/jimo/tokens (@127.0.0.1) 7.12ms</span><br><span class="line"></span><br><span class="line">[W 2019-09-22 09:59:30.636 JupyterHub base:60] Blocking Cross Origin API request.  Referer: http://localhost:8080/hub/home, Host: localhost/hub/</span><br><span class="line">[W 2019-09-22 09:59:30.637 JupyterHub log:174] 403 DELETE /hub/api/users/jimo/server (@127.0.0.1) 10.50ms</span><br></pre></td></tr></table></figure>

<p>看来还是跨域的问题导致的认证失败。</p>
<p>这个问题可以这样解决：（目前没找到更好的方法）：使用80端口，这样jupyterhub就认为是一个域了。</p>
<h2 id="更近一步"><a href="#更近一步" class="headerlink" title="更近一步"></a>更近一步</h2><p>上面的nginx配置依然有问题，因为在集成到我们的应用时，不可能把<code>user, hub</code>等URI剔除，即便可以，也不友好，因此需要给jupyterhub自定义一个前缀URI，这里使用notebook：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.base_url = <span class="string">u&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>相应的nginx配置也得改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">        index index.html;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /notebook &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在关于jupyterhub的一切都在<code>/notebook/</code>下了。</p>
<p>然而，新的问题又来了：docker容器里请求jupyterhub 的API的路径也变了，而docker配置未修改，于是访问时就会出现404：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[E 2019-09-22 03:31:03.980 SingleUserNotebookApp web:2991] Could not open static file &#x27;&#x27;</span><br><span class="line">[W 2019-09-22 03:31:03.981 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/notebook? (@127.0.0.1) 26.89ms</span><br><span class="line">[W 2019-09-22 03:31:04.027 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/static/components/react/react-dom.production.min.js (@127.0.0.1) 3.69ms</span><br><span class="line">[W 2019-09-22 03:31:04.067 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/static/components/react/react-dom.production.min.js (@127.0.0.1) 1.60ms</span><br></pre></td></tr></table></figure>
<p>map $http_upgrade $connection_upgrade {<br>  default upgrade;<br>  ‘’      close;<br>}</p>
<p>于是，继续修改配置，修改docker里访问API的路径，加个前缀：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.hub_prefix = <span class="string">&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后记得删除旧的docker实例，再重新生成就ok了。</p>
<h2 id="完整配置-1"><a href="#完整配置-1" class="headerlink" title="完整配置"></a>完整配置</h2><p>jc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jwtauthenticator.jwtauthenticator.JSONWebTokenAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.secret = <span class="string">&#x27;jimo&#x27;</span>            <span class="comment"># The secrect key used to generate the given token</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.username_claim_field = <span class="string">&#x27;username&#x27;</span>                           <span class="comment"># The claim field contianing the username/sAMAccountNAme/userPrincipalName</span></span><br><span class="line">c.JSONWebTokenAuthenticator.expected_audience = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">origin=<span class="string">&#x27;*&#x27;</span></span><br><span class="line">c.Spawner.args = [<span class="string">f&#x27;--NotebookApp.allow_origin=<span class="subst">&#123;origin&#125;</span>&#x27;</span>]</span><br><span class="line">c.JupyterHub.tornado_settings = &#123;</span><br><span class="line">    <span class="string">&#x27;headers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: origin,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.Authenticator.admin_users = &#123;<span class="string">&#x27;jimo&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">c.JupyterHub.base_url = <span class="string">u&#x27;/notebook&#x27;</span></span><br><span class="line"></span><br><span class="line">c.DockerSpawner.hub_prefix = <span class="string">&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>nginx的 hub.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">  default upgrade;</span><br><span class="line">  &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">        index index.html;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /notebook &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-sso-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>The Great Jupyterhub In Just<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>open jupyterhub<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;/notebook/hub/login&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title class_">Authorization</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">da</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(da)</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;/notebook/hub/home&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="读取cookie认证"><a href="#读取cookie认证" class="headerlink" title="读取cookie认证"></a>读取cookie认证</h1><p>要让jupyterhub读取我们应用的cookie，他们必须处于同一个域下，可以是一个子域名。</p>
<p>经过测试，是可以读取到cookie的，于是怎么验证就是个问题了。</p>
<h1 id="自定义界面"><a href="#自定义界面" class="headerlink" title="自定义界面"></a>自定义界面</h1><p>juopyterhub提供了自定义界面的方式：<a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/templates.html">https://jupyterhub.readthedocs.io/en/stable/reference/templates.html</a></p>
<p>我们只需要遵循以下步骤：</p>
<ol>
<li>选择自定义页面路径: 我选的<code>/home/jimo/jwt_auth/pages</code></li>
<li>修改hub配置，指定自定义路径： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.template_paths=[<span class="string">&#x27;/home/jimo/jwt_auth/pages&#x27;</span>]</span><br></pre></td></tr></table></figure></li>
<li>参考<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/share/jupyterhub/templates">源码页面</a>，修改为自己想要的样子</li>
</ol>
<p>一般我们修改页面只是做一些logo、汉化等。</p>
<p>比如：截断很长的用户名，使用<a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.10.x/templates/#truncate">jinja的过滤器语法的truncate方法</a>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;navbar-text&quot;</span>&gt;</span>&#123;&#123;user.name | truncate(length=5)&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h1 id="自定义notebook镜像"><a href="#自定义notebook镜像" class="headerlink" title="自定义notebook镜像"></a>自定义notebook镜像</h1><h2 id="明白原生镜像"><a href="#明白原生镜像" class="headerlink" title="明白原生镜像"></a>明白原生镜像</h2><p>原生镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/jupyterhub/singleuser/dockerfile">https://hub.docker.com/r/jupyterhub/singleuser/dockerfile</a></p>
<p>查看其dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Build as jupyterhub/singleuser</span><br><span class="line"># Run with the DockerSpawner in JupyterHub</span><br><span class="line"></span><br><span class="line">ARG BASE_IMAGE=jupyter/base-notebook</span><br><span class="line">FROM $BASE_IMAGE</span><br><span class="line">MAINTAINER Project Jupyter &lt;jupyter@googlegroups.com&gt;</span><br><span class="line"></span><br><span class="line">ADD install_jupyterhub /tmp/install_jupyterhub</span><br><span class="line">ARG JUPYTERHUB_VERSION=master</span><br><span class="line"># install pinned jupyterhub and ensure notebook is installed</span><br><span class="line">RUN python3 /tmp/install_jupyterhub &amp;&amp; \</span><br><span class="line">    python3 -m pip install notebook</span><br></pre></td></tr></table></figure>

<h3 id="base镜像"><a href="#base镜像" class="headerlink" title="base镜像"></a>base镜像</h3><p>首先找到其base镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/jupyter/base-notebook/dockerfile">jupyter&#x2F;base-notebook </a></p>
<p>里面主要做的就是打包jupyter的notebook，暂时不研究。</p>
<p>注意：其使用conda安装python的。</p>
<h3 id="install-jupyterhub"><a href="#install-jupyterhub" class="headerlink" title="install_jupyterhub"></a>install_jupyterhub</h3><p>显然，这是一个本地文件，我们找到github上的源码：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/singleuser">https://github.com/jupyterhub/jupyterhub/tree/master/singleuser</a></p>
<p>install_jupyterhub是一个没有后缀的python文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_call</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">V = os.environ[<span class="string">&#x27;JUPYTERHUB_VERSION&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pip_install = [</span><br><span class="line">    sys.executable, <span class="string">&#x27;-m&#x27;</span>, <span class="string">&#x27;pip&#x27;</span>, <span class="string">&#x27;install&#x27;</span>, <span class="string">&#x27;--no-cache&#x27;</span>, <span class="string">&#x27;--upgrade&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;--upgrade-strategy&#x27;</span>, <span class="string">&#x27;only-if-needed&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="keyword">if</span> V == <span class="string">&#x27;master&#x27;</span>:</span><br><span class="line">    req = <span class="string">&#x27;https://github.com/jupyterhub/jupyterhub/archive/master.tar.gz&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    version_info = [ <span class="built_in">int</span>(part) <span class="keyword">for</span> part <span class="keyword">in</span> V.split(<span class="string">&#x27;.&#x27;</span>) ]</span><br><span class="line">    version_info[-<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    upper_bound = <span class="string">&#x27;.&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, version_info))</span><br><span class="line">    vs = <span class="string">&#x27;&gt;=%s,&lt;%s&#x27;</span> % (V, upper_bound)</span><br><span class="line">    req = <span class="string">&#x27;jupyterhub%s&#x27;</span> % vs</span><br><span class="line"></span><br><span class="line">check_call(pip_install + [req])</span><br></pre></td></tr></table></figure>

<p>脚本很好懂，就是从github下载源码安装，所以不需要关心这一步。</p>
<h2 id="修改镜像"><a href="#修改镜像" class="headerlink" title="修改镜像"></a>修改镜像</h2><p>根据我们的需求修改：</p>
<ul>
<li>安装相应的包</li>
<li>修改内核代码</li>
</ul>
<p>由于咱们需要更改python内核代码增加一些magic函数，所以需要修改docker镜像里的python代码。</p>
<p>找到python对应的版本：看起来都是用的python3.7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/conda/bin$</span><br><span class="line">lrwxrwxrwx 1 jovyan users        9 Aug  3 03:26 python -&gt; python3.7*</span><br><span class="line">lrwxrwxrwx 1 jovyan users        9 Aug  3 03:26 python3 -&gt; python3.7*</span><br></pre></td></tr></table></figure>

<p>确定我们要改的包的路径：<code>/opt/conda/lib/python3.7/site-packages/IPython</code></p>
<p>由于修改镜像涉及到保密信息，大家根据自己情况修改，确保最后build成功。</p>
<h2 id="指定自己的镜像"><a href="#指定自己的镜像" class="headerlink" title="指定自己的镜像"></a>指定自己的镜像</h2><p>修改hub的配置，指向我们自己的镜像：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.image = <span class="string">&#x27;test/docker-notebook:v2&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>使用docker的一个点是：数据默认是存在docker里的，用于生产时肯定需要持久化到外部存储里。</p>
<p>目前没有云存储，暂时映射到本机上的一个目录：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.volumes = &#123;<span class="string">&#x27;/mnt/docker/data/hub-data-&#123;username&#125;&#x27;</span>:<span class="string">&#x27;/home/jovyan&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>前面是本机目录，后面是容器内用户的工作空间。</p>
<p><strong>非常重要：确保docker对本机目录有读写权限，最简单的做法：chmod 777 -R &#x2F;mnt&#x2F;docker&#x2F;data</strong></p>
<p>否则会出现权限问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  File <span class="string">&quot;/opt/conda/lib/python3.7/os.py&quot;</span>, line <span class="number">221</span>, <span class="keyword">in</span> makedirs</span><br><span class="line">    mkdir(name, mode)</span><br><span class="line">PermissionError: [Errno <span class="number">13</span>] Permission denied: <span class="string">&#x27;/home/jovyan/.local&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Permission-denied-‘-x2F-home-x2F-jovyan-x2F-local’"><a href="#Permission-denied-‘-x2F-home-x2F-jovyan-x2F-local’" class="headerlink" title="Permission denied: ‘&#x2F;home&#x2F;jovyan&#x2F;.local’"></a>Permission denied: ‘&#x2F;home&#x2F;jovyan&#x2F;.local’</h2><p>然而，上述做法是需要手动操作的，就是新增的用户没办法在宿主机上创建文件，因为没有写的权限。</p>
<p>关于这个问题，可以在<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/issues/160">github issue</a>里找到：</p>
<blockquote>
<p>这是一个常见的Docker问题，在创建docker实例时挂在外部不存在的目录卷时。 这是Docker的一个长期困扰 使用容器内部卷时就不是问题，这就是为什么要偏向使用它的部分原因。</p>
</blockquote>
<p>既然是docker的问题，那么就只有走偏方了：能不能在启动容器前就把外部目录的权限分配好？</p>
<p>还真可以，而且是官方操作：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/examples/bootstrap-script">bootstrap-script</a></p>
<p>启动脚本：可以在启动notebook实例前干一些事情，想干什么范围就很广了。</p>
<p>比如，我们创建目录并分配权限：在jupyterhub_config.py里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_dir_hook</span>(<span class="params">spawner</span>):</span><br><span class="line">    username = spawner.user.name <span class="comment"># get the username</span></span><br><span class="line">    volume_path = os.path.join(<span class="string">&#x27;/home/jimo/jwt_auth&#x27;</span>, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(volume_path):</span><br><span class="line">        <span class="comment"># create a directory with umask 0777</span></span><br><span class="line">        <span class="comment"># hub and container user must have the same UID to be writeable</span></span><br><span class="line">        <span class="comment"># still readable by other users on the system</span></span><br><span class="line">        os.mkdir(volume_path, <span class="number">0o777</span>)</span><br><span class="line">        <span class="comment"># now do whatever you think your user needs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># attach the hook function to the spawner</span></span><br><span class="line">c.Spawner.pre_spawn_hook = create_dir_hook</span><br></pre></td></tr></table></figure>

<h2 id="关于docker网络"><a href="#关于docker网络" class="headerlink" title="关于docker网络"></a>关于docker网络</h2><p>集成了自己的东西到notebook里，notebook又在docker里，而自己的东西需要与外部网络通信。</p>
<h2 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.Spawner.mem_limit = <span class="string">&#x27;500M&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h2><h3 id="离线打包python环境"><a href="#离线打包python环境" class="headerlink" title="离线打包python环境"></a>离线打包python环境</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/vevenlcf/article/details/83110204">https://blog.csdn.net/vevenlcf/article/details/83110204</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3.7 -m pip freeze &gt; hub_req.txt</span><br><span class="line"></span><br><span class="line">python3.7 -m pip download -r hub_req.txt -d ./pkgs/</span><br><span class="line"></span><br><span class="line">tar -czf pkgs.tar.gz pkgs/</span><br></pre></td></tr></table></figure>

<h3 id="离线打包docker镜像"><a href="#离线打包docker镜像" class="headerlink" title="离线打包docker镜像"></a>离线打包docker镜像</h3><p>打包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker save -o just-docker-notebook.tar just/docker-notebook:v2</span><br><span class="line"># 再压缩下</span><br><span class="line">tar -czf just-docker-notebook.tar.gz just-docker-notebook.tar</span><br></pre></td></tr></table></figure>

<p>导入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; just-docker-notebook.tar</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h1 id="释放不活动用户资源"><a href="#释放不活动用户资源" class="headerlink" title="释放不活动用户资源"></a>释放不活动用户资源</h1><p>按照默认情况，用户启动之后，notebook的docker容器会一直运行，这样其实很占资源，对于不活动用户的资源，需要在一定时间后清理。</p>
<p>我们通过增加一个服务：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/examples/cull-idle">https://github.com/jupyterhub/jupyterhub/tree/master/examples/cull-idle</a></p>
<ol>
<li>把项目中的cull_idle_servers.py脚本弄下来</li>
<li>在配置文件中配置服务：这里是3600秒 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.services = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cull-idle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;admin&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;command&#x27;</span>: [sys.executable, <span class="string">&#x27;cull_idle_servers.py&#x27;</span>, <span class="string">&#x27;--timeout=3600&#x27;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
</ol>
<p>其实这个cull_idle_servers.py是通过轮询的方式来做的，自己也可以写一个。</p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>使用环境：</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/" data-id="cl1fw7fn900i6vkd30v0a21ts" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/jupyterhub/" rel="tag">jupyterhub</a><span class="article-tag-list-count">2</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/notebook/" rel="tag">notebook</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/oauth/" rel="tag">oauth</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a><span class="article-tag-list-count">13</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-life/032-weekly-learn" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/17/life/032-weekly-learn/" class="article-date">
  <time datetime="2019-09-17T12:07:02.000Z" itemprop="datePublished">2019-09-17</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/17/life/032-weekly-learn/">2019-38-周报</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>这是2019年第38周周报.</p>
<ol>
<li><a href="/2019/09/17/java/069-java-read-file-by-line/" title="java按行读取文件">java按行读取文件</a></li>
</ol>
<p>redis 管道写入数据</p>
<p>kerberos理解</p>
<p>LDAP 研究：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000014683418?utm_source=tag-newest">https://segmentfault.com/a/1190000014683418?utm_source=tag-newest</a></p>
<p>OAuth2.0原理和实践：</p>
<p>java bio nio</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/anxpp/article/details/51512200">https://blog.csdn.net/anxpp/article/details/51512200</a></p>
<p>java-nio: <a target="_blank" rel="noopener" href="http://tutorials.jenkov.com/java-nio/index.html">http://tutorials.jenkov.com/java-nio/index.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/java_nio/">https://www.tutorialspoint.com/java_nio/</a></p>
<p>翻译RFC：<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc7231#section-4.3.3">https://tools.ietf.org/html/rfc7231#section-4.3.3</a></p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>这是2019年第38周周报.</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/17/life/032-weekly-learn/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/17/life/032-weekly-learn/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/17/life/032-weekly-learn/" data-id="cl1fw7fkh0082vkd3d0p115v2" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/069-java-read-file-by-line" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/17/java/069-java-read-file-by-line/" class="article-date">
  <time datetime="2019-09-17T12:03:26.000Z" itemprop="datePublished">2019-09-17</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/17/java/069-java-read-file-by-line/">java按行读取文件</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文记录java按行读取文件的方式。</p>
<h1 id="FileReader-BufferedReader"><a href="#FileReader-BufferedReader" class="headerlink" title="FileReader+BufferedReader"></a>FileReader+BufferedReader</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>  List&lt;String&gt; <span class="title function_">getFromFile</span><span class="params">(String path)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">FileReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileReader</span>(path);</span><br><span class="line">    <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(reader);</span><br><span class="line">    List&lt;String&gt; data = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">    String line;</span><br><span class="line">    <span class="keyword">while</span> ((line = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        data.add(line);</span><br><span class="line">    &#125;</span><br><span class="line">    br.close();</span><br><span class="line">    reader.close();</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文记录java按行读取文件的方式。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/17/java/069-java-read-file-by-line/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/17/java/069-java-read-file-by-line/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/17/java/069-java-read-file-by-line/" data-id="cl1fw7flv00czvkd3daq7gidx" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/068-java-boundedpriorityqueue" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/16/java/068-java-boundedpriorityqueue/" class="article-date">
  <time datetime="2019-09-16T12:05:57.000Z" itemprop="datePublished">2019-09-16</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/16/java/068-java-boundedpriorityqueue/">Java实现有界优先队列</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文依据<code>PriorityQueue</code>实现有界的优先队列。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 有界优先队列&lt;br&gt;</span></span><br><span class="line"><span class="comment"> * 按照给定的排序规则，排序元素，当队列满时，按照给定的排序规则淘汰末尾元素（去除末尾元素）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> jimo</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/9/16 15:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BoundedPriorityQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">PriorityQueue</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 序列化唯一性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3794348988671694820L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 容量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义比较</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Comparator&lt;? <span class="built_in">super</span> E&gt; comparator;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BoundedPriorityQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(capacity, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 构造</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> capacity   容量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> comparator 比较器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BoundedPriorityQueue</span><span class="params">(<span class="type">int</span> capacity, <span class="keyword">final</span> Comparator&lt;? <span class="built_in">super</span> E&gt; comparator)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(capacity, (o1, o2) -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> cResult;</span><br><span class="line">            <span class="keyword">if</span> (comparator != <span class="literal">null</span>) &#123;</span><br><span class="line">                cResult = comparator.compare(o1, o2);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">                Comparable&lt;E&gt; o1c = (Comparable&lt;E&gt;) o1;</span><br><span class="line">                cResult = o1c.compareTo(o2);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> -cResult;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">        <span class="built_in">this</span>.comparator = comparator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加入元素，当队列满时，淘汰末尾元素</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e 元素</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 加入成功与否</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (size() &gt;= capacity) &#123;</span><br><span class="line">            <span class="type">E</span> <span class="variable">head</span> <span class="operator">=</span> peek();</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.comparator().compare(e, head) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//当队列满时，就要淘汰顶端队列</span></span><br><span class="line">            poll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.offer(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加多个元素&lt;br&gt;</span></span><br><span class="line"><span class="comment">     * 参数为集合的情况请使用&#123;<span class="doctag">@link</span> PriorityQueue#addAll&#125;</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> c 元素数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否发生改变</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addAll</span><span class="params">(E[] c)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.addAll(Arrays.asList(c));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回排序后的列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ArrayList&lt;E&gt; <span class="title function_">toList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;E&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>);</span><br><span class="line">        list.sort(comparator);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> toList().iterator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文依据<code>PriorityQueue</code>实现有界的优先队列。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/16/java/068-java-boundedpriorityqueue/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/16/java/068-java-boundedpriorityqueue/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/16/java/068-java-boundedpriorityqueue/" data-id="cl1fw7flu00cwvkd3d854eve3" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-linux/032-ubuntu-ufw" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/15/linux/032-ubuntu-ufw/" class="article-date">
  <time datetime="2019-09-15T01:43:02.000Z" itemprop="datePublished">2019-09-15</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/15/linux/032-ubuntu-ufw/">ubuntu防火墙</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文记录下ubuntu的防火墙命令：<code>ufw</code>.</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>UFW 全称为 Uncomplicated Firewall.</p>
<p>是 Ubuntu 系统上默认的防火墙组件, 为了轻量化配置 iptables 而开发的一款工具</p>
<h1 id="状态"><a href="#状态" class="headerlink" title="状态"></a>状态</h1><p>默认不活动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status</span><br><span class="line">[sudo] jack 的密码： </span><br><span class="line">状态：不活动</span><br></pre></td></tr></table></figure>
<p>开启防火墙：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw enable</span><br><span class="line">在系统启动时启用和激活防火墙</span><br></pre></td></tr></table></figure>

<h1 id="开放端口"><a href="#开放端口" class="headerlink" title="开放端口"></a>开放端口</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw allow 22</span><br><span class="line">规则已添加</span><br><span class="line">规则已添加 (v6)</span><br></pre></td></tr></table></figure>
<p>查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status</span><br><span class="line">状态： 激活</span><br><span class="line"></span><br><span class="line">至                          动作          来自</span><br><span class="line">-                          --          --</span><br><span class="line">22                         ALLOW       Anywhere                  </span><br><span class="line">22 (v6)                    ALLOW       Anywhere (v6) </span><br></pre></td></tr></table></figure>

<h1 id="其所有用法"><a href="#其所有用法" class="headerlink" title="其所有用法"></a>其所有用法</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw -h</span><br><span class="line">ERROR: Invalid syntax</span><br><span class="line"></span><br><span class="line">Usage: ufw COMMAND</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line"> enable                          enables the firewall</span><br><span class="line"> disable                         disables the firewall</span><br><span class="line"> default ARG                     set default policy</span><br><span class="line"> logging LEVEL                   set logging to LEVEL</span><br><span class="line"> allow ARGS                      add allow rule</span><br><span class="line"> deny ARGS                       add deny rule</span><br><span class="line"> reject ARGS                     add reject rule</span><br><span class="line"> limit ARGS                      add limit rule</span><br><span class="line"> delete RULE|NUM                 delete RULE</span><br><span class="line"> insert NUM RULE                 insert RULE at NUM</span><br><span class="line"> route RULE                      add route RULE</span><br><span class="line"> route delete RULE|NUM           delete route RULE</span><br><span class="line"> route insert NUM RULE           insert route RULE at NUM</span><br><span class="line"> reload                          reload firewall</span><br><span class="line"> reset                           reset firewall</span><br><span class="line"> status                          show firewall status</span><br><span class="line"> status numbered                 show firewall status as numbered list of RULES</span><br><span class="line"> status verbose                  show verbose firewall status</span><br><span class="line"> show ARG                        show firewall report</span><br><span class="line"> version                         display version information</span><br><span class="line"></span><br><span class="line">Application profile commands:</span><br><span class="line"> app list                        list application profiles</span><br><span class="line"> app info PROFILE                show information on PROFILE</span><br><span class="line"> app update PROFILE              update PROFILE</span><br><span class="line"> app default ARG                 set default application policy</span><br></pre></td></tr></table></figure>

<p>关于这个ARGS，不知道其英文单词，但意义是一系列规则：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># 允许SSH的22端口的传入和传出连接</span><br><span class="line">$ sudo ufw allow ssh</span><br><span class="line">$ sudo ufw allow 22</span><br><span class="line"></span><br><span class="line"># 特定端口上deny流量</span><br><span class="line">$ sudo ufw deny 111</span><br><span class="line"></span><br><span class="line"># 也可以允许基于TCP或者UDP的包</span><br><span class="line">$ sudo ufw allow 80/tcp</span><br><span class="line">$ sudo ufw allow http/tcp</span><br><span class="line">$ sudo ufw allow 1725/udp</span><br><span class="line"></span><br><span class="line"># 允许从一个IP地址连接</span><br><span class="line">$ sudo ufw allow from 123.45.67.89</span><br><span class="line"></span><br><span class="line"># 允许特定子网的连接</span><br><span class="line">$ sudo ufw allow from 123.45.67.89/24</span><br><span class="line"></span><br><span class="line"># 允许特定IP/端口的组合</span><br><span class="line">$ sudo ufw allow from 123.45.67.89 to any port 22 proto tcp</span><br><span class="line">$ sudo ufw allow from 123.45.67.89 to any port 22 proto udp</span><br></pre></td></tr></table></figure>



      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文记录下ubuntu的防火墙命令：<code>ufw</code>.</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/15/linux/032-ubuntu-ufw/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/15/linux/032-ubuntu-ufw/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/15/linux/032-ubuntu-ufw/" data-id="cl1fw7fmv00glvkd33pwbd0z0" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/linux/" rel="tag">linux</a><span class="article-tag-list-count">57</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a><span class="article-tag-list-count">13</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-linux/031-ubuntu-ssh-connection-refuesd" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/15/linux/031-ubuntu-ssh-connection-refuesd/" class="article-date">
  <time datetime="2019-09-15T00:37:03.000Z" itemprop="datePublished">2019-09-15</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/15/linux/031-ubuntu-ssh-connection-refuesd/">ubuntu localhost:ssh:connect to host localhost port 22:Connection refused</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>localhost: ssh: connect to host localhost port 22: Connection refused.</p>
<ol>
<li>安装openssh-server：</li>
</ol>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install openssh-server  </span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启动sshd服务  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo service start sshd  </span><br></pre></td></tr></table></figure></li>
<li>关闭防火墙，或允许防火墙开放22端口  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 关闭</span><br><span class="line">$ sudo ufw disable</span><br><span class="line"></span><br><span class="line"># 允许开放22端口</span><br><span class="line">$ sudo ufw allow 22</span><br></pre></td></tr></table></figure></li>
<li>检查：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ssh localhost</span><br><span class="line">The authenticity of host &#x27;localhost (127.0.0.1)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:QjfgDMQrMms2YyootfWGBh5rFOWAgTxRHxDyRedmTTg.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &#x27;localhost&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">jack@localhost&#x27;s password: </span><br></pre></td></tr></table></figure></li>
</ol>
<p>可以看到，我连自己的机器还需要输入密码，显然不友好，使用ssh-key解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 1.生成ssh key</span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"></span><br><span class="line"># 2.copy到本机</span><br><span class="line">ssh-copy-id localhost</span><br></pre></td></tr></table></figure>


      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>localhost: ssh: connect to host localhost port 22: Connection refused.</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/15/linux/031-ubuntu-ssh-connection-refuesd/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/15/linux/031-ubuntu-ssh-connection-refuesd/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/15/linux/031-ubuntu-ssh-connection-refuesd/" data-id="cl1fw7fmu00givkd3ax0pd79o" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/linux/" rel="tag">linux</a><span class="article-tag-list-count">57</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a><span class="article-tag-list-count">13</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-spark/008-spark-standalone-conf-run" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/15/spark/008-spark-standalone-conf-run/" class="article-date">
  <time datetime="2019-09-15T00:11:01.000Z" itemprop="datePublished">2019-09-15</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/15/spark/008-spark-standalone-conf-run/">spark standalone模式的配置与运行</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>上一篇：<a href="/2019/09/14/spark/007-spark-data-flow/" title="spark运行流程">spark运行流程</a></p>
<h1 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h1><ol>
<li>从模板解析出配置来：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">conf$ cp spark-defaults.conf.template spark-defaults.conf</span><br><span class="line">conf$ cp spark-env.sh.template spark-env.sh</span><br><span class="line">cp slaves.template slaves</span><br></pre></td></tr></table></figure></li>
<li>修改slaves配置，增加worker节点：我这里只有本机，就是localhost  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">conf$ cat slaves</span><br><span class="line">localhost</span><br><span class="line"># worker1</span><br><span class="line"># worker2</span><br></pre></td></tr></table></figure></li>
<li>修改spark-env.sh设置master：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">43 # Options for the daemons used in the standalone deploy mode</span><br><span class="line">44 # - SPARK_MASTER_HOST, to bind the master to a different IP address or hostname</span><br><span class="line">45 # - SPARK_MASTER_PORT / SPARK_MASTER_WEBUI_PORT, to use non-default ports for the master</span><br><span class="line">46 SPARK_MASTER_HOST=localhost</span><br><span class="line">47 SPARK_MASTER_PORT=7077</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h1><p>当我调用<code>start-all.sh</code>时，发现了ssh连接错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sbin/start-all.sh </span><br><span class="line">starting org.apache.spark.deploy.master.Master, logging to /home/jack/workspace/spark/spark-2.4.4-bin-hadoop2.7/logs/spark-jack-org.apache.spark.deploy.master.Master-1-jack.out</span><br><span class="line">localhost: ssh: connect to host localhost port 22: Connection refused</span><br></pre></td></tr></table></figure>
<p>这个解决办法参看：<a href="/2019/09/15/linux/031-ubuntu-ssh-connection-refuesd/" title="ubuntu localhost:ssh:connect to host localhost port 22:Connection refused">ubuntu localhost:ssh:connect to host localhost port 22:Connection refused</a></p>
<p>另外的启动方式：单个启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./start-master.sh </span><br><span class="line">org.apache.spark.deploy.master.Master running as process 12891.  Stop it first.</span><br><span class="line"></span><br><span class="line">$ ./start-slave.sh spark://localhost:7077</span><br></pre></td></tr></table></figure>

<p>我还是修改完ssh来启动：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sbin/start-all.sh </span><br><span class="line">starting org.apache.spark.deploy.master.Master, logging to /home/jack/workspace/spark/spark-2.4.4-bin-hadoop2.7/logs/</span><br><span class="line">spark-jack-org.apache.spark.deploy.master.Master-1-jack.out</span><br><span class="line">localhost: starting org.apache.spark.deploy.worker.Worker, logging to /home/jack/workspace/spark/spark-2.4.4-bin-hadoop2.7/logs/</span><br><span class="line">spark-jack-org.apache.spark.deploy.worker.Worker-1-jack.out</span><br></pre></td></tr></table></figure>

<p>检查启动结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ jps</span><br><span class="line">23479 Worker</span><br><span class="line">23304 Master</span><br><span class="line">23851 Jps</span><br></pre></td></tr></table></figure>

<h1 id="运行Pi示例"><a href="#运行Pi示例" class="headerlink" title="运行Pi示例"></a>运行Pi示例</h1><p>比之前local模式多了个<code>--master spark://localhost:7077</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spark-submit \</span><br><span class="line"> --class org.apache.spark.examples.SparkPi \</span><br><span class="line"> --master spark://localhost:7077 \</span><br><span class="line"> --executor-memory 1G \</span><br><span class="line"> --total-executor-cores 2 \</span><br><span class="line"> ./examples/jars/spark-examples_2.11-2.4.4.jar \</span><br><span class="line"> 100</span><br></pre></td></tr></table></figure>

<p>结果都差不多，但是我们有一个界面，运行在8080端口，可以查看结果：</p>
<img src="/2019/09/15/spark/008-spark-standalone-conf-run/000.png" class="">

<h1 id="通过spark-shell提交任务"><a href="#通过spark-shell提交任务" class="headerlink" title="通过spark-shell提交任务"></a>通过spark-shell提交任务</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spark-shell --master spark://localhost:7077</span><br></pre></td></tr></table></figure>
<p>这时候我们看一下进程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ jps</span><br><span class="line">27680 CoarseGrainedExecutorBackend</span><br><span class="line">27571 SparkSubmit</span><br><span class="line">28212 Jps</span><br><span class="line">23479 Worker</span><br><span class="line">23304 Master</span><br></pre></td></tr></table></figure>
<p>会发现有一个<code>CoarseGrainedExecutorBackend</code>, 这个executorBackend的出现代表spark已经申请了资源，虽然还没执行任务，具体流程请参考：</p>
<a href="/2019/09/14/spark/007-spark-data-flow/" title="spark运行流程">spark运行流程</a>

<h1 id="模拟报错"><a href="#模拟报错" class="headerlink" title="模拟报错"></a>模拟报错</h1><p>给一个不存在的文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; sc.textFile(&quot;xxx&quot;).flatMap(_.split(&quot; &quot;)).map((_,1)).reduceByKey(_+_).collect</span><br><span class="line">org.apache.hadoop.mapred.InvalidInputException: Input path does not exist: file:/home/jack/workspace/spark/spark-2.4.4-bin-hadoop2.7/xxx</span><br></pre></td></tr></table></figure>

<p>下一篇：<a href="/2019/10/07/spark/009-spark-history-conf/" title="spark历史服务配置">spark历史服务配置</a></p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>上一篇：<a href="/2019/09/14/spark/007-spark-data-flow/" title="spark运行流程">spark运行流程</a></p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/15/spark/008-spark-standalone-conf-run/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/15/spark/008-spark-standalone-conf-run/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/15/spark/008-spark-standalone-conf-run/" data-id="cl1fw7fnq00jtvkd3a2p90c3e" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/spark/" rel="tag">spark</a><span class="article-tag-list-count">10</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-spark/007-spark-data-flow" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/14/spark/007-spark-data-flow/" class="article-date">
  <time datetime="2019-09-14T12:57:08.000Z" itemprop="datePublished">2019-09-14</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/14/spark/007-spark-data-flow/">spark运行流程</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>上一篇：<a href="/2019/09/14/spark/006-spark-config-wordcount/" title="spark：wordcount">spark：wordcount</a></p>
<h1 id="通用流程"><a href="#通用流程" class="headerlink" title="通用流程"></a>通用流程</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">       Unsaved       </span><br><span class="line">+---------+               +--------------+         4.反向注册</span><br><span class="line">|         |  1.任务提交    |              &lt;-----------------------+</span><br><span class="line">|  client +---------------&gt;   Driver     |                       |</span><br><span class="line">|         |               |              |                       |</span><br><span class="line">+---------+               | 初 始 化 sc   |                    +--+----------+</span><br><span class="line">                          | 任 务 划 分   |                    |             |</span><br><span class="line">                          | 任 务 调 度   |                    |   Executor  |</span><br><span class="line">                          +------+-------+                    |   执 行 任 务|</span><br><span class="line">                                 |                            |   textFile  |</span><br><span class="line">                                 |        +------------------&gt;+   flatMap   |</span><br><span class="line">                                 |        |  3.启动Executor    |   map       |</span><br><span class="line">                        2.注册应用|        |                    |             |</span><br><span class="line">                                 |        |                   +-------------+</span><br><span class="line">                                 |        |</span><br><span class="line">                                 |        |</span><br><span class="line">                          +------v--------+</span><br><span class="line">                          |               |                   +-------------+</span><br><span class="line">                          |  资 源 管 理 器 +-------------------&gt;             |</span><br><span class="line">                          |               |                   |  Executor   |</span><br><span class="line">                          +---------------+                   |             |</span><br><span class="line">                                                              +-------------+</span><br></pre></td></tr></table></figure>

<h1 id="standalone运行模式"><a href="#standalone运行模式" class="headerlink" title="standalone运行模式"></a>standalone运行模式</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">                             Driver</span><br><span class="line">                         +-------------------+                       +---------------------+</span><br><span class="line">                         |                   |       1.register      |                     |</span><br><span class="line">                         |    Client         +-----------------------&gt;                     |</span><br><span class="line">      +------------------&gt;                   |                       |                     |</span><br><span class="line">      |                  |  +-------------+  |                       |    Master           |</span><br><span class="line">      |                  |  |             |  |                       |                     |</span><br><span class="line">      |                  |  |  SparkContext  |      7.destroy        |                     |</span><br><span class="line">      |                  |  +-------------+  +-----------------------&gt;                     |</span><br><span class="line">      |                  +-^-----------------+                       +-+---------------^---+</span><br><span class="line">6.report task status       |           |                               |               |</span><br><span class="line">until finished             |           |                               |               |</span><br><span class="line">      |                    |           |                  2.apply      |               | 3.report the status</span><br><span class="line">      |                    |           |                   for         |               |</span><br><span class="line">      |               4.register       |                  resource     |               |</span><br><span class="line">      |                    |           |                  boot         |               |</span><br><span class="line">      |                    |           |                  ExecutorBackend              |</span><br><span class="line">      |                    |           |                               |               |</span><br><span class="line">      |                    |        5.distribute tasks                 |               |</span><br><span class="line">      |                    |           |                               |               |</span><br><span class="line">      |                    |           |                               |               |</span><br><span class="line">      |                    |           |                               |               |</span><br><span class="line">      |                 +--+-----------v-------+               +-------v---------------+------+</span><br><span class="line">      |                 |                      |               |                              |</span><br><span class="line">      +-----------------+      Worker          |               |        Worker                |</span><br><span class="line">                        |                      |               |                              |</span><br><span class="line">                        |  +-----------------+ |               | +------------+  +----------+ |</span><br><span class="line">                        |  |                 | |               | |            |  |          | |</span><br><span class="line">                        |  | executorA       | |               | | executorB  |  |executorC | |</span><br><span class="line">                        |  +-----------------+ |               | +------------+  +----------+ |</span><br><span class="line">                        +----------------------+               +------------------------------+</span><br></pre></td></tr></table></figure>

<p>下一篇：<a href="/2019/09/15/spark/008-spark-standalone-conf-run/" title="spark standalone模式的配置与运行">spark standalone模式的配置与运行</a></p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>上一篇：<a href="/2019/09/14/spark/006-spark-config-wordcount/" title="spark：wordcount">spark：wordcount</a></p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/14/spark/007-spark-data-flow/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/14/spark/007-spark-data-flow/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/14/spark/007-spark-data-flow/" data-id="cl1fw7fnp00jqvkd33pjd6s5b" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/spark/" rel="tag">spark</a><span class="article-tag-list-count">10</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-spark/006-spark-config-wordcount" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/14/spark/006-spark-config-wordcount/" class="article-date">
  <time datetime="2019-09-14T12:18:46.000Z" itemprop="datePublished">2019-09-14</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/14/spark/006-spark-config-wordcount/">spark：wordcount</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文是系列spark学习过程第一篇：wordcount, 将会认识目录结构、常用参数、运行示例。</p>
<h1 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">spark-2.4.4-bin-hadoop2.7$ ll</span><br><span class="line">总用量 136</span><br><span class="line">drwxr-xr-x 13 jack jack  4096 8月  28 05:30 ./</span><br><span class="line">drwxrwxr-x  3 jack jack  4096 9月  14 10:03 ../</span><br><span class="line">drwxr-xr-x  2 jack jack  4096 8月  28 05:30 bin/</span><br><span class="line">drwxr-xr-x  2 jack jack  4096 8月  28 05:30 conf/</span><br><span class="line">drwxr-xr-x  5 jack jack  4096 8月  28 05:30 data/</span><br><span class="line">drwxr-xr-x  4 jack jack  4096 8月  28 05:30 examples/</span><br><span class="line">drwxr-xr-x  2 jack jack 12288 8月  28 05:30 jars/</span><br><span class="line">drwxr-xr-x  4 jack jack  4096 8月  28 05:30 kubernetes/</span><br><span class="line">-rw-r--r--  1 jack jack 21316 8月  28 05:30 LICENSE</span><br><span class="line">drwxr-xr-x  2 jack jack  4096 8月  28 05:30 licenses/</span><br><span class="line">-rw-r--r--  1 jack jack 42919 8月  28 05:30 NOTICE</span><br><span class="line">drwxr-xr-x  9 jack jack  4096 8月  28 05:30 python/</span><br><span class="line">drwxr-xr-x  3 jack jack  4096 8月  28 05:30 R/</span><br><span class="line">-rw-r--r--  1 jack jack  3952 8月  28 05:30 README.md</span><br><span class="line">-rw-r--r--  1 jack jack   164 8月  28 05:30 RELEASE</span><br><span class="line">drwxr-xr-x  2 jack jack  4096 8月  28 05:30 sbin/</span><br><span class="line">drwxr-xr-x  2 jack jack  4096 8月  28 05:30 yarn/</span><br><span class="line"></span><br><span class="line">spark-2.4.4-bin-hadoop2.7/bin$ ll</span><br><span class="line">总用量 56</span><br><span class="line">drwxr-xr-x  2 jack jack 4096 9月  14 20:22 ./</span><br><span class="line">drwxr-xr-x 13 jack jack 4096 8月  28 05:30 ../</span><br><span class="line">-rwxr-xr-x  1 jack jack 1089 8月  28 05:30 beeline*</span><br><span class="line">-rwxr-xr-x  1 jack jack 5440 8月  28 05:30 docker-image-tool.sh*</span><br><span class="line">-rwxr-xr-x  1 jack jack 1933 8月  28 05:30 find-spark-home*</span><br><span class="line">-rw-r--r--  1 jack jack 2025 8月  28 05:30 load-spark-env.sh</span><br><span class="line">-rwxr-xr-x  1 jack jack 2987 8月  28 05:30 pyspark*</span><br><span class="line">-rwxr-xr-x  1 jack jack 1030 8月  28 05:30 run-example*</span><br><span class="line">-rwxr-xr-x  1 jack jack 3196 8月  28 05:30 spark-class*</span><br><span class="line">-rwxr-xr-x  1 jack jack 1039 8月  28 05:30 sparkR*</span><br><span class="line">-rwxr-xr-x  1 jack jack 3122 8月  28 05:30 spark-shell*</span><br><span class="line">-rwxr-xr-x  1 jack jack 1065 8月  28 05:30 spark-sql*</span><br><span class="line">-rwxr-xr-x  1 jack jack 1040 8月  28 05:30 spark-submit*</span><br></pre></td></tr></table></figure>

<ul>
<li>bin: 操作</li>
<li>sib: 启动关闭等</li>
</ul>
<h1 id="bin-x2F-spark-submit"><a href="#bin-x2F-spark-submit" class="headerlink" title="bin&#x2F;spark-submit"></a>bin&#x2F;spark-submit</h1><p>用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Usage: spark-submit [options] &lt;app jar | python file | R file&gt; [app arguments]</span><br><span class="line">Usage: spark-submit --kill [submission ID] --master [spark://...]</span><br><span class="line">Usage: spark-submit --status [submission ID] --master [spark://...]</span><br><span class="line">Usage: spark-submit run-example [options] example-class [example args]</span><br></pre></td></tr></table></figure>

<p>其主要常用参数：</p>
<ul>
<li><p>–master MASTER_URL : master的地址，有几种可选的：spark:&#x2F;&#x2F;host:port, mesos:&#x2F;&#x2F;host:port, yarn,<br>                       k8s:&#x2F;&#x2F;<a href="https://host:port">https://host:port</a>, or local (Default: local[*])</p>
</li>
<li><p>–deploy-mode DEPLOY_MODE： 集群还是客户端模式：client, cluster</p>
</li>
<li><p>–class CLASS_NAME: 主类</p>
</li>
<li><p>–name NAME</p>
</li>
<li><p>–conf PROP&#x3D;VALUE: 键值对配置</p>
</li>
<li><p>–driver-memory MEM         Memory for driver (e.g. 1000M, 2G) (Default: 1024M)</p>
</li>
<li><p>–executor-memory MEM       Memory per executor (e.g. 1000M, 2G) (Default: 1G).</p>
</li>
</ul>
<p>下面是在几个模式下才有的参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Cluster deploy mode only:</span><br><span class="line"> --driver-cores NUM          Number of cores used by the driver, only in cluster mode</span><br><span class="line">                             (Default: 1).</span><br><span class="line"></span><br><span class="line">Spark standalone or Mesos with cluster deploy mode only:</span><br><span class="line"> --supervise                 If given, restarts the driver on failure.</span><br><span class="line"> --kill SUBMISSION_ID        If given, kills the driver specified.</span><br><span class="line"> --status SUBMISSION_ID      If given, requests the status of the driver specified.</span><br><span class="line"></span><br><span class="line">Spark standalone and Mesos only:</span><br><span class="line"> --total-executor-cores NUM  Total cores for all executors.</span><br><span class="line"></span><br><span class="line">Spark standalone and YARN only:</span><br><span class="line"> --executor-cores NUM        Number of cores per executor. (Default: 1 in YARN mode,</span><br><span class="line">                             or all available cores on the worker in standalone mode)</span><br></pre></td></tr></table></figure>

<h1 id="SparkPi-example"><a href="#SparkPi-example" class="headerlink" title="SparkPi example"></a>SparkPi example</h1><p>迭代一百次求Pi：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spark-submit \</span><br><span class="line">&gt; --class org.apache.spark.examples.SparkPi \</span><br><span class="line">&gt; --executor-memory 1G \</span><br><span class="line">&gt; --total-executor-cores 2 \</span><br><span class="line">&gt; ./examples/jars/spark-examples_2.11-2.4.4.jar \</span><br><span class="line">&gt; 100</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">19/09/14 20:36:44 INFO Utils: Successfully started service &#x27;SparkUI&#x27; on port 4040.</span><br><span class="line">19/09/14 20:36:44 INFO SparkUI: Bound SparkUI to 0.0.0.0, and started at http://192.168.199.249:4040</span><br><span class="line">...</span><br><span class="line">19/09/14 20:36:49 INFO DAGScheduler: Job 0 finished: reduce at SparkPi.scala:38, took 4.783231 s</span><br><span class="line">Pi is roughly 3.1414851141485114</span><br><span class="line">19/09/14 20:36:49 INFO SparkUI: Stopped Spark web UI at http://192.168.199.249:4040</span><br></pre></td></tr></table></figure>

<ul>
<li>4040端口的临时界面</li>
<li>计算结果</li>
</ul>
<h1 id="spark-shell"><a href="#spark-shell" class="headerlink" title="spark-shell"></a>spark-shell</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spark-shell</span><br><span class="line">...</span><br><span class="line">Spark context Web UI available at http://192.168.199.249:4040</span><br><span class="line">Spark context available as &#x27;sc&#x27; (master = local[*], app id = local-1568464941397).</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<ul>
<li>4040的web界面</li>
<li>默认以<code>local[*]</code>模式启动</li>
</ul>
<p>写一个wordcount：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; sc.textFile(&quot;./README.md&quot;).flatMap(_.split(&quot; &quot;)).map((_,1)).reduceByKey(_+_).collect</span><br></pre></td></tr></table></figure>

<p>保存为文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scala&gt; sc.textFile(&quot;./README.md&quot;).flatMap(_.split(&quot; &quot;)).map((_,1)).reduceByKey(_+_).saveAsTextFile(&quot;./out&quot;)</span><br></pre></td></tr></table></figure>
<p>查看文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ ll out/</span><br><span class="line">总用量 28</span><br><span class="line">drwxr-xr-x  2 jack jack 4096 9月  14 20:48 ./</span><br><span class="line">drwxr-xr-x 14 jack jack 4096 9月  14 20:48 ../</span><br><span class="line">-rw-r--r--  1 jack jack 2103 9月  14 20:48 part-00000</span><br><span class="line">-rw-r--r--  1 jack jack   28 9月  14 20:48 .part-00000.crc</span><br><span class="line">-rw-r--r--  1 jack jack 1932 9月  14 20:48 part-00001</span><br><span class="line">-rw-r--r--  1 jack jack   24 9月  14 20:48 .part-00001.crc</span><br><span class="line">-rw-r--r--  1 jack jack    0 9月  14 20:48 _SUCCESS</span><br><span class="line">-rw-r--r--  1 jack jack    8 9月  14 20:48 ._SUCCESS.crc</span><br></pre></td></tr></table></figure>

<h1 id="submit进程和webUI"><a href="#submit进程和webUI" class="headerlink" title="submit进程和webUI"></a>submit进程和webUI</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ jps</span><br><span class="line">14501 SparkSubmit</span><br><span class="line">16301 Jps</span><br></pre></td></tr></table></figure>

<p>关于webUI，直接打开localhost:404去看就ok。</p>
<p>下一篇：<a href="/2019/09/14/spark/007-spark-data-flow/" title="spark运行流程">spark运行流程</a></p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文是系列spark学习过程第一篇：wordcount, 将会认识目录结构、常用参数、运行示例。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/14/spark/006-spark-config-wordcount/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/14/spark/006-spark-config-wordcount/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/14/spark/006-spark-config-wordcount/" data-id="cl1fw7fnp00jovkd389hsflne" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/spark/" rel="tag">spark</a><span class="article-tag-list-count">10</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-tools/021-ubuntu-surfshark-vpn-config" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/14/tools/021-ubuntu-surfshark-vpn-config/" class="article-date">
  <time datetime="2019-09-14T06:55:15.000Z" itemprop="datePublished">2019-09-14</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/14/tools/021-ubuntu-surfshark-vpn-config/">ubuntu使用surfshark-vpn</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文针对中国用户使用surfshark-vpn遇到的问题做一个记录，关于ubuntu中连接vpn的问题解决办法。</p>
<h1 id="无法下载vpn"><a href="#无法下载vpn" class="headerlink" title="无法下载vpn"></a>无法下载vpn</h1><p>找一个翻墙后的手机热点，然后下载更新软件。</p>
<h1 id="连接上vpn，但无法访问"><a href="#连接上vpn，但无法访问" class="headerlink" title="连接上vpn，但无法访问"></a>连接上vpn，但无法访问</h1><p>修改DNS，改为<code>1.1.1.1和1.0.0.1</code>,具体修改方法参看：<a href="/2019/09/14/linux/030-ubuntu-change-dns/" title="ubuntu修改DNS">ubuntu修改DNS</a></p>
<h1 id="PS"><a href="#PS" class="headerlink" title="PS"></a>PS</h1><ol>
<li>中国区的登录网址：<a target="_blank" rel="noopener" href="https://account.shark-china.com/">https://account.shark-china.com/</a></li>
<li>找他们售后支持，很靠谱，也很热情，顺便还练习英语聊天，给他们点个赞</li>
</ol>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文针对中国用户使用surfshark-vpn遇到的问题做一个记录，关于ubuntu中连接vpn的问题解决办法。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/14/tools/021-ubuntu-surfshark-vpn-config/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/14/tools/021-ubuntu-surfshark-vpn-config/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/14/tools/021-ubuntu-surfshark-vpn-config/" data-id="cl1fw7foc00lqvkd34m48bpet" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a><span class="article-tag-list-count">13</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/vpn/" rel="tag">vpn</a><span class="article-tag-list-count">1</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-maven/008-maven-define-jdk-version" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/14/maven/008-maven-define-jdk-version/" class="article-date">
  <time datetime="2019-09-14T02:27:15.000Z" itemprop="datePublished">2019-09-14</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/14/maven/008-maven-define-jdk-version/">maven手动指定JDK版本</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>每次maven的pom改变，idea都会回到默认的JDK1.5，让人很无语，可以通过指定JDK版本来解决。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>版本<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>



      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>每次maven的pom改变，idea都会回到默认的JDK1.5，让人很无语，可以通过指定JDK版本来解决。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/14/maven/008-maven-define-jdk-version/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/14/maven/008-maven-define-jdk-version/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/14/maven/008-maven-define-jdk-version/" data-id="cl1fw7fn300hfvkd3h2y3gq63" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/maven/" rel="tag">maven</a><span class="article-tag-list-count">11</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-linux/030-ubuntu-change-dns" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/14/linux/030-ubuntu-change-dns/" class="article-date">
  <time datetime="2019-09-14T01:54:44.000Z" itemprop="datePublished">2019-09-14</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/14/linux/030-ubuntu-change-dns/">ubuntu修改DNS</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>本文记录下ubuntu系统如何修改DNS。</p>
<h1 id="修改DNS"><a href="#修改DNS" class="headerlink" title="修改DNS"></a>修改DNS</h1><ul>
<li>如果连的WIFI，就打开wifi的设置</li>
<li>如果连的有线，就打开有线设置</li>
</ul>
<img src="/2019/09/14/linux/030-ubuntu-change-dns/000.png" class="">

<h1 id="重启生效"><a href="#重启生效" class="headerlink" title="重启生效"></a>重启生效</h1><p>最简单的方式，在界面上修改了，重启生效。</p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>本文记录下ubuntu系统如何修改DNS。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/14/linux/030-ubuntu-change-dns/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/14/linux/030-ubuntu-change-dns/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/14/linux/030-ubuntu-change-dns/" data-id="cl1fw7fmu00ggvkd394nj9g31" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a><span class="article-tag-list-count">13</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/067-log4j-slf4j-logback-log4j12-diff" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/13/java/067-log4j-slf4j-logback-log4j12-diff/" class="article-date">
  <time datetime="2019-09-13T01:05:15.000Z" itemprop="datePublished">2019-09-13</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/13/java/067-log4j-slf4j-logback-log4j12-diff/">log4j、logback、log4j12、slf4j的区别</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>日志是一个系统必不可少的部分，每个程序员都在用，但是对于java程序员来说，不断发现的日志框架让我们晕头转向，<br>于是，有识之士说：必须把这个弄清楚！</p>
<p>其实，只要花那么几分钟就可以明白他们之间的关系，只要找对了资源，网上很多博客都是抄过来抄过去，很少自己掌握了信息来源和独立见解。</p>
<p>最好的信息来源当然是官网，下面就开始花几分钟弄明白他们的关系。</p>
<h1 id="SLF4J"><a href="#SLF4J" class="headerlink" title="SLF4J"></a>SLF4J</h1><p>去到它的官网：<a target="_blank" rel="noopener" href="https://www.slf4j.org/manual.html">https://www.slf4j.org/manual.html</a>, 不下一分钟，就会发现这张图：</p>
<img src="/2019/09/13/java/067-log4j-slf4j-logback-log4j12-diff/000.png" class="">

<p>再看看开头的解释：</p>
<blockquote>
<p><code>Simple Logging Facade for Java（SLF4J）</code>可用作各种日志框架的简单外观或抽象，例如<code>java.util.logging</code>，<code>logback和log4j</code>。 SLF4J允许最终用户在部署时插入所需的日志记录框架。 请注意，启用SLF4J的库&#x2F;应用程序意味着只添加一个强制依赖项，即<code>slf4j-api-2.0.0-alpha1-SNAPSHOT.jar</code>。</p>
</blockquote>
<p>反正我瞬间就明白了，不明白自己去读把。</p>
<p>特殊说明下：slf4j和log4j中间那一层log4j12就是一个连接层，就像适配器一样把slf4j和log4j连接起来。</p>
<p>好了，本文完结，但是为了自己好，还是将这些slf4j的实现的配置文档都记录下，方便查找配置。</p>
<h1 id="log4j"><a href="#log4j" class="headerlink" title="log4j"></a>log4j</h1><p><a target="_blank" rel="noopener" href="https://logging.apache.org/log4j">https://logging.apache.org/log4j</a></p>
<p>关于配置看这里：<a target="_blank" rel="noopener" href="https://logging.apache.org/log4j/2.x/manual/configuration.html">https://logging.apache.org/log4j/2.x/manual/configuration.html</a></p>
<p>里面有各种格式文件的示例：</p>
<ul>
<li>xml</li>
<li>yaml</li>
<li>json</li>
<li>properties</li>
</ul>
<h1 id="logback"><a href="#logback" class="headerlink" title="logback"></a>logback</h1><p>官方：<a target="_blank" rel="noopener" href="https://logback.qos.ch/">https://logback.qos.ch/</a>, 其github: <a target="_blank" rel="noopener" href="https://github.com/qos-ch/logback">https://github.com/qos-ch/logback</a></p>
<p>关于配置查看这里：<a target="_blank" rel="noopener" href="https://logback.qos.ch/manual/configuration.html">https://logback.qos.ch/manual/configuration.html</a></p>
<h1 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h1><p>使用spring框架时，spring本身依赖logback，而其他库的实现使用log4j打日志，一般解决方法是：去掉logback，完全使用log4j。</p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>日志是一个系统必不可少的部分，每个程序员都在用，但是对于java程序员来说，不断发现的日志框架让我们晕头转向，<br>于是，有识之士说：必须把这个弄清楚！</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/13/java/067-log4j-slf4j-logback-log4j12-diff/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/13/java/067-log4j-slf4j-logback-log4j12-diff/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/13/java/067-log4j-slf4j-logback-log4j12-diff/" data-id="cl1fw7flu00cuvkd34sj2duu1" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/log4j/" rel="tag">log4j</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/log4j12/" rel="tag">log4j12</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/logback/" rel="tag">logback</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/slf4j/" rel="tag">slf4j</a><span class="article-tag-list-count">1</span></li></ul>

      </footer>
      </div>
      
</article>


  
    <article id="post-java/066-java-cors-rewrite-header" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/12/java/066-java-cors-rewrite-header/" class="article-date">
  <time datetime="2019-09-12T06:37:10.000Z" itemprop="datePublished">2019-09-12</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 itemprop="name">
      <a class="article-title" href="/history/2019/09/12/java/066-java-cors-rewrite-header/">java后端跨域时自定义header字段</a>
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>在跨域时，后端可能需要往response header里增加点自定义字段，但是直接增加是不行的。</p>
<h1 id="之前"><a href="#之前" class="headerlink" title="之前"></a>之前</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.setHeader(<span class="string">&quot;token&quot;</span>, <span class="string">&quot;sdfsdfjdskjfhjdsf&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="之后"><a href="#之后" class="headerlink" title="之后"></a>之后</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 允许返回token在响应头中</span></span><br><span class="line">response.setHeader(<span class="string">&quot;Access-Control-Expose-Headers&quot;</span>, <span class="string">&quot;token&quot;</span>);</span><br><span class="line">response.setHeader(<span class="string">&quot;token&quot;</span>, <span class="string">&quot;sdfsdfjdskjfhjdsf&quot;</span>);</span><br></pre></td></tr></table></figure>





      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                
                      
                        
                          
                            
                              
                                
                                  
                                    <p>
                                      <p>在跨域时，后端可能需要往response header里增加点自定义字段，但是直接增加是不行的。</p>

                                        <p>
                                          
                                            
                                              
                                                      
          </div>
    <p class="article-more-link">
      <a href="/history/2019/09/12/java/066-java-cors-rewrite-header/#more">
        Read More
      </a>
    </p>
    <!-- <div class="article-more-link">
      <a href="/history/2019/09/12/java/066-java-cors-rewrite-header/#more">
        read more
      </a>
    </div> -->
    


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/12/java/066-java-cors-rewrite-header/" data-id="cl1fw7flt00crvkd39cprb7pl" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/java/" rel="tag">java</a><span class="article-tag-list-count">104</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/spring/" rel="tag">spring</a><span class="article-tag-list-count">12</span></li></ul>

      </footer>
      </div>
      
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/history/">&amp;laquo; 上一页</a><a class="page-number" href="/history/">1</a><span class="page-number current">2</span><a class="page-number" href="/history/page/3/">3</a><a class="page-number" href="/history/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/history/page/18/">18</a><a class="extend next" rel="next" href="/history/page/3/">下一页 &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/UI-test/" rel="tag">UI test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/annotation/" rel="tag">annotation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ansible/" rel="tag">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ant/" rel="tag">ant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/aop/" rel="tag">aop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/archiva/" rel="tag">archiva</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/asciidoc/" rel="tag">asciidoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/awk/" rel="tag">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/axios/" rel="tag">axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/basic/" rel="tag">basic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/big-data/" rel="tag">big data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/blockchain/" rel="tag">blockchain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/centos/" rel="tag">centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/cglib/" rel="tag">cglib</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/checkstyle/" rel="tag">checkstyle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/chrome/" rel="tag">chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/computer-principle/" rel="tag">computer principle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/cors/" rel="tag">cors</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/data-structure/" rel="tag">data structure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/design-pattern/" rel="tag">design-pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/elasticsearch/" rel="tag">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/es/" rel="tag">es</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/eureka/" rel="tag">eureka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/firefox/" rel="tag">firefox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/geohash/" rel="tag">geohash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/geomesa/" rel="tag">geomesa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/gitlab/" rel="tag">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/gradle/" rel="tag">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/groovy/" rel="tag">groovy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/hadoop/" rel="tag">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/hbase/" rel="tag">hbase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/html/" rel="tag">html</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/idea/" rel="tag">idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ip/" rel="tag">ip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/junit/" rel="tag">junit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jupyter/" rel="tag">jupyter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jupyterhub/" rel="tag">jupyterhub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jvm/" rel="tag">jvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jwt/" rel="tag">jwt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/katalon/" rel="tag">katalon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/keepalived/" rel="tag">keepalived</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/latex/" rel="tag">latex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/linux-kernel/" rel="tag">linux kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/load-balance/" rel="tag">load balance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/log/" rel="tag">log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/log4j/" rel="tag">log4j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/log4j12/" rel="tag">log4j12</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/logback/" rel="tag">logback</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/lombok/" rel="tag">lombok</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/lru/" rel="tag">lru</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/lucene/" rel="tag">lucene</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/magnet/" rel="tag">magnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/make/" rel="tag">make</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/makefile/" rel="tag">makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/manjaro/" rel="tag">manjaro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/math/" rel="tag">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/md5/" rel="tag">md5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/mhtml/" rel="tag">mhtml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/microservice/" rel="tag">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/music/" rel="tag">music</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/mybatis/" rel="tag">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/notebook/" rel="tag">notebook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/nvidia/" rel="tag">nvidia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/oauth/" rel="tag">oauth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/openstack/" rel="tag">openstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/optimization/" rel="tag">optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pandas/" rel="tag">pandas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pandoc/" rel="tag">pandoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pgsql/" rel="tag">pgsql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/probability/" rel="tag">probability</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pyspark/" rel="tag">pyspark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/quartz/" rel="tag">quartz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/resource/" rel="tag">resource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/review/" rel="tag">review</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/sbt/" rel="tag">sbt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/scala/" rel="tag">scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/slf4j/" rel="tag">slf4j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spark/" rel="tag">spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spring-cloud/" rel="tag">spring cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spring-boot/" rel="tag">spring-boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/springboot/" rel="tag">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/sqlserver/" rel="tag">sqlserver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/statistics/" rel="tag">statistics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/syslog/" rel="tag">syslog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/term/" rel="tag">term</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/test/" rel="tag">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/texlive/" rel="tag">texlive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/thread/" rel="tag">thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/tomcat/" rel="tag">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/tool/" rel="tag">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/urban-computing/" rel="tag">urban computing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/video/" rel="tag">video</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vpn/" rel="tag">vpn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/web-dav/" rel="tag">web-dav</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/week/" rel="tag">week</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/wordcloud/" rel="tag">wordcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/work/" rel="tag">work</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/xml/" rel="tag">xml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/zipkin/" rel="tag">zipkin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/zookeeper/" rel="tag">zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" rel="tag">云计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E5%85%83%E7%BC%96%E7%A8%8B/" rel="tag">元编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E5%9F%8E%E5%B8%82%E8%AE%A1%E7%AE%97/" rel="tag">城市计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E6%A6%82%E5%BF%B5/" rel="tag">概念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E8%BF%90%E7%BB%B4/" rel="tag">运维</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/history/tags/AI/" style="font-size: 10.53px;">AI</a> <a href="/history/tags/UI-test/" style="font-size: 10px;">UI test</a> <a href="/history/tags/algorithm/" style="font-size: 10.53px;">algorithm</a> <a href="/history/tags/android/" style="font-size: 10.53px;">android</a> <a href="/history/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/history/tags/ansible/" style="font-size: 13.16px;">ansible</a> <a href="/history/tags/ant/" style="font-size: 10px;">ant</a> <a href="/history/tags/aop/" style="font-size: 10px;">aop</a> <a href="/history/tags/archiva/" style="font-size: 10px;">archiva</a> <a href="/history/tags/asciidoc/" style="font-size: 10px;">asciidoc</a> <a href="/history/tags/awk/" style="font-size: 10px;">awk</a> <a href="/history/tags/axios/" style="font-size: 10px;">axios</a> <a href="/history/tags/basic/" style="font-size: 13.16px;">basic</a> <a href="/history/tags/big-data/" style="font-size: 10.53px;">big data</a> <a href="/history/tags/blockchain/" style="font-size: 10px;">blockchain</a> <a href="/history/tags/centos/" style="font-size: 12.11px;">centos</a> <a href="/history/tags/cglib/" style="font-size: 10px;">cglib</a> <a href="/history/tags/checkstyle/" style="font-size: 10px;">checkstyle</a> <a href="/history/tags/chrome/" style="font-size: 11.05px;">chrome</a> <a href="/history/tags/computer-principle/" style="font-size: 10px;">computer principle</a> <a href="/history/tags/cors/" style="font-size: 10.53px;">cors</a> <a href="/history/tags/data-structure/" style="font-size: 10px;">data structure</a> <a href="/history/tags/design-pattern/" style="font-size: 10.53px;">design-pattern</a> <a href="/history/tags/docker/" style="font-size: 17.89px;">docker</a> <a href="/history/tags/elasticsearch/" style="font-size: 13.16px;">elasticsearch</a> <a href="/history/tags/es/" style="font-size: 10px;">es</a> <a href="/history/tags/eureka/" style="font-size: 10px;">eureka</a> <a href="/history/tags/firefox/" style="font-size: 10px;">firefox</a> <a href="/history/tags/flask/" style="font-size: 10px;">flask</a> <a href="/history/tags/geohash/" style="font-size: 10px;">geohash</a> <a href="/history/tags/geomesa/" style="font-size: 10px;">geomesa</a> <a href="/history/tags/git/" style="font-size: 13.16px;">git</a> <a href="/history/tags/gitlab/" style="font-size: 11.05px;">gitlab</a> <a href="/history/tags/gradle/" style="font-size: 10px;">gradle</a> <a href="/history/tags/groovy/" style="font-size: 10px;">groovy</a> <a href="/history/tags/hadoop/" style="font-size: 10.53px;">hadoop</a> <a href="/history/tags/hbase/" style="font-size: 11.58px;">hbase</a> <a href="/history/tags/hexo/" style="font-size: 10.53px;">hexo</a> <a href="/history/tags/html/" style="font-size: 10.53px;">html</a> <a href="/history/tags/http/" style="font-size: 10px;">http</a> <a href="/history/tags/idea/" style="font-size: 11.05px;">idea</a> <a href="/history/tags/ip/" style="font-size: 10px;">ip</a> <a href="/history/tags/java/" style="font-size: 20px;">java</a> <a href="/history/tags/javascript/" style="font-size: 11.58px;">javascript</a> <a href="/history/tags/js/" style="font-size: 13.16px;">js</a> <a href="/history/tags/junit/" style="font-size: 10px;">junit</a> <a href="/history/tags/jupyter/" style="font-size: 10px;">jupyter</a> <a href="/history/tags/jupyterhub/" style="font-size: 10.53px;">jupyterhub</a> <a href="/history/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/history/tags/jwt/" style="font-size: 10px;">jwt</a> <a href="/history/tags/k8s/" style="font-size: 11.05px;">k8s</a> <a href="/history/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/history/tags/katalon/" style="font-size: 10px;">katalon</a> <a href="/history/tags/keepalived/" style="font-size: 10.53px;">keepalived</a> <a href="/history/tags/latex/" style="font-size: 11.05px;">latex</a> <a href="/history/tags/life/" style="font-size: 18.95px;">life</a> <a href="/history/tags/linux/" style="font-size: 19.47px;">linux</a> <a href="/history/tags/linux-kernel/" style="font-size: 10px;">linux kernel</a> <a href="/history/tags/load-balance/" style="font-size: 10px;">load balance</a> <a href="/history/tags/log/" style="font-size: 10px;">log</a> <a href="/history/tags/log4j/" style="font-size: 10px;">log4j</a> <a href="/history/tags/log4j12/" style="font-size: 10px;">log4j12</a> <a href="/history/tags/logback/" style="font-size: 10px;">logback</a> <a href="/history/tags/lombok/" style="font-size: 10px;">lombok</a> <a href="/history/tags/lru/" style="font-size: 10px;">lru</a> <a href="/history/tags/lucene/" style="font-size: 10px;">lucene</a> <a href="/history/tags/magnet/" style="font-size: 10px;">magnet</a> <a href="/history/tags/make/" style="font-size: 10px;">make</a> <a href="/history/tags/makefile/" style="font-size: 10px;">makefile</a> <a href="/history/tags/manjaro/" style="font-size: 10px;">manjaro</a> <a href="/history/tags/math/" style="font-size: 11.05px;">math</a> <a href="/history/tags/maven/" style="font-size: 15.26px;">maven</a> <a href="/history/tags/md5/" style="font-size: 10px;">md5</a> <a href="/history/tags/mhtml/" style="font-size: 10px;">mhtml</a> <a href="/history/tags/microservice/" style="font-size: 14.21px;">microservice</a> <a href="/history/tags/music/" style="font-size: 10px;">music</a> <a href="/history/tags/mybatis/" style="font-size: 11.05px;">mybatis</a> <a href="/history/tags/mysql/" style="font-size: 12.11px;">mysql</a> <a href="/history/tags/nginx/" style="font-size: 12.63px;">nginx</a> <a href="/history/tags/notebook/" style="font-size: 10px;">notebook</a> <a href="/history/tags/npm/" style="font-size: 10px;">npm</a> <a href="/history/tags/nvidia/" style="font-size: 10px;">nvidia</a> <a href="/history/tags/oauth/" style="font-size: 10px;">oauth</a> <a href="/history/tags/openstack/" style="font-size: 12.11px;">openstack</a> <a href="/history/tags/optimization/" style="font-size: 10px;">optimization</a> <a href="/history/tags/pandas/" style="font-size: 10px;">pandas</a> <a href="/history/tags/pandoc/" style="font-size: 10px;">pandoc</a> <a href="/history/tags/pgsql/" style="font-size: 11.58px;">pgsql</a> <a href="/history/tags/probability/" style="font-size: 10px;">probability</a> <a href="/history/tags/pyspark/" style="font-size: 10px;">pyspark</a> <a href="/history/tags/python/" style="font-size: 17.37px;">python</a> <a href="/history/tags/quartz/" style="font-size: 10.53px;">quartz</a> <a href="/history/tags/react/" style="font-size: 10px;">react</a> <a href="/history/tags/redis/" style="font-size: 15.79px;">redis</a> <a href="/history/tags/resource/" style="font-size: 10px;">resource</a> <a href="/history/tags/review/" style="font-size: 10px;">review</a> <a href="/history/tags/sbt/" style="font-size: 10px;">sbt</a> <a href="/history/tags/scala/" style="font-size: 14.74px;">scala</a> <a href="/history/tags/shell/" style="font-size: 12.63px;">shell</a> <a href="/history/tags/slf4j/" style="font-size: 10px;">slf4j</a> <a href="/history/tags/spark/" style="font-size: 14.74px;">spark</a> <a href="/history/tags/spring/" style="font-size: 15.79px;">spring</a> <a href="/history/tags/spring-cloud/" style="font-size: 12.11px;">spring cloud</a> <a href="/history/tags/spring-boot/" style="font-size: 13.68px;">spring-boot</a> <a href="/history/tags/springboot/" style="font-size: 11.05px;">springboot</a> <a href="/history/tags/sql/" style="font-size: 11.05px;">sql</a> <a href="/history/tags/sqlserver/" style="font-size: 10.53px;">sqlserver</a> <a href="/history/tags/ssh/" style="font-size: 12.11px;">ssh</a> <a href="/history/tags/statistics/" style="font-size: 10px;">statistics</a> <a href="/history/tags/syslog/" style="font-size: 10px;">syslog</a> <a href="/history/tags/term/" style="font-size: 10px;">term</a> <a href="/history/tags/test/" style="font-size: 10px;">test</a> <a href="/history/tags/texlive/" style="font-size: 10px;">texlive</a> <a href="/history/tags/thread/" style="font-size: 10px;">thread</a> <a href="/history/tags/tomcat/" style="font-size: 13.16px;">tomcat</a> <a href="/history/tags/tool/" style="font-size: 16.84px;">tool</a> <a href="/history/tags/ubuntu/" style="font-size: 16.32px;">ubuntu</a> <a href="/history/tags/urban-computing/" style="font-size: 10px;">urban computing</a> <a href="/history/tags/video/" style="font-size: 10px;">video</a> <a href="/history/tags/vim/" style="font-size: 10.53px;">vim</a> <a href="/history/tags/vpn/" style="font-size: 10px;">vpn</a> <a href="/history/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/history/tags/vue/" style="font-size: 11.05px;">vue</a> <a href="/history/tags/web/" style="font-size: 10px;">web</a> <a href="/history/tags/web-dav/" style="font-size: 10px;">web-dav</a> <a href="/history/tags/webpack/" style="font-size: 10.53px;">webpack</a> <a href="/history/tags/week/" style="font-size: 18.42px;">week</a> <a href="/history/tags/windows/" style="font-size: 10px;">windows</a> <a href="/history/tags/wordcloud/" style="font-size: 10px;">wordcloud</a> <a href="/history/tags/work/" style="font-size: 10px;">work</a> <a href="/history/tags/xml/" style="font-size: 10px;">xml</a> <a href="/history/tags/zipkin/" style="font-size: 10px;">zipkin</a> <a href="/history/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/history/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 12.63px;">云计算</a> <a href="/history/tags/%E5%85%83%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">元编程</a> <a href="/history/tags/%E5%9F%8E%E5%B8%82%E8%AE%A1%E7%AE%97/" style="font-size: 10px;">城市计算</a> <a href="/history/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">架构</a> <a href="/history/tags/%E6%A6%82%E5%BF%B5/" style="font-size: 10px;">概念</a> <a href="/history/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a> <a href="/history/tags/%E7%88%AC%E8%99%AB/" style="font-size: 10px;">爬虫</a> <a href="/history/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 10px;">运维</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2017/12/">十二月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/history/2022/03/31/redis/000-redis-interview/">Redis面试总结202203</a>
          </li>
        
          <li>
            <a href="/history/2019/10/27/maven/009-maven-deploy/">使用IDEA部署jar包到maven仓库(maven deploy)</a>
          </li>
        
          <li>
            <a href="/history/2019/10/24/java/075-pluggable-annotation-processing-lombok/">Pluggable Annotation Processing的讲解与实践</a>
          </li>
        
          <li>
            <a href="/history/2019/10/18/life/036-weekly-learn/">2019-42-周报</a>
          </li>
        
          <li>
            <a href="/history/2019/10/15/shell/003-carriage-linechange/">r command not found</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Jackpler<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/history/" class="mobile-nav-link">home</a>
  
    <a href="/history/archives" class="mobile-nav-link">archives</a>
  
    <a href="/history/about" class="mobile-nav-link">about</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/history/fancybox/jquery.fancybox.css">

  
<script src="/history/fancybox/jquery.fancybox.pack.js"></script>




<script src="/history/js/script.js"></script>




  </div>
</body>
</html>