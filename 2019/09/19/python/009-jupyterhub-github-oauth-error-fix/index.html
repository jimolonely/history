<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-111673440-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <title>jupyterhub接入github认证oauth2.0的问题记录与解决 | 在我的世界</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="使用环境：  ubuntu18.04 python: 3.6 jupyterhub:1.0.0  1234$ pip3 list | grep jupyterjupyter-client          5.3.3              jupyter-core            4.5.0              jupyterhub              1.0.0  torn">
<meta property="og:type" content="article">
<meta property="og:title" content="jupyterhub接入github认证oauth2.0的问题记录与解决">
<meta property="og:url" content="http://jimolonely.github.io/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/index.html">
<meta property="og:site_name" content="在我的世界">
<meta property="og:description" content="使用环境：  ubuntu18.04 python: 3.6 jupyterhub:1.0.0  1234$ pip3 list | grep jupyterjupyter-client          5.3.3              jupyter-core            4.5.0              jupyterhub              1.0.0  torn">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-09-19T12:48:28.000Z">
<meta property="article:modified_time" content="2022-04-01T03:25:51.119Z">
<meta property="article:author" content="Jackpler">
<meta property="article:tag" content="jupyterhub">
<meta property="article:tag" content="ubuntu">
<meta property="article:tag" content="notebook">
<meta property="article:tag" content="oauth">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/history/atom.xml" title="在我的世界" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/history/css/style.css">

<meta name="generator" content="Hexo 6.1.0"><link rel="stylesheet" href="/history/css/prism-atom-dark.css" type="text/css">
<link rel="stylesheet" href="/history/css/prism-line-numbers.css" type="text/css"><script src="/history/js/prism.js"></script>
<script src="/history/js/prism-line-numbers.min.js"></script></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/history/" id="logo">在我的世界</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/history/">home</a>
        
          <a class="main-nav-link" href="/history/archives">archives</a>
        
          <a class="main-nav-link" href="/history/about">about</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/history/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://jimolonely.github.io/history"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-python/009-jupyterhub-github-oauth-error-fix" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/" class="article-date">
  <time datetime="2019-09-19T12:48:28.000Z" itemprop="datePublished">2019-09-19</time>
</a>
      
  </div>
  <div class="article-inner">
    
      
        <header class="article-header">
          
  
    <h1 class="article-title" itemprop="name">
      jupyterhub接入github认证oauth2.0的问题记录与解决
    </h1>
  

        </header>
        
          <!-- <div class="article-entry" itemprop="articleBody">
      
        <p>使用环境：</p>
<ul>
<li>ubuntu18.04</li>
<li>python: 3.6</li>
<li>jupyterhub:1.0.0</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 list | grep jupyter</span><br><span class="line">jupyter-client          5.3.3              </span><br><span class="line">jupyter-core            4.5.0              </span><br><span class="line">jupyterhub              1.0.0</span><br></pre></td></tr></table></figure>

<h1 id="tornado-simple-httpclient-HTTPStreamClosedError-Stream-closed"><a href="#tornado-simple-httpclient-HTTPStreamClosedError-Stream-closed" class="headerlink" title="tornado.simple_httpclient.HTTPStreamClosedError: Stream closed"></a>tornado.simple_httpclient.HTTPStreamClosedError: Stream closed</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 20:43:31.611 JupyterHub oauth2:100] OAuth redirect: &#x27;http://localhost:8000/hub/oauth_callback&#x27;</span><br><span class="line">[I 2019-09-19 20:43:31.615 JupyterHub log:174] 302 GET /hub/oauth_login?next= -&gt; https://github.com/login/oauth/authorize?response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8000%2Fhub%2Foauth_callback&amp;client_id=b65e07b5e5de7471a7f1&amp;state=[secret] (@::1) 4.52ms</span><br><span class="line">[E 2019-09-19 20:43:39.924 JupyterHub web:1788] Uncaught exception GET /hub/oauth_callback?code=f44ca95caf1e0ea417c7&amp;state=eyJzdGF0ZV9pZCI6ICJiNWQ5NTY2ZjJjNWQ0ODMxOTNjYmZiZjcwNTY1Zjc4ZCIsICJuZXh0X3VybCI6ICIifQ%3D%3D (::1)</span><br><span class="line">    HTTPServerRequest(protocol=&#x27;http&#x27;, host=&#x27;localhost:8000&#x27;, method=&#x27;GET&#x27;, uri=&#x27;/hub/oauth_callback?code=f44ca95caf1e0ea417c7&amp;state=eyJzdGF0ZV9pZCI6ICJiNWQ5NTY2ZjJjNWQ0ODMxOTNjYmZiZjcwNTY1Zjc4ZCIsICJuZXh0X3VybCI6ICIifQ%3D%3D&#x27;, version=&#x27;HTTP/1.1&#x27;, remote_ip=&#x27;::1&#x27;)</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/tornado/web.py&quot;, line 1699, in _execute</span><br><span class="line">        result = await result</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/oauthenticator/oauth2.py&quot;, line 207, in get</span><br><span class="line">        user = await self.login_user()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 655, in login_user</span><br><span class="line">        authenticated = await self.authenticate(data)</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/auth.py&quot;, line 383, in get_authenticated_user</span><br><span class="line">        authenticated = await maybe_future(self.authenticate(handler, data))</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/oauthenticator/github.py&quot;, line 115, in authenticate</span><br><span class="line">        resp = await http_client.fetch(req)</span><br><span class="line">    tornado.simple_httpclient.HTTPStreamClosedError: Stream closed</span><br><span class="line">    </span><br><span class="line">[E 2019-09-19 20:43:39.932 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;_ga=[secret]; _xsrf=[secret]; oauthenticator-state=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;cross-site&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 20:43:39.932 JupyterHub log:174] 500 GET /hub/oauth_callback?code=[secret]&amp;state=[secret] (@::1) 902.66ms</span><br></pre></td></tr></table></figure>

<p>看这个issue：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/2448">https://github.com/jupyterhub/jupyterhub/issues/2448</a></p>
<p>卸载tornado 6.x版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 -m pip uninstall tornado</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip/http&#x27; or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">Uninstalling tornado-6.0.3:</span><br><span class="line">  Would remove:</span><br><span class="line">    /usr/local/lib/python3.6/dist-packages/tornado-6.0.3.dist-info/*</span><br><span class="line">    /usr/local/lib/python3.6/dist-packages/tornado/*</span><br><span class="line">Proceed (y/n)? y</span><br><span class="line">  Successfully uninstalled tornado-6.0.3</span><br></pre></td></tr></table></figure>

<p>安装5.1.1版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 -m pip install tornado==5.1.1</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip/http&#x27; or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip&#x27; or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">Collecting tornado==5.1.1</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/e6/78/6e7b5af12c12bdf38ca9bfe863fcaf53dc10430a312d0324e76c1e5ca426/tornado-5.1.1.tar.gz (516kB)</span><br><span class="line">     |████████████████████████████████| 522kB 207kB/s </span><br><span class="line">Building wheels for collected packages: tornado</span><br><span class="line">  Building wheel for tornado (setup.py) ... done</span><br><span class="line">  Created wheel for tornado: filename=tornado-5.1.1-cp36-cp36m-linux_x86_64.whl size=449843 sha256=b4edbb1e0fc62a3492f261537c508c37aa566f5272e5caeb24261c2e047a2e5f</span><br><span class="line">  Stored in directory: /home/jack/.cache/pip/wheels/6d/e1/ce/f4ee2fa420cc6b940123c64992b81047816d0a9fad6b879325</span><br><span class="line">Successfully built tornado</span><br><span class="line">Installing collected packages: tornado</span><br><span class="line">Successfully installed tornado-5.1.1</span><br></pre></td></tr></table></figure>

<p>重启服务后，已经可以登录，但是由于没有将github用户名添加进白名单，因此出现403.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[W 2019-09-19 20:54:40.059 JupyterHub auth:426] User &#x27;jimolonely&#x27; not in whitelist.</span><br><span class="line">[W 2019-09-19 20:54:40.060 JupyterHub base:670] Failed login for unknown user</span><br></pre></td></tr></table></figure>
<p>添加完白名单后。</p>
<p>接着：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=KeyError(&quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;,)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">    await spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 642, in spawn</span><br><span class="line">    raise e</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 546, in spawn</span><br><span class="line">    url = await gen.with_timeout(timedelta(seconds=spawner.start_timeout), f)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1377, in start</span><br><span class="line">    env = self.get_env()</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1326, in get_env</span><br><span class="line">    env = self.user_env(env)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1313, in user_env</span><br><span class="line">    home = pwd.getpwnam(self.user.name).pw_dir</span><br><span class="line">KeyError: &quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;</span><br><span class="line">[E 2019-09-19 20:58:24.051 JupyterHub pages:284] Previous spawn for jimolonely failed: &quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;</span><br><span class="line">[E 2019-09-19 20:58:24.052 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-hub-login=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 20:58:24.052 JupyterHub log:174] 500 GET /hub/spawn-pending/jimolonely (jimolonely@::1) 8.53ms</span><br></pre></td></tr></table></figure>

<p><code>spawn for jimolonely failed: &quot;getpwnam()</code>是给这个用户创建notebook实例时失败。</p>
<p>我们新建本地用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo useradd jimolonely</span><br><span class="line"></span><br><span class="line">$ sudo passwd jimolonely</span><br><span class="line">输入新的 UNIX 密码： </span><br><span class="line">重新输入新的 UNIX 密码： </span><br><span class="line">passwd：已成功更新密码</span><br></pre></td></tr></table></figure>

<p>然后又报错了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=SubprocessError(&#x27;Exception occurred in preexec_fn.&#x27;,)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">    await spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 642, in spawn</span><br><span class="line">    raise e</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 546, in spawn</span><br><span class="line">    url = await gen.with_timeout(timedelta(seconds=spawner.start_timeout), f)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1397, in start</span><br><span class="line">    self.proc = Popen(cmd, **popen_kwargs)</span><br><span class="line">  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 729, in __init__</span><br><span class="line">    restore_signals, start_new_session)</span><br><span class="line">  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 1365, in _execute_child</span><br><span class="line">    raise child_exception_type(err_msg)</span><br><span class="line">subprocess.SubprocessError: Exception occurred in preexec_fn.</span><br><span class="line">[E 2019-09-19 21:01:22.325 JupyterHub pages:284] Previous spawn for jimolonely failed: Exception occurred in preexec_fn.</span><br><span class="line">[E 2019-09-19 21:01:22.325 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-hub-login=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>发现是权限问题，使用sudo运行：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/1527">https://github.com/jupyterhub/jupyterhub/issues/1527</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> $ sudo jupyterhub -f jc.py</span><br><span class="line"> ...</span><br><span class="line"> [E 2019-09-19 21:07:26.114 JupyterHub proxy:658] Failed to find proxy [&#x27;configurable-http-proxy&#x27;]</span><br><span class="line">    The proxy can be installed with `npm install -g configurable-http-proxy`.To install `npm`, install nodejs which includes `npm`.If you see an `EACCES` error or permissions error, refer to the `npm` documentation on How To Prevent Permissions Errors.</span><br><span class="line">[C 2019-09-19 21:07:26.114 JupyterHub app:2349] Failed to start proxy</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/app.py&quot;, line 2347, in start</span><br><span class="line">        await self.proxy.start()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/proxy.py&quot;, line 650, in start</span><br><span class="line">        cmd, env=env, start_new_session=True, shell=shell</span><br><span class="line">      File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 729, in __init__</span><br><span class="line">        restore_signals, start_new_session)</span><br><span class="line">      File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 1364, in _execute_child</span><br><span class="line">        raise child_exception_type(errno_num, err_msg, err_filename)</span><br><span class="line">    FileNotFoundError: [Errno 2] No such file or directory: &#x27;configurable-http-proxy&#x27;: &#x27;configurable-http-proxy&#x27;</span><br></pre></td></tr></table></figure>

<p>有报错，既然找不到，就装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g configurable-http-proxy</span><br><span class="line">/home/jack/.npm-global/bin/configurable-http-proxy -&gt; /home/jack/.npm-global/lib/node_modules/configurable-http-proxy/bin/configurable-http-proxy</span><br><span class="line">/home/jack/.npm-global/lib</span><br><span class="line">└── configurable-http-proxy@4.1.0</span><br></pre></td></tr></table></figure>

<p>最后卡在npm上，虽然可以用sudospawner，但是配起来太麻烦，果断换一条路，使用dockerspawner</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner">https://github.com/jupyterhub/dockerspawner</a></p>
<p>记得先安装dockerspawner:<code>python3 -m pip install dockerspawner</code></p>
<p>然后配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.spawner_class = &#x27;dockerspawner.DockerSpawner&#x27;</span><br></pre></td></tr></table></figure>

<p>重启之后，生成docker容器实例超时：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:35:36.053 JupyterHub dockerspawner:998] Found existing container jupyter-jimolonely (id: 0fbb352)</span><br><span class="line">[I 2019-09-19 21:35:36.053 JupyterHub dockerspawner:1013] Starting container jupyter-jimolonely (id: 0fbb352)</span><br><span class="line">[I 2019-09-19 21:35:36.979 JupyterHub log:174] 302 GET /hub/spawn/jimolonely -&gt; /hub/spawn-pending/jimolonely (jimolonely@::1) 1019.86ms</span><br><span class="line">[I 2019-09-19 21:35:37.018 JupyterHub pages:303] jimolonely is pending spawn</span><br><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=HTTPError()&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">tornado.util.TimeoutError: Timeout</span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 922, in spawn_single_user</span><br><span class="line">    % (status, spawner._log_name),</span><br><span class="line">tornado.web.HTTPError: HTTP 500: Internal Server Error (Spawner failed to start [status=ExitCode=1, Error=&#x27;&#x27;, FinishedAt=2019-09-19T13:35:36.863473516Z]. The logs for jimolonely may contain details.)</span><br><span class="line">[W 2019-09-19 21:36:03.703 JupyterHub user:678] jimolonely&#x27;s server never showed up at http://127.0.0.1:32769/user/jimolonely/ after 30 seconds. Giving up</span><br><span class="line">[E 2019-09-19 21:36:03.747 JupyterHub gen:974] Exception in Future &lt;Task finished coro=&lt;BaseHandler.spawn_single_user.&lt;locals&gt;.finish_user_spawn() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:800&gt; exception=TimeoutError(&quot;Server at http://127.0.0.1:32769/user/jimolonely/ didn&#x27;t respond in 30 seconds&quot;,)&gt; after timeout</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/tornado/gen.py&quot;, line 970, in error_callback</span><br><span class="line">        future.result()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">        await spawn_future</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 654, in spawn</span><br><span class="line">        await self._wait_up(spawner)</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 701, in _wait_up</span><br><span class="line">        raise e</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 669, in _wait_up</span><br><span class="line">        http=True, timeout=spawner.http_timeout, ssl_context=ssl_context</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/utils.py&quot;, line 234, in wait_for_http_server</span><br><span class="line">        timeout=timeout,</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/utils.py&quot;, line 177, in exponential_backoff</span><br><span class="line">        raise TimeoutError(fail_message)</span><br><span class="line">    TimeoutError: Server at http://127.0.0.1:32769/user/jimolonely/ didn&#x27;t respond in 30 seconds</span><br></pre></td></tr></table></figure>

<p>实际上，我在本地能看到docker镜像启动过，但马上就死了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">0fbb3529c1d4        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   5 minutes ago       Exited (1) 2 minutes ago                       jupyter-jimolonely</span><br></pre></td></tr></table></figure>

<p>查看docker日志发现是因为docker容器内没有我们配的目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Executing the command: jupyter notebook --ip=0.0.0.0 --port=8888 --notebook-dir=/home/jack/workspace/temp/notebook/jimolonely</span><br><span class="line">[C 13:43:07.016 NotebookApp] Bad config encountered during initialization:</span><br><span class="line">[C 13:43:07.017 NotebookApp] No such notebook dir: &#x27;&#x27;/home/jack/workspace/temp/notebook/jimolonely&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>于是注释掉关于<code>#c.Spawner.notebook_dir=&#39;/home/jack/workspace/temp/notebook/&#123;username&#125;&#39;</code>的配置, <strong>同时删除旧的实例<code>docker rm ID</code></strong>.</p>
<p>再启动，发现docker容器起来了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                   PORTS                       NAMES</span><br><span class="line">4a45cb7e3cbd        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   7 seconds ago       Up 5 seconds             127.0.0.1:32772-&gt;8888/tcp   jupyter-jimolonely</span><br></pre></td></tr></table></figure>

<p>但是昙花一现，界面报500了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">500 : Internal Server Error</span><br><span class="line">The error was:</span><br><span class="line"></span><br><span class="line">Failed to connect to Hub API at &#x27;http://127.0.0.1:8081/hub/api&#x27;.  Is the Hub accessible at this URL (from host: 4a45cb7e3cbd)?  Make sure to set c.JupyterHub.hub_ip to an IP accessible to single-user servers if the servers are not on the same host as the Hub.</span><br></pre></td></tr></table></figure>
<p>下面是启动成功又被删除的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:44:03.884 JupyterHub pages:303] jimolonely is pending spawn</span><br><span class="line">[I 2019-09-19 21:44:04.417 JupyterHub base:810] User jimolonely took 1.547 seconds to start</span><br><span class="line">[I 2019-09-19 21:44:04.418 JupyterHub proxy:261] Adding user jimolonely to proxy /user/jimolonely/ =&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.424 [ConfigProxy] info: Adding route /user/jimolonely -&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.424 [ConfigProxy] info: Route added /user/jimolonely -&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.425 [ConfigProxy] info: 201 POST /api/routes/user/jimolonely </span><br><span class="line">[I 2019-09-19 21:44:04.427 JupyterHub users:606] Server jimolonely is ready</span><br><span class="line">[I 2019-09-19 21:44:04.429 JupyterHub log:174] 200 GET /hub/api/users/jimolonely/server/progress (jimolonely@::1) 451.21ms</span><br><span class="line">[I 2019-09-19 21:44:06.319 JupyterHub log:174] 302 GET /hub/spawn-pending/jimolonely -&gt; /user/jimolonely/ (jimolonely@::1) 13.14ms</span><br><span class="line">[I 2019-09-19 21:44:06.386 JupyterHub log:174] 302 GET /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] -&gt; /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (jimolonely@::1) 23.41ms</span><br><span class="line">[W 2019-09-19 21:45:03.446 JupyterHub base:962] User jimolonely server stopped, with exit code: ExitCode=1, Error=&#x27;&#x27;, FinishedAt=2019-09-19T13:44:50.187356762Z</span><br><span class="line">[I 2019-09-19 21:45:03.446 JupyterHub proxy:281] Removing user jimolonely from proxy (/user/jimolonely/)</span><br><span class="line">21:45:03.451 [ConfigProxy] info: Removing route /user/jimolonely</span><br></pre></td></tr></table></figure>

<p>依然是看docker日志： 这个原因很明显，不能访问<code>http://127.0.0.1:8081/hub/api</code>，这是hub的API接口，但是在容器里这个<code>127.0.0.1</code>是没有的，需要一个外部的IP，也就是运行容器的主机的IP。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs 4a45cb7e3cbd</span><br><span class="line">Executing the command: jupyterhub-singleuser --ip=0.0.0.0 --port=8888</span><br><span class="line">[W 2019-09-19 13:44:03.777 SingleUserNotebookApp configurable:168] Config option `open_browser` not recognized by `SingleUserNotebookApp`.  Did you mean `browser`?</span><br><span class="line">[I 2019-09-19 13:44:03.989 SingleUserNotebookApp extension:155] JupyterLab extension loaded from /opt/conda/lib/python3.7/site-packages/jupyterlab</span><br><span class="line">[I 2019-09-19 13:44:03.989 SingleUserNotebookApp extension:156] JupyterLab application directory is /opt/conda/share/jupyter/lab</span><br><span class="line">[I 2019-09-19 13:44:03.992 SingleUserNotebookApp singleuser:561] Starting jupyterhub-singleuser server version 1.0.1dev</span><br><span class="line">[E 2019-09-19 13:44:03.994 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 1/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[I 2019-09-19 13:44:04.415 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/ -&gt; /user/jimolonely/tree? (@172.17.0.1) 2.17ms</span><br><span class="line">[E 2019-09-19 13:44:05.999 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 2/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[I 2019-09-19 13:44:06.333 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/ -&gt; /user/jimolonely/tree? (@::1) 1.94ms</span><br><span class="line">[I 2019-09-19 13:44:06.353 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/tree? -&gt; /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] (@::1) 5.01ms</span><br><span class="line">[E 2019-09-19 13:44:06.396 SingleUserNotebookApp auth:334] Error connecting to http://127.0.0.1:8081/hub/api: HTTPConnectionPool(host=&#x27;127.0.0.1&#x27;, port=8081): Max retries exceeded with url: /hub/api/oauth2/token (Caused by NewConnectionError(&#x27;&lt;urllib3.connection.HTTPConnection object at 0x7f22d11f9320&gt;: Failed to establish a new connection: [Errno 111] Connection refused&#x27;))</span><br><span class="line">[W 2019-09-19 13:44:06.396 SingleUserNotebookApp web:1782] 500 GET /user/jimolonely/oauth_callback?code=ugtkAb9qodjKXXkZdJbReF92N2apKR&amp;state=eyJ1dWlkIjogImNmMzE3YTRhZDZkYjRlYjI4ZWNlZjdmY2ZmMjdhNzYxIiwgIm5leHRfdXJsIjogIi91c2VyL2ppbW9sb25lbHkvdHJlZT8ifQ (::1): Failed to connect to Hub API at &#x27;http://127.0.0.1:8081/hub/api&#x27;.  Is the Hub accessible at this URL (from host: 4a45cb7e3cbd)?  Make sure to set c.JupyterHub.hub_ip to an IP accessible to single-user servers if the servers are not on the same host as the Hub.</span><br><span class="line">[E 2019-09-19 13:44:06.427 SingleUserNotebookApp web:2991] Could not open static file &#x27;&#x27;</span><br><span class="line">[E 2019-09-19 13:44:06.428 SingleUserNotebookApp log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-user-jimolonely-oauth-state=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Cache-Control&quot;: &quot;max-age=0&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 13:44:06.428 SingleUserNotebookApp log:174] 500 GET /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (@::1) 35.80ms</span><br><span class="line">[W 2019-09-19 13:44:06.464 SingleUserNotebookApp log:174] 404 GET /user/jimolonely/static/components/react/react-dom.production.min.js (@::1) 3.72ms</span><br><span class="line">[W 2019-09-19 13:44:06.496 SingleUserNotebookApp log:174] 404 GET /user/jimolonely/static/components/react/react-dom.production.min.js (@::1) 1.49ms</span><br><span class="line">[E 2019-09-19 13:44:10.003 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 3/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[E 2019-09-19 13:44:18.015 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 4/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[E 2019-09-19 13:44:34.028 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 5/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br></pre></td></tr></table></figure>

<p>通过github上的示例：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/tree/master/examples/oauth">https://github.com/jupyterhub/dockerspawner/tree/master/examples/oauth</a></p>
<p>这里说得很清楚：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>可以看下<code>public_ips()</code>方法的结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>public_ips()</span><br><span class="line">[<span class="string">&#x27;192.168.199.249&#x27;</span>, <span class="string">&#x27;172.17.0.1&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>于是，我们修改完配置后重启，记得，依然要删除旧的容器实例，再次启动，成功了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:59:12.727 JupyterHub log:174] 200 GET /hub/spawn-pending/jimolonely (jimolonely@::1) 10.11ms</span><br><span class="line">[I 2019-09-19 21:59:12.835 JupyterHub log:174] 200 GET /hub/api (@172.17.0.2) 0.50ms</span><br><span class="line">[I 2019-09-19 21:59:12.866 JupyterHub log:174] 200 POST /hub/api/users/jimolonely/activity (jimolonely@172.17.0.2) 15.00ms</span><br><span class="line">[I 2019-09-19 21:59:13.316 JupyterHub base:810] User jimolonely took 1.607 seconds to start</span><br><span class="line">[I 2019-09-19 21:59:13.317 JupyterHub proxy:261] Adding user jimolonely to proxy /user/jimolonely/ =&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.322 [ConfigProxy] info: Adding route /user/jimolonely -&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.323 [ConfigProxy] info: Route added /user/jimolonely -&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.323 [ConfigProxy] info: 201 POST /api/routes/user/jimolonely </span><br><span class="line">[I 2019-09-19 21:59:13.325 JupyterHub users:606] Server jimolonely is ready</span><br><span class="line">[I 2019-09-19 21:59:13.328 JupyterHub log:174] 200 GET /hub/api/users/jimolonely/server/progress (jimolonely@::1) 486.99ms</span><br><span class="line">[I 2019-09-19 21:59:13.368 JupyterHub log:174] 302 GET /hub/spawn-pending/jimolonely -&gt; /user/jimolonely/ (jimolonely@::1) 16.38ms</span><br><span class="line">[I 2019-09-19 21:59:13.449 JupyterHub log:174] 302 GET /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] -&gt; /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (jimolonely@::1) 40.87ms</span><br><span class="line">[I 2019-09-19 21:59:13.511 JupyterHub log:174] 200 POST /hub/api/oauth2/token (jimolonely@172.17.0.2) 44.80ms</span><br></pre></td></tr></table></figure>

<p>界面正常</p>
<p>通过docker里的日志可以看到：创建文件的目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user/jimolonely/api/contents/test1.ipynb</span><br></pre></td></tr></table></figure>

<h1 id="完整配置"><a href="#完整配置" class="headerlink" title="完整配置"></a>完整配置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c.Spawner.notebook_dir=&#x27;/home/jack/workspace/temp/notebook/&#123;username&#125;&#x27;</span></span><br><span class="line">c.Authenticator.whitelist = &#123;<span class="string">&#x27;hehe&#x27;</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;jimolonely&#x27;</span>&#125;</span><br><span class="line">c.Authenticator.admin_users = &#123;<span class="string">&#x27;hehe&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">c.GitHubOAuthenticator.oauth_callback_url = <span class="string">&#x27;http://localhost:8000/hub/oauth_callback&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_id = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_secret = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用REST-API"><a href="#使用REST-API" class="headerlink" title="使用REST API"></a>使用REST API</h1><p>需要做几步：</p>
<ol>
<li>获取token：</li>
</ol>
<ul>
<li>通过界面</li>
<li>通过命令行: <code>jupyterhub token &lt;username&gt;</code></li>
</ul>
<ol start="2">
<li>配置token到配置文件：  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.api_tokens = &#123;</span><br><span class="line">    <span class="string">&#x27;secret-token&#x27;</span>: <span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 1.token是放在header里的，token前面还有个token标识</span><br><span class="line"># 2.默认API端口是8081，冲突了可以改</span><br><span class="line">curl -X GET -H &quot;Authorization: token &lt;token&gt;&quot; &quot;http://IP:8081/hub/api/users/&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="新增用户"><a href="#新增用户" class="headerlink" title="新增用户"></a>新增用户</h1><ol>
<li>通过jupyter接口增加用户</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/_static/rest-api/index.html">接口文档</a></li>
</ul>
<ol start="2">
<li>再登录</li>
</ol>
<h1 id="动态用户"><a href="#动态用户" class="headerlink" title="动态用户"></a>动态用户</h1><p>如果手动设置了白名单配置，那么只有白名单里的用户可以使用，因此去掉白名单声明，启动时可以看到下面的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-20 09:53:14.707 JupyterHub app:1563] Not using whitelist. Any authenticated user will be allowed.</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以自定义认证器：<br><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/1012">https://github.com/jupyterhub/jupyterhub/issues/1012</a></p>
<h1 id="现在的配置"><a href="#现在的配置" class="headerlink" title="现在的配置"></a>现在的配置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c.Spawner.notebook_dir=&#x27;/home/jack/workspace/temp/notebook/&#123;username&#125;&#x27;</span></span><br><span class="line"><span class="comment"># c.Authenticator.whitelist = &#123;&#x27;hehe&#x27;,&#x27;jack&#x27;,&#x27;jimolonely&#x27;&#125;</span></span><br><span class="line"><span class="comment"># c.Authenticator.admin_users = &#123;&#x27;hehe&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.api_tokens = &#123;</span><br><span class="line">    <span class="string">&#x27;95d7628d65224032857d7d36805f3324&#x27;</span>: <span class="string">&#x27;jimolonely&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.GitHubOAuthenticator.oauth_callback_url = <span class="string">&#x27;http://localhost:8000/hub/oauth_callback&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_id = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_secret = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="自定义认证代码"><a href="#自定义认证代码" class="headerlink" title="自定义认证代码"></a>自定义认证代码</h1><p>我们做一个最简单的认证：如果用户名和密码相同就通过。</p>
<p>整个过程如下：</p>
<ol>
<li>写一个自定义认证器，实现jupyterhub的Authenticator类</li>
<li>安装到本地python库</li>
<li>配置自己的认证器类</li>
</ol>
<h2 id="自定义认证器"><a href="#自定义认证器" class="headerlink" title="自定义认证器"></a>自定义认证器</h2><p>认证器代码结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my-authenticator$ tree</span><br><span class="line">.</span><br><span class="line">├── jauth</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── jauth.py</span><br><span class="line">└── setup.py</span><br></pre></td></tr></table></figure>

<p>jauth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> Authenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JimoAuth</span>(<span class="title class_ inherited__">Authenticator</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, handler, data</span>):</span><br><span class="line">        <span class="built_in">print</span>(handler)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line">        username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        <span class="comment"># check password:</span></span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;username&#x27;</span>] == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<p><code>__init__.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .jauth <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<p>setup.py: 安装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">&#x27;jauth&#x27;</span>,</span><br><span class="line">      version=<span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">      description=<span class="string">&#x27;jimo Authenticator for Jupyterhub&#x27;</span>,</span><br><span class="line">      author=<span class="string">&#x27;jimo&#x27;</span>,</span><br><span class="line">      license=<span class="string">&#x27;MIT&#x27;</span>,</span><br><span class="line">      author_email=<span class="string">&#x27;jimo@163.com&#x27;</span>,</span><br><span class="line">      url=<span class="string">&#x27;https://github.com/jimolonely&#x27;</span>,</span><br><span class="line">      packages=[<span class="string">&#x27;jauth&#x27;</span>],</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>

<h2 id="安装到本地python库"><a href="#安装到本地python库" class="headerlink" title="安装到本地python库"></a>安装到本地python库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">my-authenticator$ sudo python3 setup.py install</span><br><span class="line">[sudo] jack 的密码： </span><br><span class="line">running install</span><br><span class="line">running bdist_egg</span><br><span class="line">running egg_info</span><br><span class="line">creating jauth.egg-info</span><br><span class="line">writing jauth.egg-info/PKG-INFO</span><br><span class="line">writing dependency_links to jauth.egg-info/dependency_links.txt</span><br><span class="line">writing top-level names to jauth.egg-info/top_level.txt</span><br><span class="line">writing manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">reading manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">writing manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">installing library code to build/bdist.linux-x86_64/egg</span><br><span class="line">running install_lib</span><br><span class="line">running build_py</span><br><span class="line">creating build</span><br><span class="line">creating build/lib</span><br><span class="line">creating build/lib/jauth</span><br><span class="line">copying jauth/__init__.py -&gt; build/lib/jauth</span><br><span class="line">copying jauth/jauth.py -&gt; build/lib/jauth</span><br><span class="line">creating build/bdist.linux-x86_64</span><br><span class="line">creating build/bdist.linux-x86_64/egg</span><br><span class="line">creating build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">copying build/lib/jauth/__init__.py -&gt; build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">copying build/lib/jauth/jauth.py -&gt; build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">byte-compiling build/bdist.linux-x86_64/egg/jauth/__init__.py to __init__.cpython-36.pyc</span><br><span class="line">byte-compiling build/bdist.linux-x86_64/egg/jauth/jauth.py to jauth.cpython-36.pyc</span><br><span class="line">creating build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/PKG-INFO -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/SOURCES.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/dependency_links.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/top_level.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">zip_safe flag not set; analyzing archive contents...</span><br><span class="line">creating dist</span><br><span class="line">creating &#x27;dist/jauth-1.0-py3.6.egg&#x27; and adding &#x27;build/bdist.linux-x86_64/egg&#x27; to it</span><br><span class="line">removing &#x27;build/bdist.linux-x86_64/egg&#x27; (and everything under it)</span><br><span class="line">Processing jauth-1.0-py3.6.egg</span><br><span class="line">Copying jauth-1.0-py3.6.egg to /usr/local/lib/python3.6/dist-packages</span><br><span class="line">Adding jauth 1.0 to easy-install.pth file</span><br><span class="line"></span><br><span class="line">Installed /usr/local/lib/python3.6/dist-packages/jauth-1.0-py3.6.egg</span><br><span class="line">Processing dependencies for jauth==1.0</span><br><span class="line">Finished processing dependencies for jauth==1.0</span><br></pre></td></tr></table></figure>

<p>安装完成会生成一些文件，最后能在<code>/usr/local/lib/python3.6/dist-packages</code>下面找到。</p>
<h2 id="配置自己的认证器类"><a href="#配置自己的认证器类" class="headerlink" title="配置自己的认证器类"></a>配置自己的认证器类</h2><p>下面是所有配置：</p>
<p>jc_auth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置认证器类</span></span><br><span class="line"><span class="keyword">from</span> jauth <span class="keyword">import</span> JimoAuth</span><br><span class="line">c.JupyterHub.authenticator_class = JimoAuth</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ jupyterhub -f jc_auth.py</span><br></pre></td></tr></table></figure>

<p>可以看看登录失败和成功的日志：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;jupyterhub.handlers.login.LoginHandler <span class="built_in">object</span> at <span class="number">0x7f421a5b10b8</span>&gt;</span><br><span class="line">&#123;<span class="string">&#x27;next&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;jjjj&#x27;</span>&#125;</span><br><span class="line">[W <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">31.841</span> JupyterHub base:<span class="number">670</span>] Failed login <span class="keyword">for</span> jj</span><br><span class="line">[I <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">31.841</span> JupyterHub log:<span class="number">174</span>] <span class="number">200</span> POST /hub/login?<span class="built_in">next</span>= (@::<span class="number">1</span>) <span class="number">1.61</span>ms</span><br><span class="line">&lt;jupyterhub.handlers.login.LoginHandler <span class="built_in">object</span> at <span class="number">0x7f421ae15208</span>&gt;</span><br><span class="line">&#123;<span class="string">&#x27;next&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>&#125;</span><br><span class="line">[I <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">48.058</span> JupyterHub base:<span class="number">663</span>] User logged <span class="keyword">in</span>: jj</span><br></pre></td></tr></table></figure>

<p>最后docker也运行成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                       NAMES</span><br><span class="line">d3f65881f6c2        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   11 minutes ago      Up 11 minutes       127.0.0.1:32775-&gt;8888/tcp   jupyter-jj</span><br></pre></td></tr></table></figure>

<h1 id="使用JWT验证"><a href="#使用JWT验证" class="headerlink" title="使用JWT验证"></a>使用JWT验证</h1><p>JWT也是官方的一种验证方式：<a target="_blank" rel="noopener" href="https://github.com/mogthesprog/jwtauthenticator">https://github.com/mogthesprog/jwtauthenticator</a></p>
<p>安装完成后，下面是配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jwtauthenticator.jwtauthenticator.JSONWebTokenAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.secret = <span class="string">&#x27;jimo&#x27;</span>            <span class="comment"># The secrect key used to generate the given token</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.username_claim_field = <span class="string">&#x27;username&#x27;</span>                           <span class="comment"># The claim field contianing the username/sAMAccountNAme/userPrincipalName</span></span><br><span class="line">c.JSONWebTokenAuthenticator.expected_audience = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>secret是JWT的秘钥</li>
<li>username_claim_field是JWT里自定定义的用户名的key</li>
</ul>
<p>启动服务后，使用postman验证下：</p>
<p>在header里增加一个Authorization:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ</span><br></pre></td></tr></table></figure>

<p>这个token可以去官方网站生成一个做测试：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a>:</p>
<ul>
<li>填入secret</li>
<li>修改payload，增加<code>username: jimo</code></li>
</ul>
<p>POSTMAN可以成功，但是我们需要在web界面做到，于是随便一个网站，增加带JWT header的请求会出现跨域问题，比如，我写了一个简单的web界面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-sso-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>open jupyterhub<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;http://localhost:8000/hub/login&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title class_">Authorization</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">da</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(da)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS http://localhost:8000/hub/login 405 (Method Not Allowed)</span><br><span class="line">Access to XMLHttpRequest at &#x27;http://localhost:8000/hub/login&#x27; from origin &#x27;null&#x27; has been blocked by CORS policy: Response to preflight request doesn&#x27;t pass access control check: It does not have HTTP ok status.</span><br></pre></td></tr></table></figure>

<p>我尝试过关闭jupyterhub的跨域，然而没有成功。那就只剩下一条路：把他们放在同一个域下。</p>
<p>我使用nginx来做代理，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location ~/(hub|user) &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理到8080端口，包括前端页面和jupyterhub服务器，这里有个问题：就是所有的jupyterhub开头的URI都不能再被我们的应用使用了。</p>
<p>接着可以登录，也可以生成notebook，也能打开，但是连不上websocket：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebSocket connection to &#x27;ws://localhost:8080/user/jimo/api/kernels/750982b7-7696-4f88-9829-79e98c5f9932/channels?session_id=9db4d742f14940c88e643f3eddfa1de4&#x27; failed: Error during WebSocket handshake: Unexpected response code: 504</span><br></pre></td></tr></table></figure>

<p>增加下面的配置可以解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">   default upgrade;</span><br><span class="line">   &#x27;&#x27;      close;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> server &#123;</span><br><span class="line"></span><br><span class="line">   location ~/(hub|user) &#123;</span><br><span class="line"></span><br><span class="line">     proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">     proxy_set_header Connection $connection_upgrade;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以正常写代码运行了，但是有几个API访问是403的，比如：</p>
<ul>
<li>停止服务</li>
<li>请求Token</li>
</ul>
<p>查看后台日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[W 2019-09-22 09:56:43.145 JupyterHub base:60] Blocking Cross Origin API request.  Referer: http://localhost:8080/hub/token, Host: localhost/hub/</span><br><span class="line">[E 2019-09-22 09:56:43.145 JupyterHub users:273] Error authenticating request for /hub/api/users/jimo/tokens: </span><br><span class="line">[W 2019-09-22 09:56:43.146 JupyterHub log:174] 403 POST /hub/api/users/jimo/tokens (@127.0.0.1) 7.12ms</span><br><span class="line"></span><br><span class="line">[W 2019-09-22 09:59:30.636 JupyterHub base:60] Blocking Cross Origin API request.  Referer: http://localhost:8080/hub/home, Host: localhost/hub/</span><br><span class="line">[W 2019-09-22 09:59:30.637 JupyterHub log:174] 403 DELETE /hub/api/users/jimo/server (@127.0.0.1) 10.50ms</span><br></pre></td></tr></table></figure>

<p>看来还是跨域的问题导致的认证失败。</p>
<p>这个问题可以这样解决：（目前没找到更好的方法）：使用80端口，这样jupyterhub就认为是一个域了。</p>
<h2 id="更近一步"><a href="#更近一步" class="headerlink" title="更近一步"></a>更近一步</h2><p>上面的nginx配置依然有问题，因为在集成到我们的应用时，不可能把<code>user, hub</code>等URI剔除，即便可以，也不友好，因此需要给jupyterhub自定义一个前缀URI，这里使用notebook：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.base_url = <span class="string">u&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>相应的nginx配置也得改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">        index index.html;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /notebook &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在关于jupyterhub的一切都在<code>/notebook/</code>下了。</p>
<p>然而，新的问题又来了：docker容器里请求jupyterhub 的API的路径也变了，而docker配置未修改，于是访问时就会出现404：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[E 2019-09-22 03:31:03.980 SingleUserNotebookApp web:2991] Could not open static file &#x27;&#x27;</span><br><span class="line">[W 2019-09-22 03:31:03.981 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/notebook? (@127.0.0.1) 26.89ms</span><br><span class="line">[W 2019-09-22 03:31:04.027 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/static/components/react/react-dom.production.min.js (@127.0.0.1) 3.69ms</span><br><span class="line">[W 2019-09-22 03:31:04.067 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/static/components/react/react-dom.production.min.js (@127.0.0.1) 1.60ms</span><br></pre></td></tr></table></figure>
<p>map $http_upgrade $connection_upgrade {<br>  default upgrade;<br>  ‘’      close;<br>}</p>
<p>于是，继续修改配置，修改docker里访问API的路径，加个前缀：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.hub_prefix = <span class="string">&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后记得删除旧的docker实例，再重新生成就ok了。</p>
<h2 id="完整配置-1"><a href="#完整配置-1" class="headerlink" title="完整配置"></a>完整配置</h2><p>jc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jwtauthenticator.jwtauthenticator.JSONWebTokenAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.secret = <span class="string">&#x27;jimo&#x27;</span>            <span class="comment"># The secrect key used to generate the given token</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.username_claim_field = <span class="string">&#x27;username&#x27;</span>                           <span class="comment"># The claim field contianing the username/sAMAccountNAme/userPrincipalName</span></span><br><span class="line">c.JSONWebTokenAuthenticator.expected_audience = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">origin=<span class="string">&#x27;*&#x27;</span></span><br><span class="line">c.Spawner.args = [<span class="string">f&#x27;--NotebookApp.allow_origin=<span class="subst">&#123;origin&#125;</span>&#x27;</span>]</span><br><span class="line">c.JupyterHub.tornado_settings = &#123;</span><br><span class="line">    <span class="string">&#x27;headers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: origin,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.Authenticator.admin_users = &#123;<span class="string">&#x27;jimo&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">c.JupyterHub.base_url = <span class="string">u&#x27;/notebook&#x27;</span></span><br><span class="line"></span><br><span class="line">c.DockerSpawner.hub_prefix = <span class="string">&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>nginx的 hub.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">  default upgrade;</span><br><span class="line">  &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">        index index.html;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /notebook &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-sso-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>The Great Jupyterhub In Just<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>open jupyterhub<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;/notebook/hub/login&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title class_">Authorization</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">da</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(da)</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;/notebook/hub/home&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="读取cookie认证"><a href="#读取cookie认证" class="headerlink" title="读取cookie认证"></a>读取cookie认证</h1><p>要让jupyterhub读取我们应用的cookie，他们必须处于同一个域下，可以是一个子域名。</p>
<p>经过测试，是可以读取到cookie的，于是怎么验证就是个问题了。</p>
<h1 id="自定义界面"><a href="#自定义界面" class="headerlink" title="自定义界面"></a>自定义界面</h1><p>juopyterhub提供了自定义界面的方式：<a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/templates.html">https://jupyterhub.readthedocs.io/en/stable/reference/templates.html</a></p>
<p>我们只需要遵循以下步骤：</p>
<ol>
<li>选择自定义页面路径: 我选的<code>/home/jimo/jwt_auth/pages</code></li>
<li>修改hub配置，指定自定义路径： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.template_paths=[<span class="string">&#x27;/home/jimo/jwt_auth/pages&#x27;</span>]</span><br></pre></td></tr></table></figure></li>
<li>参考<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/share/jupyterhub/templates">源码页面</a>，修改为自己想要的样子</li>
</ol>
<p>一般我们修改页面只是做一些logo、汉化等。</p>
<p>比如：截断很长的用户名，使用<a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.10.x/templates/#truncate">jinja的过滤器语法的truncate方法</a>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;navbar-text&quot;</span>&gt;</span>&#123;&#123;user.name | truncate(length=5)&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h1 id="自定义notebook镜像"><a href="#自定义notebook镜像" class="headerlink" title="自定义notebook镜像"></a>自定义notebook镜像</h1><h2 id="明白原生镜像"><a href="#明白原生镜像" class="headerlink" title="明白原生镜像"></a>明白原生镜像</h2><p>原生镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/jupyterhub/singleuser/dockerfile">https://hub.docker.com/r/jupyterhub/singleuser/dockerfile</a></p>
<p>查看其dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Build as jupyterhub/singleuser</span><br><span class="line"># Run with the DockerSpawner in JupyterHub</span><br><span class="line"></span><br><span class="line">ARG BASE_IMAGE=jupyter/base-notebook</span><br><span class="line">FROM $BASE_IMAGE</span><br><span class="line">MAINTAINER Project Jupyter &lt;jupyter@googlegroups.com&gt;</span><br><span class="line"></span><br><span class="line">ADD install_jupyterhub /tmp/install_jupyterhub</span><br><span class="line">ARG JUPYTERHUB_VERSION=master</span><br><span class="line"># install pinned jupyterhub and ensure notebook is installed</span><br><span class="line">RUN python3 /tmp/install_jupyterhub &amp;&amp; \</span><br><span class="line">    python3 -m pip install notebook</span><br></pre></td></tr></table></figure>

<h3 id="base镜像"><a href="#base镜像" class="headerlink" title="base镜像"></a>base镜像</h3><p>首先找到其base镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/jupyter/base-notebook/dockerfile">jupyter&#x2F;base-notebook </a></p>
<p>里面主要做的就是打包jupyter的notebook，暂时不研究。</p>
<p>注意：其使用conda安装python的。</p>
<h3 id="install-jupyterhub"><a href="#install-jupyterhub" class="headerlink" title="install_jupyterhub"></a>install_jupyterhub</h3><p>显然，这是一个本地文件，我们找到github上的源码：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/singleuser">https://github.com/jupyterhub/jupyterhub/tree/master/singleuser</a></p>
<p>install_jupyterhub是一个没有后缀的python文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_call</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">V = os.environ[<span class="string">&#x27;JUPYTERHUB_VERSION&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pip_install = [</span><br><span class="line">    sys.executable, <span class="string">&#x27;-m&#x27;</span>, <span class="string">&#x27;pip&#x27;</span>, <span class="string">&#x27;install&#x27;</span>, <span class="string">&#x27;--no-cache&#x27;</span>, <span class="string">&#x27;--upgrade&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;--upgrade-strategy&#x27;</span>, <span class="string">&#x27;only-if-needed&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="keyword">if</span> V == <span class="string">&#x27;master&#x27;</span>:</span><br><span class="line">    req = <span class="string">&#x27;https://github.com/jupyterhub/jupyterhub/archive/master.tar.gz&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    version_info = [ <span class="built_in">int</span>(part) <span class="keyword">for</span> part <span class="keyword">in</span> V.split(<span class="string">&#x27;.&#x27;</span>) ]</span><br><span class="line">    version_info[-<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    upper_bound = <span class="string">&#x27;.&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, version_info))</span><br><span class="line">    vs = <span class="string">&#x27;&gt;=%s,&lt;%s&#x27;</span> % (V, upper_bound)</span><br><span class="line">    req = <span class="string">&#x27;jupyterhub%s&#x27;</span> % vs</span><br><span class="line"></span><br><span class="line">check_call(pip_install + [req])</span><br></pre></td></tr></table></figure>

<p>脚本很好懂，就是从github下载源码安装，所以不需要关心这一步。</p>
<h2 id="修改镜像"><a href="#修改镜像" class="headerlink" title="修改镜像"></a>修改镜像</h2><p>根据我们的需求修改：</p>
<ul>
<li>安装相应的包</li>
<li>修改内核代码</li>
</ul>
<p>由于咱们需要更改python内核代码增加一些magic函数，所以需要修改docker镜像里的python代码。</p>
<p>找到python对应的版本：看起来都是用的python3.7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/conda/bin$</span><br><span class="line">lrwxrwxrwx 1 jovyan users        9 Aug  3 03:26 python -&gt; python3.7*</span><br><span class="line">lrwxrwxrwx 1 jovyan users        9 Aug  3 03:26 python3 -&gt; python3.7*</span><br></pre></td></tr></table></figure>

<p>确定我们要改的包的路径：<code>/opt/conda/lib/python3.7/site-packages/IPython</code></p>
<p>由于修改镜像涉及到保密信息，大家根据自己情况修改，确保最后build成功。</p>
<h2 id="指定自己的镜像"><a href="#指定自己的镜像" class="headerlink" title="指定自己的镜像"></a>指定自己的镜像</h2><p>修改hub的配置，指向我们自己的镜像：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.image = <span class="string">&#x27;test/docker-notebook:v2&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>使用docker的一个点是：数据默认是存在docker里的，用于生产时肯定需要持久化到外部存储里。</p>
<p>目前没有云存储，暂时映射到本机上的一个目录：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.volumes = &#123;<span class="string">&#x27;/mnt/docker/data/hub-data-&#123;username&#125;&#x27;</span>:<span class="string">&#x27;/home/jovyan&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>前面是本机目录，后面是容器内用户的工作空间。</p>
<p><strong>非常重要：确保docker对本机目录有读写权限，最简单的做法：chmod 777 -R &#x2F;mnt&#x2F;docker&#x2F;data</strong></p>
<p>否则会出现权限问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  File <span class="string">&quot;/opt/conda/lib/python3.7/os.py&quot;</span>, line <span class="number">221</span>, <span class="keyword">in</span> makedirs</span><br><span class="line">    mkdir(name, mode)</span><br><span class="line">PermissionError: [Errno <span class="number">13</span>] Permission denied: <span class="string">&#x27;/home/jovyan/.local&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Permission-denied-‘-x2F-home-x2F-jovyan-x2F-local’"><a href="#Permission-denied-‘-x2F-home-x2F-jovyan-x2F-local’" class="headerlink" title="Permission denied: ‘&#x2F;home&#x2F;jovyan&#x2F;.local’"></a>Permission denied: ‘&#x2F;home&#x2F;jovyan&#x2F;.local’</h2><p>然而，上述做法是需要手动操作的，就是新增的用户没办法在宿主机上创建文件，因为没有写的权限。</p>
<p>关于这个问题，可以在<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/issues/160">github issue</a>里找到：</p>
<blockquote>
<p>这是一个常见的Docker问题，在创建docker实例时挂在外部不存在的目录卷时。 这是Docker的一个长期困扰 使用容器内部卷时就不是问题，这就是为什么要偏向使用它的部分原因。</p>
</blockquote>
<p>既然是docker的问题，那么就只有走偏方了：能不能在启动容器前就把外部目录的权限分配好？</p>
<p>还真可以，而且是官方操作：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/examples/bootstrap-script">bootstrap-script</a></p>
<p>启动脚本：可以在启动notebook实例前干一些事情，想干什么范围就很广了。</p>
<p>比如，我们创建目录并分配权限：在jupyterhub_config.py里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_dir_hook</span>(<span class="params">spawner</span>):</span><br><span class="line">    username = spawner.user.name <span class="comment"># get the username</span></span><br><span class="line">    volume_path = os.path.join(<span class="string">&#x27;/home/jimo/jwt_auth&#x27;</span>, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(volume_path):</span><br><span class="line">        <span class="comment"># create a directory with umask 0777</span></span><br><span class="line">        <span class="comment"># hub and container user must have the same UID to be writeable</span></span><br><span class="line">        <span class="comment"># still readable by other users on the system</span></span><br><span class="line">        os.mkdir(volume_path, <span class="number">0o777</span>)</span><br><span class="line">        <span class="comment"># now do whatever you think your user needs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># attach the hook function to the spawner</span></span><br><span class="line">c.Spawner.pre_spawn_hook = create_dir_hook</span><br></pre></td></tr></table></figure>

<h2 id="关于docker网络"><a href="#关于docker网络" class="headerlink" title="关于docker网络"></a>关于docker网络</h2><p>集成了自己的东西到notebook里，notebook又在docker里，而自己的东西需要与外部网络通信。</p>
<h2 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.Spawner.mem_limit = <span class="string">&#x27;500M&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h2><h3 id="离线打包python环境"><a href="#离线打包python环境" class="headerlink" title="离线打包python环境"></a>离线打包python环境</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/vevenlcf/article/details/83110204">https://blog.csdn.net/vevenlcf/article/details/83110204</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3.7 -m pip freeze &gt; hub_req.txt</span><br><span class="line"></span><br><span class="line">python3.7 -m pip download -r hub_req.txt -d ./pkgs/</span><br><span class="line"></span><br><span class="line">tar -czf pkgs.tar.gz pkgs/</span><br></pre></td></tr></table></figure>

<h3 id="离线打包docker镜像"><a href="#离线打包docker镜像" class="headerlink" title="离线打包docker镜像"></a>离线打包docker镜像</h3><p>打包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker save -o just-docker-notebook.tar just/docker-notebook:v2</span><br><span class="line"># 再压缩下</span><br><span class="line">tar -czf just-docker-notebook.tar.gz just-docker-notebook.tar</span><br></pre></td></tr></table></figure>

<p>导入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; just-docker-notebook.tar</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h1 id="释放不活动用户资源"><a href="#释放不活动用户资源" class="headerlink" title="释放不活动用户资源"></a>释放不活动用户资源</h1><p>按照默认情况，用户启动之后，notebook的docker容器会一直运行，这样其实很占资源，对于不活动用户的资源，需要在一定时间后清理。</p>
<p>我们通过增加一个服务：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/examples/cull-idle">https://github.com/jupyterhub/jupyterhub/tree/master/examples/cull-idle</a></p>
<ol>
<li>把项目中的cull_idle_servers.py脚本弄下来</li>
<li>在配置文件中配置服务：这里是3600秒 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.services = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cull-idle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;admin&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;command&#x27;</span>: [sys.executable, <span class="string">&#x27;cull_idle_servers.py&#x27;</span>, <span class="string">&#x27;--timeout=3600&#x27;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
</ol>
<p>其实这个cull_idle_servers.py是通过轮询的方式来做的，自己也可以写一个。</p>

      
    </div> -->
          <div class="article-entry" itemprop="articleBody">
            
              
                                                
                                                    
                                                      
                                                        <p>使用环境：</p>
<ul>
<li>ubuntu18.04</li>
<li>python: 3.6</li>
<li>jupyterhub:1.0.0</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pip3 list | grep jupyter</span><br><span class="line">jupyter-client          5.3.3              </span><br><span class="line">jupyter-core            4.5.0              </span><br><span class="line">jupyterhub              1.0.0</span><br></pre></td></tr></table></figure>

<h1 id="tornado-simple-httpclient-HTTPStreamClosedError-Stream-closed"><a href="#tornado-simple-httpclient-HTTPStreamClosedError-Stream-closed" class="headerlink" title="tornado.simple_httpclient.HTTPStreamClosedError: Stream closed"></a>tornado.simple_httpclient.HTTPStreamClosedError: Stream closed</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 20:43:31.611 JupyterHub oauth2:100] OAuth redirect: &#x27;http://localhost:8000/hub/oauth_callback&#x27;</span><br><span class="line">[I 2019-09-19 20:43:31.615 JupyterHub log:174] 302 GET /hub/oauth_login?next= -&gt; https://github.com/login/oauth/authorize?response_type=code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A8000%2Fhub%2Foauth_callback&amp;client_id=b65e07b5e5de7471a7f1&amp;state=[secret] (@::1) 4.52ms</span><br><span class="line">[E 2019-09-19 20:43:39.924 JupyterHub web:1788] Uncaught exception GET /hub/oauth_callback?code=f44ca95caf1e0ea417c7&amp;state=eyJzdGF0ZV9pZCI6ICJiNWQ5NTY2ZjJjNWQ0ODMxOTNjYmZiZjcwNTY1Zjc4ZCIsICJuZXh0X3VybCI6ICIifQ%3D%3D (::1)</span><br><span class="line">    HTTPServerRequest(protocol=&#x27;http&#x27;, host=&#x27;localhost:8000&#x27;, method=&#x27;GET&#x27;, uri=&#x27;/hub/oauth_callback?code=f44ca95caf1e0ea417c7&amp;state=eyJzdGF0ZV9pZCI6ICJiNWQ5NTY2ZjJjNWQ0ODMxOTNjYmZiZjcwNTY1Zjc4ZCIsICJuZXh0X3VybCI6ICIifQ%3D%3D&#x27;, version=&#x27;HTTP/1.1&#x27;, remote_ip=&#x27;::1&#x27;)</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/tornado/web.py&quot;, line 1699, in _execute</span><br><span class="line">        result = await result</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/oauthenticator/oauth2.py&quot;, line 207, in get</span><br><span class="line">        user = await self.login_user()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 655, in login_user</span><br><span class="line">        authenticated = await self.authenticate(data)</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/auth.py&quot;, line 383, in get_authenticated_user</span><br><span class="line">        authenticated = await maybe_future(self.authenticate(handler, data))</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/oauthenticator/github.py&quot;, line 115, in authenticate</span><br><span class="line">        resp = await http_client.fetch(req)</span><br><span class="line">    tornado.simple_httpclient.HTTPStreamClosedError: Stream closed</span><br><span class="line">    </span><br><span class="line">[E 2019-09-19 20:43:39.932 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;_ga=[secret]; _xsrf=[secret]; oauthenticator-state=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;cross-site&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 20:43:39.932 JupyterHub log:174] 500 GET /hub/oauth_callback?code=[secret]&amp;state=[secret] (@::1) 902.66ms</span><br></pre></td></tr></table></figure>

<p>看这个issue：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/2448">https://github.com/jupyterhub/jupyterhub/issues/2448</a></p>
<p>卸载tornado 6.x版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 -m pip uninstall tornado</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip/http&#x27; or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">Uninstalling tornado-6.0.3:</span><br><span class="line">  Would remove:</span><br><span class="line">    /usr/local/lib/python3.6/dist-packages/tornado-6.0.3.dist-info/*</span><br><span class="line">    /usr/local/lib/python3.6/dist-packages/tornado/*</span><br><span class="line">Proceed (y/n)? y</span><br><span class="line">  Successfully uninstalled tornado-6.0.3</span><br></pre></td></tr></table></figure>

<p>安装5.1.1版本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sudo python3 -m pip install tornado==5.1.1</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip/http&#x27; or its parent directory is not owned by the current user and the cache has been disabled. Please check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">WARNING: The directory &#x27;/home/jack/.cache/pip&#x27; or its parent directory is not owned by the current user and caching wheels has been disabled. check the permissions and owner of that directory. If executing pip with sudo, you may want sudo&#x27;s -H flag.</span><br><span class="line">Collecting tornado==5.1.1</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/e6/78/6e7b5af12c12bdf38ca9bfe863fcaf53dc10430a312d0324e76c1e5ca426/tornado-5.1.1.tar.gz (516kB)</span><br><span class="line">     |████████████████████████████████| 522kB 207kB/s </span><br><span class="line">Building wheels for collected packages: tornado</span><br><span class="line">  Building wheel for tornado (setup.py) ... done</span><br><span class="line">  Created wheel for tornado: filename=tornado-5.1.1-cp36-cp36m-linux_x86_64.whl size=449843 sha256=b4edbb1e0fc62a3492f261537c508c37aa566f5272e5caeb24261c2e047a2e5f</span><br><span class="line">  Stored in directory: /home/jack/.cache/pip/wheels/6d/e1/ce/f4ee2fa420cc6b940123c64992b81047816d0a9fad6b879325</span><br><span class="line">Successfully built tornado</span><br><span class="line">Installing collected packages: tornado</span><br><span class="line">Successfully installed tornado-5.1.1</span><br></pre></td></tr></table></figure>

<p>重启服务后，已经可以登录，但是由于没有将github用户名添加进白名单，因此出现403.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[W 2019-09-19 20:54:40.059 JupyterHub auth:426] User &#x27;jimolonely&#x27; not in whitelist.</span><br><span class="line">[W 2019-09-19 20:54:40.060 JupyterHub base:670] Failed login for unknown user</span><br></pre></td></tr></table></figure>
<p>添加完白名单后。</p>
<p>接着：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=KeyError(&quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;,)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">    await spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 642, in spawn</span><br><span class="line">    raise e</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 546, in spawn</span><br><span class="line">    url = await gen.with_timeout(timedelta(seconds=spawner.start_timeout), f)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1377, in start</span><br><span class="line">    env = self.get_env()</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1326, in get_env</span><br><span class="line">    env = self.user_env(env)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1313, in user_env</span><br><span class="line">    home = pwd.getpwnam(self.user.name).pw_dir</span><br><span class="line">KeyError: &quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;</span><br><span class="line">[E 2019-09-19 20:58:24.051 JupyterHub pages:284] Previous spawn for jimolonely failed: &quot;getpwnam(): name not found: &#x27;jimolonely&#x27;&quot;</span><br><span class="line">[E 2019-09-19 20:58:24.052 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-hub-login=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 20:58:24.052 JupyterHub log:174] 500 GET /hub/spawn-pending/jimolonely (jimolonely@::1) 8.53ms</span><br></pre></td></tr></table></figure>

<p><code>spawn for jimolonely failed: &quot;getpwnam()</code>是给这个用户创建notebook实例时失败。</p>
<p>我们新建本地用户：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo useradd jimolonely</span><br><span class="line"></span><br><span class="line">$ sudo passwd jimolonely</span><br><span class="line">输入新的 UNIX 密码： </span><br><span class="line">重新输入新的 UNIX 密码： </span><br><span class="line">passwd：已成功更新密码</span><br></pre></td></tr></table></figure>

<p>然后又报错了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=SubprocessError(&#x27;Exception occurred in preexec_fn.&#x27;,)&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">    await spawn_future</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 642, in spawn</span><br><span class="line">    raise e</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 546, in spawn</span><br><span class="line">    url = await gen.with_timeout(timedelta(seconds=spawner.start_timeout), f)</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/spawner.py&quot;, line 1397, in start</span><br><span class="line">    self.proc = Popen(cmd, **popen_kwargs)</span><br><span class="line">  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 729, in __init__</span><br><span class="line">    restore_signals, start_new_session)</span><br><span class="line">  File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 1365, in _execute_child</span><br><span class="line">    raise child_exception_type(err_msg)</span><br><span class="line">subprocess.SubprocessError: Exception occurred in preexec_fn.</span><br><span class="line">[E 2019-09-19 21:01:22.325 JupyterHub pages:284] Previous spawn for jimolonely failed: Exception occurred in preexec_fn.</span><br><span class="line">[E 2019-09-19 21:01:22.325 JupyterHub log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-hub-login=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-User&quot;: &quot;?1&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>发现是权限问题，使用sudo运行：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/1527">https://github.com/jupyterhub/jupyterhub/issues/1527</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"> $ sudo jupyterhub -f jc.py</span><br><span class="line"> ...</span><br><span class="line"> [E 2019-09-19 21:07:26.114 JupyterHub proxy:658] Failed to find proxy [&#x27;configurable-http-proxy&#x27;]</span><br><span class="line">    The proxy can be installed with `npm install -g configurable-http-proxy`.To install `npm`, install nodejs which includes `npm`.If you see an `EACCES` error or permissions error, refer to the `npm` documentation on How To Prevent Permissions Errors.</span><br><span class="line">[C 2019-09-19 21:07:26.114 JupyterHub app:2349] Failed to start proxy</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/app.py&quot;, line 2347, in start</span><br><span class="line">        await self.proxy.start()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/proxy.py&quot;, line 650, in start</span><br><span class="line">        cmd, env=env, start_new_session=True, shell=shell</span><br><span class="line">      File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 729, in __init__</span><br><span class="line">        restore_signals, start_new_session)</span><br><span class="line">      File &quot;/usr/lib/python3.6/subprocess.py&quot;, line 1364, in _execute_child</span><br><span class="line">        raise child_exception_type(errno_num, err_msg, err_filename)</span><br><span class="line">    FileNotFoundError: [Errno 2] No such file or directory: &#x27;configurable-http-proxy&#x27;: &#x27;configurable-http-proxy&#x27;</span><br></pre></td></tr></table></figure>

<p>有报错，既然找不到，就装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo npm install -g configurable-http-proxy</span><br><span class="line">/home/jack/.npm-global/bin/configurable-http-proxy -&gt; /home/jack/.npm-global/lib/node_modules/configurable-http-proxy/bin/configurable-http-proxy</span><br><span class="line">/home/jack/.npm-global/lib</span><br><span class="line">└── configurable-http-proxy@4.1.0</span><br></pre></td></tr></table></figure>

<p>最后卡在npm上，虽然可以用sudospawner，但是配起来太麻烦，果断换一条路，使用dockerspawner</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner">https://github.com/jupyterhub/dockerspawner</a></p>
<p>记得先安装dockerspawner:<code>python3 -m pip install dockerspawner</code></p>
<p>然后配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.spawner_class = &#x27;dockerspawner.DockerSpawner&#x27;</span><br></pre></td></tr></table></figure>

<p>重启之后，生成docker容器实例超时：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:35:36.053 JupyterHub dockerspawner:998] Found existing container jupyter-jimolonely (id: 0fbb352)</span><br><span class="line">[I 2019-09-19 21:35:36.053 JupyterHub dockerspawner:1013] Starting container jupyter-jimolonely (id: 0fbb352)</span><br><span class="line">[I 2019-09-19 21:35:36.979 JupyterHub log:174] 302 GET /hub/spawn/jimolonely -&gt; /hub/spawn-pending/jimolonely (jimolonely@::1) 1019.86ms</span><br><span class="line">[I 2019-09-19 21:35:37.018 JupyterHub pages:303] jimolonely is pending spawn</span><br><span class="line">ERROR:asyncio:Task exception was never retrieved</span><br><span class="line">future: &lt;Task finished coro=&lt;BaseHandler.spawn_single_user() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:697&gt; exception=HTTPError()&gt;</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 889, in spawn_single_user</span><br><span class="line">    timedelta(seconds=self.slow_spawn_timeout), finish_spawn_future</span><br><span class="line">tornado.util.TimeoutError: Timeout</span><br><span class="line"></span><br><span class="line">During handling of the above exception, another exception occurred:</span><br><span class="line"></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 922, in spawn_single_user</span><br><span class="line">    % (status, spawner._log_name),</span><br><span class="line">tornado.web.HTTPError: HTTP 500: Internal Server Error (Spawner failed to start [status=ExitCode=1, Error=&#x27;&#x27;, FinishedAt=2019-09-19T13:35:36.863473516Z]. The logs for jimolonely may contain details.)</span><br><span class="line">[W 2019-09-19 21:36:03.703 JupyterHub user:678] jimolonely&#x27;s server never showed up at http://127.0.0.1:32769/user/jimolonely/ after 30 seconds. Giving up</span><br><span class="line">[E 2019-09-19 21:36:03.747 JupyterHub gen:974] Exception in Future &lt;Task finished coro=&lt;BaseHandler.spawn_single_user.&lt;locals&gt;.finish_user_spawn() done, defined at /usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py:800&gt; exception=TimeoutError(&quot;Server at http://127.0.0.1:32769/user/jimolonely/ didn&#x27;t respond in 30 seconds&quot;,)&gt; after timeout</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/tornado/gen.py&quot;, line 970, in error_callback</span><br><span class="line">        future.result()</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/handlers/base.py&quot;, line 807, in finish_user_spawn</span><br><span class="line">        await spawn_future</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 654, in spawn</span><br><span class="line">        await self._wait_up(spawner)</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 701, in _wait_up</span><br><span class="line">        raise e</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/user.py&quot;, line 669, in _wait_up</span><br><span class="line">        http=True, timeout=spawner.http_timeout, ssl_context=ssl_context</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/utils.py&quot;, line 234, in wait_for_http_server</span><br><span class="line">        timeout=timeout,</span><br><span class="line">      File &quot;/usr/local/lib/python3.6/dist-packages/jupyterhub/utils.py&quot;, line 177, in exponential_backoff</span><br><span class="line">        raise TimeoutError(fail_message)</span><br><span class="line">    TimeoutError: Server at http://127.0.0.1:32769/user/jimolonely/ didn&#x27;t respond in 30 seconds</span><br></pre></td></tr></table></figure>

<p>实际上，我在本地能看到docker镜像启动过，但马上就死了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                     PORTS               NAMES</span><br><span class="line">0fbb3529c1d4        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   5 minutes ago       Exited (1) 2 minutes ago                       jupyter-jimolonely</span><br></pre></td></tr></table></figure>

<p>查看docker日志发现是因为docker容器内没有我们配的目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Executing the command: jupyter notebook --ip=0.0.0.0 --port=8888 --notebook-dir=/home/jack/workspace/temp/notebook/jimolonely</span><br><span class="line">[C 13:43:07.016 NotebookApp] Bad config encountered during initialization:</span><br><span class="line">[C 13:43:07.017 NotebookApp] No such notebook dir: &#x27;&#x27;/home/jack/workspace/temp/notebook/jimolonely&#x27;&#x27;</span><br></pre></td></tr></table></figure>

<p>于是注释掉关于<code>#c.Spawner.notebook_dir=&#39;/home/jack/workspace/temp/notebook/&#123;username&#125;&#39;</code>的配置, <strong>同时删除旧的实例<code>docker rm ID</code></strong>.</p>
<p>再启动，发现docker容器起来了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS                   PORTS                       NAMES</span><br><span class="line">4a45cb7e3cbd        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   7 seconds ago       Up 5 seconds             127.0.0.1:32772-&gt;8888/tcp   jupyter-jimolonely</span><br></pre></td></tr></table></figure>

<p>但是昙花一现，界面报500了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">500 : Internal Server Error</span><br><span class="line">The error was:</span><br><span class="line"></span><br><span class="line">Failed to connect to Hub API at &#x27;http://127.0.0.1:8081/hub/api&#x27;.  Is the Hub accessible at this URL (from host: 4a45cb7e3cbd)?  Make sure to set c.JupyterHub.hub_ip to an IP accessible to single-user servers if the servers are not on the same host as the Hub.</span><br></pre></td></tr></table></figure>
<p>下面是启动成功又被删除的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:44:03.884 JupyterHub pages:303] jimolonely is pending spawn</span><br><span class="line">[I 2019-09-19 21:44:04.417 JupyterHub base:810] User jimolonely took 1.547 seconds to start</span><br><span class="line">[I 2019-09-19 21:44:04.418 JupyterHub proxy:261] Adding user jimolonely to proxy /user/jimolonely/ =&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.424 [ConfigProxy] info: Adding route /user/jimolonely -&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.424 [ConfigProxy] info: Route added /user/jimolonely -&gt; http://127.0.0.1:32772</span><br><span class="line">21:44:04.425 [ConfigProxy] info: 201 POST /api/routes/user/jimolonely </span><br><span class="line">[I 2019-09-19 21:44:04.427 JupyterHub users:606] Server jimolonely is ready</span><br><span class="line">[I 2019-09-19 21:44:04.429 JupyterHub log:174] 200 GET /hub/api/users/jimolonely/server/progress (jimolonely@::1) 451.21ms</span><br><span class="line">[I 2019-09-19 21:44:06.319 JupyterHub log:174] 302 GET /hub/spawn-pending/jimolonely -&gt; /user/jimolonely/ (jimolonely@::1) 13.14ms</span><br><span class="line">[I 2019-09-19 21:44:06.386 JupyterHub log:174] 302 GET /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] -&gt; /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (jimolonely@::1) 23.41ms</span><br><span class="line">[W 2019-09-19 21:45:03.446 JupyterHub base:962] User jimolonely server stopped, with exit code: ExitCode=1, Error=&#x27;&#x27;, FinishedAt=2019-09-19T13:44:50.187356762Z</span><br><span class="line">[I 2019-09-19 21:45:03.446 JupyterHub proxy:281] Removing user jimolonely from proxy (/user/jimolonely/)</span><br><span class="line">21:45:03.451 [ConfigProxy] info: Removing route /user/jimolonely</span><br></pre></td></tr></table></figure>

<p>依然是看docker日志： 这个原因很明显，不能访问<code>http://127.0.0.1:8081/hub/api</code>，这是hub的API接口，但是在容器里这个<code>127.0.0.1</code>是没有的，需要一个外部的IP，也就是运行容器的主机的IP。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">$ docker logs 4a45cb7e3cbd</span><br><span class="line">Executing the command: jupyterhub-singleuser --ip=0.0.0.0 --port=8888</span><br><span class="line">[W 2019-09-19 13:44:03.777 SingleUserNotebookApp configurable:168] Config option `open_browser` not recognized by `SingleUserNotebookApp`.  Did you mean `browser`?</span><br><span class="line">[I 2019-09-19 13:44:03.989 SingleUserNotebookApp extension:155] JupyterLab extension loaded from /opt/conda/lib/python3.7/site-packages/jupyterlab</span><br><span class="line">[I 2019-09-19 13:44:03.989 SingleUserNotebookApp extension:156] JupyterLab application directory is /opt/conda/share/jupyter/lab</span><br><span class="line">[I 2019-09-19 13:44:03.992 SingleUserNotebookApp singleuser:561] Starting jupyterhub-singleuser server version 1.0.1dev</span><br><span class="line">[E 2019-09-19 13:44:03.994 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 1/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[I 2019-09-19 13:44:04.415 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/ -&gt; /user/jimolonely/tree? (@172.17.0.1) 2.17ms</span><br><span class="line">[E 2019-09-19 13:44:05.999 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 2/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[I 2019-09-19 13:44:06.333 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/ -&gt; /user/jimolonely/tree? (@::1) 1.94ms</span><br><span class="line">[I 2019-09-19 13:44:06.353 SingleUserNotebookApp log:174] 302 GET /user/jimolonely/tree? -&gt; /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] (@::1) 5.01ms</span><br><span class="line">[E 2019-09-19 13:44:06.396 SingleUserNotebookApp auth:334] Error connecting to http://127.0.0.1:8081/hub/api: HTTPConnectionPool(host=&#x27;127.0.0.1&#x27;, port=8081): Max retries exceeded with url: /hub/api/oauth2/token (Caused by NewConnectionError(&#x27;&lt;urllib3.connection.HTTPConnection object at 0x7f22d11f9320&gt;: Failed to establish a new connection: [Errno 111] Connection refused&#x27;))</span><br><span class="line">[W 2019-09-19 13:44:06.396 SingleUserNotebookApp web:1782] 500 GET /user/jimolonely/oauth_callback?code=ugtkAb9qodjKXXkZdJbReF92N2apKR&amp;state=eyJ1dWlkIjogImNmMzE3YTRhZDZkYjRlYjI4ZWNlZjdmY2ZmMjdhNzYxIiwgIm5leHRfdXJsIjogIi91c2VyL2ppbW9sb25lbHkvdHJlZT8ifQ (::1): Failed to connect to Hub API at &#x27;http://127.0.0.1:8081/hub/api&#x27;.  Is the Hub accessible at this URL (from host: 4a45cb7e3cbd)?  Make sure to set c.JupyterHub.hub_ip to an IP accessible to single-user servers if the servers are not on the same host as the Hub.</span><br><span class="line">[E 2019-09-19 13:44:06.427 SingleUserNotebookApp web:2991] Could not open static file &#x27;&#x27;</span><br><span class="line">[E 2019-09-19 13:44:06.428 SingleUserNotebookApp log:166] &#123;</span><br><span class="line">      &quot;X-Forwarded-Host&quot;: &quot;localhost:8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-Proto&quot;: &quot;http&quot;,</span><br><span class="line">      &quot;X-Forwarded-Port&quot;: &quot;8000&quot;,</span><br><span class="line">      &quot;X-Forwarded-For&quot;: &quot;::1&quot;,</span><br><span class="line">      &quot;Cookie&quot;: &quot;jupyterhub-user-jimolonely-oauth-state=[secret]; _ga=[secret]; _xsrf=[secret]; jupyterhub-session-id=[secret]&quot;,</span><br><span class="line">      &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;,</span><br><span class="line">      &quot;Accept-Encoding&quot;: &quot;gzip, deflate, br&quot;,</span><br><span class="line">      &quot;Referer&quot;: &quot;http://localhost:8000/hub/spawn-pending/jimolonely&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Site&quot;: &quot;same-origin&quot;,</span><br><span class="line">      &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3&quot;,</span><br><span class="line">      &quot;Sec-Fetch-Mode&quot;: &quot;navigate&quot;,</span><br><span class="line">      &quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36&quot;,</span><br><span class="line">      &quot;Dnt&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;,</span><br><span class="line">      &quot;Cache-Control&quot;: &quot;max-age=0&quot;,</span><br><span class="line">      &quot;Connection&quot;: &quot;close&quot;,</span><br><span class="line">      &quot;Host&quot;: &quot;localhost:8000&quot;</span><br><span class="line">    &#125;</span><br><span class="line">[E 2019-09-19 13:44:06.428 SingleUserNotebookApp log:174] 500 GET /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (@::1) 35.80ms</span><br><span class="line">[W 2019-09-19 13:44:06.464 SingleUserNotebookApp log:174] 404 GET /user/jimolonely/static/components/react/react-dom.production.min.js (@::1) 3.72ms</span><br><span class="line">[W 2019-09-19 13:44:06.496 SingleUserNotebookApp log:174] 404 GET /user/jimolonely/static/components/react/react-dom.production.min.js (@::1) 1.49ms</span><br><span class="line">[E 2019-09-19 13:44:10.003 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 3/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[E 2019-09-19 13:44:18.015 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 4/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br><span class="line">[E 2019-09-19 13:44:34.028 SingleUserNotebookApp singleuser:438] Failed to connect to my Hub at http://127.0.0.1:8081/hub/api (attempt 5/5). Is it running?</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File &quot;/opt/conda/lib/python3.7/site-packages/jupyterhub/singleuser.py&quot;, line 432, in check_hub_version</span><br><span class="line">        resp = await client.fetch(self.hub_api_url)</span><br><span class="line">    ConnectionRefusedError: [Errno 111] Connection refused</span><br></pre></td></tr></table></figure>

<p>通过github上的示例：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/tree/master/examples/oauth">https://github.com/jupyterhub/dockerspawner/tree/master/examples/oauth</a></p>
<p>这里说得很清楚：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>可以看下<code>public_ips()</code>方法的结果：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>public_ips()</span><br><span class="line">[<span class="string">&#x27;192.168.199.249&#x27;</span>, <span class="string">&#x27;172.17.0.1&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>于是，我们修改完配置后重启，记得，依然要删除旧的容器实例，再次启动，成功了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-19 21:59:12.727 JupyterHub log:174] 200 GET /hub/spawn-pending/jimolonely (jimolonely@::1) 10.11ms</span><br><span class="line">[I 2019-09-19 21:59:12.835 JupyterHub log:174] 200 GET /hub/api (@172.17.0.2) 0.50ms</span><br><span class="line">[I 2019-09-19 21:59:12.866 JupyterHub log:174] 200 POST /hub/api/users/jimolonely/activity (jimolonely@172.17.0.2) 15.00ms</span><br><span class="line">[I 2019-09-19 21:59:13.316 JupyterHub base:810] User jimolonely took 1.607 seconds to start</span><br><span class="line">[I 2019-09-19 21:59:13.317 JupyterHub proxy:261] Adding user jimolonely to proxy /user/jimolonely/ =&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.322 [ConfigProxy] info: Adding route /user/jimolonely -&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.323 [ConfigProxy] info: Route added /user/jimolonely -&gt; http://127.0.0.1:32774</span><br><span class="line">21:59:13.323 [ConfigProxy] info: 201 POST /api/routes/user/jimolonely </span><br><span class="line">[I 2019-09-19 21:59:13.325 JupyterHub users:606] Server jimolonely is ready</span><br><span class="line">[I 2019-09-19 21:59:13.328 JupyterHub log:174] 200 GET /hub/api/users/jimolonely/server/progress (jimolonely@::1) 486.99ms</span><br><span class="line">[I 2019-09-19 21:59:13.368 JupyterHub log:174] 302 GET /hub/spawn-pending/jimolonely -&gt; /user/jimolonely/ (jimolonely@::1) 16.38ms</span><br><span class="line">[I 2019-09-19 21:59:13.449 JupyterHub log:174] 302 GET /hub/api/oauth2/authorize?client_id=jupyterhub-user-jimolonely&amp;redirect_uri=%2Fuser%2Fjimolonely%2Foauth_callback&amp;response_type=code&amp;state=[secret] -&gt; /user/jimolonely/oauth_callback?code=[secret]&amp;state=[secret] (jimolonely@::1) 40.87ms</span><br><span class="line">[I 2019-09-19 21:59:13.511 JupyterHub log:174] 200 POST /hub/api/oauth2/token (jimolonely@172.17.0.2) 44.80ms</span><br></pre></td></tr></table></figure>

<p>界面正常</p>
<p>通过docker里的日志可以看到：创建文件的目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user/jimolonely/api/contents/test1.ipynb</span><br></pre></td></tr></table></figure>

<h1 id="完整配置"><a href="#完整配置" class="headerlink" title="完整配置"></a>完整配置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c.Spawner.notebook_dir=&#x27;/home/jack/workspace/temp/notebook/&#123;username&#125;&#x27;</span></span><br><span class="line">c.Authenticator.whitelist = &#123;<span class="string">&#x27;hehe&#x27;</span>,<span class="string">&#x27;jack&#x27;</span>,<span class="string">&#x27;jimolonely&#x27;</span>&#125;</span><br><span class="line">c.Authenticator.admin_users = &#123;<span class="string">&#x27;hehe&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">c.GitHubOAuthenticator.oauth_callback_url = <span class="string">&#x27;http://localhost:8000/hub/oauth_callback&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_id = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_secret = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用REST-API"><a href="#使用REST-API" class="headerlink" title="使用REST API"></a>使用REST API</h1><p>需要做几步：</p>
<ol>
<li>获取token：</li>
</ol>
<ul>
<li>通过界面</li>
<li>通过命令行: <code>jupyterhub token &lt;username&gt;</code></li>
</ul>
<ol start="2">
<li>配置token到配置文件：  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.api_tokens = &#123;</span><br><span class="line">    <span class="string">&#x27;secret-token&#x27;</span>: <span class="string">&#x27;username&#x27;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>使用：  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 1.token是放在header里的，token前面还有个token标识</span><br><span class="line"># 2.默认API端口是8081，冲突了可以改</span><br><span class="line">curl -X GET -H &quot;Authorization: token &lt;token&gt;&quot; &quot;http://IP:8081/hub/api/users/&quot;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="新增用户"><a href="#新增用户" class="headerlink" title="新增用户"></a>新增用户</h1><ol>
<li>通过jupyter接口增加用户</li>
</ol>
<ul>
<li><a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/_static/rest-api/index.html">接口文档</a></li>
</ul>
<ol start="2">
<li>再登录</li>
</ol>
<h1 id="动态用户"><a href="#动态用户" class="headerlink" title="动态用户"></a>动态用户</h1><p>如果手动设置了白名单配置，那么只有白名单里的用户可以使用，因此去掉白名单声明，启动时可以看到下面的日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[I 2019-09-20 09:53:14.707 JupyterHub app:1563] Not using whitelist. Any authenticated user will be allowed.</span><br></pre></td></tr></table></figure>
<p>当然，我们也可以自定义认证器：<br><a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/issues/1012">https://github.com/jupyterhub/jupyterhub/issues/1012</a></p>
<h1 id="现在的配置"><a href="#现在的配置" class="headerlink" title="现在的配置"></a>现在的配置</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c.Spawner.notebook_dir=&#x27;/home/jack/workspace/temp/notebook/&#123;username&#125;&#x27;</span></span><br><span class="line"><span class="comment"># c.Authenticator.whitelist = &#123;&#x27;hehe&#x27;,&#x27;jack&#x27;,&#x27;jimolonely&#x27;&#125;</span></span><br><span class="line"><span class="comment"># c.Authenticator.admin_users = &#123;&#x27;hehe&#x27;&#125;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.api_tokens = &#123;</span><br><span class="line">    <span class="string">&#x27;95d7628d65224032857d7d36805f3324&#x27;</span>: <span class="string">&#x27;jimolonely&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.GitHubOAuthenticator.oauth_callback_url = <span class="string">&#x27;http://localhost:8000/hub/oauth_callback&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_id = <span class="string">&#x27;xxx&#x27;</span></span><br><span class="line">c.GitHubOAuthenticator.client_secret = <span class="string">&#x27;xxxx&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="自定义认证代码"><a href="#自定义认证代码" class="headerlink" title="自定义认证代码"></a>自定义认证代码</h1><p>我们做一个最简单的认证：如果用户名和密码相同就通过。</p>
<p>整个过程如下：</p>
<ol>
<li>写一个自定义认证器，实现jupyterhub的Authenticator类</li>
<li>安装到本地python库</li>
<li>配置自己的认证器类</li>
</ol>
<h2 id="自定义认证器"><a href="#自定义认证器" class="headerlink" title="自定义认证器"></a>自定义认证器</h2><p>认证器代码结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">my-authenticator$ tree</span><br><span class="line">.</span><br><span class="line">├── jauth</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── jauth.py</span><br><span class="line">└── setup.py</span><br></pre></td></tr></table></figure>

<p>jauth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyterhub.auth <span class="keyword">import</span> Authenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JimoAuth</span>(<span class="title class_ inherited__">Authenticator</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, handler, data</span>):</span><br><span class="line">        <span class="built_in">print</span>(handler)</span><br><span class="line">        <span class="built_in">print</span>(data)</span><br><span class="line">        username = data[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        <span class="comment"># check password:</span></span><br><span class="line">        <span class="keyword">if</span> data[<span class="string">&#x27;username&#x27;</span>] == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure>

<p><code>__init__.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .jauth <span class="keyword">import</span> *</span><br></pre></td></tr></table></figure>

<p>setup.py: 安装</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> setuptools <span class="keyword">import</span> setup</span><br><span class="line"></span><br><span class="line">setup(name=<span class="string">&#x27;jauth&#x27;</span>,</span><br><span class="line">      version=<span class="string">&#x27;1.0&#x27;</span>,</span><br><span class="line">      description=<span class="string">&#x27;jimo Authenticator for Jupyterhub&#x27;</span>,</span><br><span class="line">      author=<span class="string">&#x27;jimo&#x27;</span>,</span><br><span class="line">      license=<span class="string">&#x27;MIT&#x27;</span>,</span><br><span class="line">      author_email=<span class="string">&#x27;jimo@163.com&#x27;</span>,</span><br><span class="line">      url=<span class="string">&#x27;https://github.com/jimolonely&#x27;</span>,</span><br><span class="line">      packages=[<span class="string">&#x27;jauth&#x27;</span>],</span><br><span class="line">      )</span><br></pre></td></tr></table></figure>

<h2 id="安装到本地python库"><a href="#安装到本地python库" class="headerlink" title="安装到本地python库"></a>安装到本地python库</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">my-authenticator$ sudo python3 setup.py install</span><br><span class="line">[sudo] jack 的密码： </span><br><span class="line">running install</span><br><span class="line">running bdist_egg</span><br><span class="line">running egg_info</span><br><span class="line">creating jauth.egg-info</span><br><span class="line">writing jauth.egg-info/PKG-INFO</span><br><span class="line">writing dependency_links to jauth.egg-info/dependency_links.txt</span><br><span class="line">writing top-level names to jauth.egg-info/top_level.txt</span><br><span class="line">writing manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">reading manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">writing manifest file &#x27;jauth.egg-info/SOURCES.txt&#x27;</span><br><span class="line">installing library code to build/bdist.linux-x86_64/egg</span><br><span class="line">running install_lib</span><br><span class="line">running build_py</span><br><span class="line">creating build</span><br><span class="line">creating build/lib</span><br><span class="line">creating build/lib/jauth</span><br><span class="line">copying jauth/__init__.py -&gt; build/lib/jauth</span><br><span class="line">copying jauth/jauth.py -&gt; build/lib/jauth</span><br><span class="line">creating build/bdist.linux-x86_64</span><br><span class="line">creating build/bdist.linux-x86_64/egg</span><br><span class="line">creating build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">copying build/lib/jauth/__init__.py -&gt; build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">copying build/lib/jauth/jauth.py -&gt; build/bdist.linux-x86_64/egg/jauth</span><br><span class="line">byte-compiling build/bdist.linux-x86_64/egg/jauth/__init__.py to __init__.cpython-36.pyc</span><br><span class="line">byte-compiling build/bdist.linux-x86_64/egg/jauth/jauth.py to jauth.cpython-36.pyc</span><br><span class="line">creating build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/PKG-INFO -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/SOURCES.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/dependency_links.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">copying jauth.egg-info/top_level.txt -&gt; build/bdist.linux-x86_64/egg/EGG-INFO</span><br><span class="line">zip_safe flag not set; analyzing archive contents...</span><br><span class="line">creating dist</span><br><span class="line">creating &#x27;dist/jauth-1.0-py3.6.egg&#x27; and adding &#x27;build/bdist.linux-x86_64/egg&#x27; to it</span><br><span class="line">removing &#x27;build/bdist.linux-x86_64/egg&#x27; (and everything under it)</span><br><span class="line">Processing jauth-1.0-py3.6.egg</span><br><span class="line">Copying jauth-1.0-py3.6.egg to /usr/local/lib/python3.6/dist-packages</span><br><span class="line">Adding jauth 1.0 to easy-install.pth file</span><br><span class="line"></span><br><span class="line">Installed /usr/local/lib/python3.6/dist-packages/jauth-1.0-py3.6.egg</span><br><span class="line">Processing dependencies for jauth==1.0</span><br><span class="line">Finished processing dependencies for jauth==1.0</span><br></pre></td></tr></table></figure>

<p>安装完成会生成一些文件，最后能在<code>/usr/local/lib/python3.6/dist-packages</code>下面找到。</p>
<h2 id="配置自己的认证器类"><a href="#配置自己的认证器类" class="headerlink" title="配置自己的认证器类"></a>配置自己的认证器类</h2><p>下面是所有配置：</p>
<p>jc_auth.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置认证器类</span></span><br><span class="line"><span class="keyword">from</span> jauth <span class="keyword">import</span> JimoAuth</span><br><span class="line">c.JupyterHub.authenticator_class = JimoAuth</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ jupyterhub -f jc_auth.py</span><br></pre></td></tr></table></figure>

<p>可以看看登录失败和成功的日志：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;jupyterhub.handlers.login.LoginHandler <span class="built_in">object</span> at <span class="number">0x7f421a5b10b8</span>&gt;</span><br><span class="line">&#123;<span class="string">&#x27;next&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;jjjj&#x27;</span>&#125;</span><br><span class="line">[W <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">31.841</span> JupyterHub base:<span class="number">670</span>] Failed login <span class="keyword">for</span> jj</span><br><span class="line">[I <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">31.841</span> JupyterHub log:<span class="number">174</span>] <span class="number">200</span> POST /hub/login?<span class="built_in">next</span>= (@::<span class="number">1</span>) <span class="number">1.61</span>ms</span><br><span class="line">&lt;jupyterhub.handlers.login.LoginHandler <span class="built_in">object</span> at <span class="number">0x7f421ae15208</span>&gt;</span><br><span class="line">&#123;<span class="string">&#x27;next&#x27;</span>: <span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;jj&#x27;</span>&#125;</span><br><span class="line">[I <span class="number">2019</span>-09-<span class="number">21</span> 08:<span class="number">00</span>:<span class="number">48.058</span> JupyterHub base:<span class="number">663</span>] User logged <span class="keyword">in</span>: jj</span><br></pre></td></tr></table></figure>

<p>最后docker也运行成功：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                       NAMES</span><br><span class="line">d3f65881f6c2        jupyterhub/singleuser:1.0   &quot;tini -g -- start-no…&quot;   11 minutes ago      Up 11 minutes       127.0.0.1:32775-&gt;8888/tcp   jupyter-jj</span><br></pre></td></tr></table></figure>

<h1 id="使用JWT验证"><a href="#使用JWT验证" class="headerlink" title="使用JWT验证"></a>使用JWT验证</h1><p>JWT也是官方的一种验证方式：<a target="_blank" rel="noopener" href="https://github.com/mogthesprog/jwtauthenticator">https://github.com/mogthesprog/jwtauthenticator</a></p>
<p>安装完成后，下面是配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jwtauthenticator.jwtauthenticator.JSONWebTokenAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.secret = <span class="string">&#x27;jimo&#x27;</span>            <span class="comment"># The secrect key used to generate the given token</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.username_claim_field = <span class="string">&#x27;username&#x27;</span>                           <span class="comment"># The claim field contianing the username/sAMAccountNAme/userPrincipalName</span></span><br><span class="line">c.JSONWebTokenAuthenticator.expected_audience = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>secret是JWT的秘钥</li>
<li>username_claim_field是JWT里自定定义的用户名的key</li>
</ul>
<p>启动服务后，使用postman验证下：</p>
<p>在header里增加一个Authorization:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ</span><br></pre></td></tr></table></figure>

<p>这个token可以去官方网站生成一个做测试：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a>:</p>
<ul>
<li>填入secret</li>
<li>修改payload，增加<code>username: jimo</code></li>
</ul>
<p>POSTMAN可以成功，但是我们需要在web界面做到，于是随便一个网站，增加带JWT header的请求会出现跨域问题，比如，我写了一个简单的web界面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-sso-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>open jupyterhub<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;http://localhost:8000/hub/login&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title class_">Authorization</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">da</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(da)</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS http://localhost:8000/hub/login 405 (Method Not Allowed)</span><br><span class="line">Access to XMLHttpRequest at &#x27;http://localhost:8000/hub/login&#x27; from origin &#x27;null&#x27; has been blocked by CORS policy: Response to preflight request doesn&#x27;t pass access control check: It does not have HTTP ok status.</span><br></pre></td></tr></table></figure>

<p>我尝试过关闭jupyterhub的跨域，然而没有成功。那就只剩下一条路：把他们放在同一个域下。</p>
<p>我使用nginx来做代理，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 8080;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location ~/(hub|user) &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理到8080端口，包括前端页面和jupyterhub服务器，这里有个问题：就是所有的jupyterhub开头的URI都不能再被我们的应用使用了。</p>
<p>接着可以登录，也可以生成notebook，也能打开，但是连不上websocket：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebSocket connection to &#x27;ws://localhost:8080/user/jimo/api/kernels/750982b7-7696-4f88-9829-79e98c5f9932/channels?session_id=9db4d742f14940c88e643f3eddfa1de4&#x27; failed: Error during WebSocket handshake: Unexpected response code: 504</span><br></pre></td></tr></table></figure>

<p>增加下面的配置可以解决这个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">   default upgrade;</span><br><span class="line">   &#x27;&#x27;      close;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> server &#123;</span><br><span class="line"></span><br><span class="line">   location ~/(hub|user) &#123;</span><br><span class="line"></span><br><span class="line">     proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">     proxy_set_header Connection $connection_upgrade;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在可以正常写代码运行了，但是有几个API访问是403的，比如：</p>
<ul>
<li>停止服务</li>
<li>请求Token</li>
</ul>
<p>查看后台日志：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[W 2019-09-22 09:56:43.145 JupyterHub base:60] Blocking Cross Origin API request.  Referer: http://localhost:8080/hub/token, Host: localhost/hub/</span><br><span class="line">[E 2019-09-22 09:56:43.145 JupyterHub users:273] Error authenticating request for /hub/api/users/jimo/tokens: </span><br><span class="line">[W 2019-09-22 09:56:43.146 JupyterHub log:174] 403 POST /hub/api/users/jimo/tokens (@127.0.0.1) 7.12ms</span><br><span class="line"></span><br><span class="line">[W 2019-09-22 09:59:30.636 JupyterHub base:60] Blocking Cross Origin API request.  Referer: http://localhost:8080/hub/home, Host: localhost/hub/</span><br><span class="line">[W 2019-09-22 09:59:30.637 JupyterHub log:174] 403 DELETE /hub/api/users/jimo/server (@127.0.0.1) 10.50ms</span><br></pre></td></tr></table></figure>

<p>看来还是跨域的问题导致的认证失败。</p>
<p>这个问题可以这样解决：（目前没找到更好的方法）：使用80端口，这样jupyterhub就认为是一个域了。</p>
<h2 id="更近一步"><a href="#更近一步" class="headerlink" title="更近一步"></a>更近一步</h2><p>上面的nginx配置依然有问题，因为在集成到我们的应用时，不可能把<code>user, hub</code>等URI剔除，即便可以，也不友好，因此需要给jupyterhub自定义一个前缀URI，这里使用notebook：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.base_url = <span class="string">u&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>相应的nginx配置也得改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">        index index.html;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /notebook &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在关于jupyterhub的一切都在<code>/notebook/</code>下了。</p>
<p>然而，新的问题又来了：docker容器里请求jupyterhub 的API的路径也变了，而docker配置未修改，于是访问时就会出现404：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[E 2019-09-22 03:31:03.980 SingleUserNotebookApp web:2991] Could not open static file &#x27;&#x27;</span><br><span class="line">[W 2019-09-22 03:31:03.981 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/notebook? (@127.0.0.1) 26.89ms</span><br><span class="line">[W 2019-09-22 03:31:04.027 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/static/components/react/react-dom.production.min.js (@127.0.0.1) 3.69ms</span><br><span class="line">[W 2019-09-22 03:31:04.067 SingleUserNotebookApp log:174] 404 GET /notebook/user/jimo/static/components/react/react-dom.production.min.js (@127.0.0.1) 1.60ms</span><br></pre></td></tr></table></figure>
<p>map $http_upgrade $connection_upgrade {<br>  default upgrade;<br>  ‘’      close;<br>}</p>
<p>于是，继续修改配置，修改docker里访问API的路径，加个前缀：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.hub_prefix = <span class="string">&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后记得删除旧的docker实例，再重新生成就ok了。</p>
<h2 id="完整配置-1"><a href="#完整配置-1" class="headerlink" title="完整配置"></a>完整配置</h2><p>jc.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The docker instances need access to the Hub, so the default loopback port doesn&#x27;t work:</span></span><br><span class="line"><span class="keyword">from</span> jupyter_client.localinterfaces <span class="keyword">import</span> public_ips</span><br><span class="line">c.JupyterHub.hub_ip = public_ips()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> oauthenticator.github <span class="keyword">import</span> GitHubOAuthenticator</span><br><span class="line">c.JupyterHub.authenticator_class = GitHubOAuthenticator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">c.JupyterHub.spawner_class = <span class="string">&#x27;dockerspawner.DockerSpawner&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JupyterHub.authenticator_class = <span class="string">&#x27;jwtauthenticator.jwtauthenticator.JSONWebTokenAuthenticator&#x27;</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.secret = <span class="string">&#x27;jimo&#x27;</span>            <span class="comment"># The secrect key used to generate the given token</span></span><br><span class="line"></span><br><span class="line">c.JSONWebTokenAuthenticator.username_claim_field = <span class="string">&#x27;username&#x27;</span>                           <span class="comment"># The claim field contianing the username/sAMAccountNAme/userPrincipalName</span></span><br><span class="line">c.JSONWebTokenAuthenticator.expected_audience = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">origin=<span class="string">&#x27;*&#x27;</span></span><br><span class="line">c.Spawner.args = [<span class="string">f&#x27;--NotebookApp.allow_origin=<span class="subst">&#123;origin&#125;</span>&#x27;</span>]</span><br><span class="line">c.JupyterHub.tornado_settings = &#123;</span><br><span class="line">    <span class="string">&#x27;headers&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;Access-Control-Allow-Origin&#x27;</span>: origin,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.Authenticator.admin_users = &#123;<span class="string">&#x27;jimo&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">c.JupyterHub.base_url = <span class="string">u&#x27;/notebook&#x27;</span></span><br><span class="line"></span><br><span class="line">c.DockerSpawner.hub_prefix = <span class="string">&#x27;/notebook&#x27;</span></span><br></pre></td></tr></table></figure>

<p>nginx的 hub.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">map $http_upgrade $connection_upgrade &#123;</span><br><span class="line">  default upgrade;</span><br><span class="line">  &#x27;&#x27;      close;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line"></span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line"></span><br><span class="line">    root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">    index index.html;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root /home/jack/workspace/temp/vue-jupyterhub-app/app;</span><br><span class="line">        index index.html;    </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location /notebook &#123;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_pass_request_headers on;</span><br><span class="line">        proxy_pass_header Authorization;</span><br><span class="line">        proxy_pass http://localhost:8000;</span><br><span class="line"></span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width,initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>vue-sso-demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>The Great Jupyterhub In Just<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>open jupyterhub<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">      $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;url&#x27;</span>: <span class="string">&#x27;/notebook/hub/login&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;get&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">headers</span>: &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="title class_">Authorization</span>: <span class="string">&#x27;bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwidXNlcm5hbWUiOiJqaW1vIiwiaWF0IjoxNTE2MjM5MDIyfQ.hdMd2TNqSY2EUVpv4HqofQN_jfSWjclk95cH7aoGseQ&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">da</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">console</span>.<span class="title function_">log</span>(da)</span></span><br><span class="line"><span class="language-javascript">          <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;/notebook/hub/home&#x27;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;)</span></span><br><span class="line"><span class="language-javascript">    &#125;)</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="读取cookie认证"><a href="#读取cookie认证" class="headerlink" title="读取cookie认证"></a>读取cookie认证</h1><p>要让jupyterhub读取我们应用的cookie，他们必须处于同一个域下，可以是一个子域名。</p>
<p>经过测试，是可以读取到cookie的，于是怎么验证就是个问题了。</p>
<h1 id="自定义界面"><a href="#自定义界面" class="headerlink" title="自定义界面"></a>自定义界面</h1><p>juopyterhub提供了自定义界面的方式：<a target="_blank" rel="noopener" href="https://jupyterhub.readthedocs.io/en/stable/reference/templates.html">https://jupyterhub.readthedocs.io/en/stable/reference/templates.html</a></p>
<p>我们只需要遵循以下步骤：</p>
<ol>
<li>选择自定义页面路径: 我选的<code>/home/jimo/jwt_auth/pages</code></li>
<li>修改hub配置，指定自定义路径： <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.template_paths=[<span class="string">&#x27;/home/jimo/jwt_auth/pages&#x27;</span>]</span><br></pre></td></tr></table></figure></li>
<li>参考<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/share/jupyterhub/templates">源码页面</a>，修改为自己想要的样子</li>
</ol>
<p>一般我们修改页面只是做一些logo、汉化等。</p>
<p>比如：截断很长的用户名，使用<a target="_blank" rel="noopener" href="https://jinja.palletsprojects.com/en/2.10.x/templates/#truncate">jinja的过滤器语法的truncate方法</a>：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;navbar-text&quot;</span>&gt;</span>&#123;&#123;user.name | truncate(length=5)&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h1 id="自定义notebook镜像"><a href="#自定义notebook镜像" class="headerlink" title="自定义notebook镜像"></a>自定义notebook镜像</h1><h2 id="明白原生镜像"><a href="#明白原生镜像" class="headerlink" title="明白原生镜像"></a>明白原生镜像</h2><p>原生镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/jupyterhub/singleuser/dockerfile">https://hub.docker.com/r/jupyterhub/singleuser/dockerfile</a></p>
<p>查看其dockerfile</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># Build as jupyterhub/singleuser</span><br><span class="line"># Run with the DockerSpawner in JupyterHub</span><br><span class="line"></span><br><span class="line">ARG BASE_IMAGE=jupyter/base-notebook</span><br><span class="line">FROM $BASE_IMAGE</span><br><span class="line">MAINTAINER Project Jupyter &lt;jupyter@googlegroups.com&gt;</span><br><span class="line"></span><br><span class="line">ADD install_jupyterhub /tmp/install_jupyterhub</span><br><span class="line">ARG JUPYTERHUB_VERSION=master</span><br><span class="line"># install pinned jupyterhub and ensure notebook is installed</span><br><span class="line">RUN python3 /tmp/install_jupyterhub &amp;&amp; \</span><br><span class="line">    python3 -m pip install notebook</span><br></pre></td></tr></table></figure>

<h3 id="base镜像"><a href="#base镜像" class="headerlink" title="base镜像"></a>base镜像</h3><p>首先找到其base镜像：<a target="_blank" rel="noopener" href="https://hub.docker.com/r/jupyter/base-notebook/dockerfile">jupyter&#x2F;base-notebook </a></p>
<p>里面主要做的就是打包jupyter的notebook，暂时不研究。</p>
<p>注意：其使用conda安装python的。</p>
<h3 id="install-jupyterhub"><a href="#install-jupyterhub" class="headerlink" title="install_jupyterhub"></a>install_jupyterhub</h3><p>显然，这是一个本地文件，我们找到github上的源码：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/singleuser">https://github.com/jupyterhub/jupyterhub/tree/master/singleuser</a></p>
<p>install_jupyterhub是一个没有后缀的python文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_call</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">V = os.environ[<span class="string">&#x27;JUPYTERHUB_VERSION&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pip_install = [</span><br><span class="line">    sys.executable, <span class="string">&#x27;-m&#x27;</span>, <span class="string">&#x27;pip&#x27;</span>, <span class="string">&#x27;install&#x27;</span>, <span class="string">&#x27;--no-cache&#x27;</span>, <span class="string">&#x27;--upgrade&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;--upgrade-strategy&#x27;</span>, <span class="string">&#x27;only-if-needed&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="keyword">if</span> V == <span class="string">&#x27;master&#x27;</span>:</span><br><span class="line">    req = <span class="string">&#x27;https://github.com/jupyterhub/jupyterhub/archive/master.tar.gz&#x27;</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    version_info = [ <span class="built_in">int</span>(part) <span class="keyword">for</span> part <span class="keyword">in</span> V.split(<span class="string">&#x27;.&#x27;</span>) ]</span><br><span class="line">    version_info[-<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    upper_bound = <span class="string">&#x27;.&#x27;</span>.join(<span class="built_in">map</span>(<span class="built_in">str</span>, version_info))</span><br><span class="line">    vs = <span class="string">&#x27;&gt;=%s,&lt;%s&#x27;</span> % (V, upper_bound)</span><br><span class="line">    req = <span class="string">&#x27;jupyterhub%s&#x27;</span> % vs</span><br><span class="line"></span><br><span class="line">check_call(pip_install + [req])</span><br></pre></td></tr></table></figure>

<p>脚本很好懂，就是从github下载源码安装，所以不需要关心这一步。</p>
<h2 id="修改镜像"><a href="#修改镜像" class="headerlink" title="修改镜像"></a>修改镜像</h2><p>根据我们的需求修改：</p>
<ul>
<li>安装相应的包</li>
<li>修改内核代码</li>
</ul>
<p>由于咱们需要更改python内核代码增加一些magic函数，所以需要修改docker镜像里的python代码。</p>
<p>找到python对应的版本：看起来都是用的python3.7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/opt/conda/bin$</span><br><span class="line">lrwxrwxrwx 1 jovyan users        9 Aug  3 03:26 python -&gt; python3.7*</span><br><span class="line">lrwxrwxrwx 1 jovyan users        9 Aug  3 03:26 python3 -&gt; python3.7*</span><br></pre></td></tr></table></figure>

<p>确定我们要改的包的路径：<code>/opt/conda/lib/python3.7/site-packages/IPython</code></p>
<p>由于修改镜像涉及到保密信息，大家根据自己情况修改，确保最后build成功。</p>
<h2 id="指定自己的镜像"><a href="#指定自己的镜像" class="headerlink" title="指定自己的镜像"></a>指定自己的镜像</h2><p>修改hub的配置，指向我们自己的镜像：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.image = <span class="string">&#x27;test/docker-notebook:v2&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h2><p>使用docker的一个点是：数据默认是存在docker里的，用于生产时肯定需要持久化到外部存储里。</p>
<p>目前没有云存储，暂时映射到本机上的一个目录：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.DockerSpawner.volumes = &#123;<span class="string">&#x27;/mnt/docker/data/hub-data-&#123;username&#125;&#x27;</span>:<span class="string">&#x27;/home/jovyan&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>前面是本机目录，后面是容器内用户的工作空间。</p>
<p><strong>非常重要：确保docker对本机目录有读写权限，最简单的做法：chmod 777 -R &#x2F;mnt&#x2F;docker&#x2F;data</strong></p>
<p>否则会出现权限问题：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  File <span class="string">&quot;/opt/conda/lib/python3.7/os.py&quot;</span>, line <span class="number">221</span>, <span class="keyword">in</span> makedirs</span><br><span class="line">    mkdir(name, mode)</span><br><span class="line">PermissionError: [Errno <span class="number">13</span>] Permission denied: <span class="string">&#x27;/home/jovyan/.local&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Permission-denied-‘-x2F-home-x2F-jovyan-x2F-local’"><a href="#Permission-denied-‘-x2F-home-x2F-jovyan-x2F-local’" class="headerlink" title="Permission denied: ‘&#x2F;home&#x2F;jovyan&#x2F;.local’"></a>Permission denied: ‘&#x2F;home&#x2F;jovyan&#x2F;.local’</h2><p>然而，上述做法是需要手动操作的，就是新增的用户没办法在宿主机上创建文件，因为没有写的权限。</p>
<p>关于这个问题，可以在<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/dockerspawner/issues/160">github issue</a>里找到：</p>
<blockquote>
<p>这是一个常见的Docker问题，在创建docker实例时挂在外部不存在的目录卷时。 这是Docker的一个长期困扰 使用容器内部卷时就不是问题，这就是为什么要偏向使用它的部分原因。</p>
</blockquote>
<p>既然是docker的问题，那么就只有走偏方了：能不能在启动容器前就把外部目录的权限分配好？</p>
<p>还真可以，而且是官方操作：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/examples/bootstrap-script">bootstrap-script</a></p>
<p>启动脚本：可以在启动notebook实例前干一些事情，想干什么范围就很广了。</p>
<p>比如，我们创建目录并分配权限：在jupyterhub_config.py里</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_dir_hook</span>(<span class="params">spawner</span>):</span><br><span class="line">    username = spawner.user.name <span class="comment"># get the username</span></span><br><span class="line">    volume_path = os.path.join(<span class="string">&#x27;/home/jimo/jwt_auth&#x27;</span>, username)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(volume_path):</span><br><span class="line">        <span class="comment"># create a directory with umask 0777</span></span><br><span class="line">        <span class="comment"># hub and container user must have the same UID to be writeable</span></span><br><span class="line">        <span class="comment"># still readable by other users on the system</span></span><br><span class="line">        os.mkdir(volume_path, <span class="number">0o777</span>)</span><br><span class="line">        <span class="comment"># now do whatever you think your user needs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># attach the hook function to the spawner</span></span><br><span class="line">c.Spawner.pre_spawn_hook = create_dir_hook</span><br></pre></td></tr></table></figure>

<h2 id="关于docker网络"><a href="#关于docker网络" class="headerlink" title="关于docker网络"></a>关于docker网络</h2><p>集成了自己的东西到notebook里，notebook又在docker里，而自己的东西需要与外部网络通信。</p>
<h2 id="资源限制"><a href="#资源限制" class="headerlink" title="资源限制"></a>资源限制</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c.Spawner.mem_limit = <span class="string">&#x27;500M&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="离线安装"><a href="#离线安装" class="headerlink" title="离线安装"></a>离线安装</h2><h3 id="离线打包python环境"><a href="#离线打包python环境" class="headerlink" title="离线打包python环境"></a>离线打包python环境</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/vevenlcf/article/details/83110204">https://blog.csdn.net/vevenlcf/article/details/83110204</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python3.7 -m pip freeze &gt; hub_req.txt</span><br><span class="line"></span><br><span class="line">python3.7 -m pip download -r hub_req.txt -d ./pkgs/</span><br><span class="line"></span><br><span class="line">tar -czf pkgs.tar.gz pkgs/</span><br></pre></td></tr></table></figure>

<h3 id="离线打包docker镜像"><a href="#离线打包docker镜像" class="headerlink" title="离线打包docker镜像"></a>离线打包docker镜像</h3><p>打包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker save -o just-docker-notebook.tar just/docker-notebook:v2</span><br><span class="line"># 再压缩下</span><br><span class="line">tar -czf just-docker-notebook.tar.gz just-docker-notebook.tar</span><br></pre></td></tr></table></figure>

<p>导入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; just-docker-notebook.tar</span><br><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h1 id="释放不活动用户资源"><a href="#释放不活动用户资源" class="headerlink" title="释放不活动用户资源"></a>释放不活动用户资源</h1><p>按照默认情况，用户启动之后，notebook的docker容器会一直运行，这样其实很占资源，对于不活动用户的资源，需要在一定时间后清理。</p>
<p>我们通过增加一个服务：<a target="_blank" rel="noopener" href="https://github.com/jupyterhub/jupyterhub/tree/master/examples/cull-idle">https://github.com/jupyterhub/jupyterhub/tree/master/examples/cull-idle</a></p>
<ol>
<li>把项目中的cull_idle_servers.py脚本弄下来</li>
<li>在配置文件中配置服务：这里是3600秒 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c.JupyterHub.services = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;cull-idle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;admin&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;command&#x27;</span>: [sys.executable, <span class="string">&#x27;cull_idle_servers.py&#x27;</span>, <span class="string">&#x27;--timeout=3600&#x27;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
</ol>
<p>其实这个cull_idle_servers.py是通过轮询的方式来做的，自己也可以写一个。</p>

          </div>
          


      <footer class="article-footer">
        <a data-url="http://jimolonely.github.io/history/2019/09/19/python/009-jupyterhub-github-oauth-error-fix/" data-id="cl1fw7fn900i6vkd30v0a21ts" class="article-share-link">
          Share
        </a>
        
            
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/jupyterhub/" rel="tag">jupyterhub</a><span class="article-tag-list-count">2</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/notebook/" rel="tag">notebook</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/oauth/" rel="tag">oauth</a><span class="article-tag-list-count">1</span></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a><span class="article-tag-list-count">13</span></li></ul>

      </footer>
      </div>
      
        
<nav id="article-nav">
  
    <a href="/history/2019/09/22/java/070-springboot-interceptor-add-header-pro/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          springboot interceptor posthandle 添加自定义header
        
      </div>
    </a>
  
  
    <a href="/history/2019/09/17/life/032-weekly-learn/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">2019-38-周报</div>
    </a>
  
</nav>

          
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/AI/" rel="tag">AI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/UI-test/" rel="tag">UI test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/android/" rel="tag">android</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/annotation/" rel="tag">annotation</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ansible/" rel="tag">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ant/" rel="tag">ant</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/aop/" rel="tag">aop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/archiva/" rel="tag">archiva</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/asciidoc/" rel="tag">asciidoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/awk/" rel="tag">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/axios/" rel="tag">axios</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/basic/" rel="tag">basic</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/big-data/" rel="tag">big data</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/blockchain/" rel="tag">blockchain</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/centos/" rel="tag">centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/cglib/" rel="tag">cglib</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/checkstyle/" rel="tag">checkstyle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/chrome/" rel="tag">chrome</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/computer-principle/" rel="tag">computer principle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/cors/" rel="tag">cors</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/data-structure/" rel="tag">data structure</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/design-pattern/" rel="tag">design-pattern</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/elasticsearch/" rel="tag">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/es/" rel="tag">es</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/eureka/" rel="tag">eureka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/firefox/" rel="tag">firefox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/flask/" rel="tag">flask</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/geohash/" rel="tag">geohash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/geomesa/" rel="tag">geomesa</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/gitlab/" rel="tag">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/gradle/" rel="tag">gradle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/groovy/" rel="tag">groovy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/hadoop/" rel="tag">hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/hbase/" rel="tag">hbase</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/html/" rel="tag">html</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/http/" rel="tag">http</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/idea/" rel="tag">idea</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ip/" rel="tag">ip</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/javascript/" rel="tag">javascript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/js/" rel="tag">js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/junit/" rel="tag">junit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jupyter/" rel="tag">jupyter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jupyterhub/" rel="tag">jupyterhub</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jvm/" rel="tag">jvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/jwt/" rel="tag">jwt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/k8s/" rel="tag">k8s</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/kafka/" rel="tag">kafka</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/katalon/" rel="tag">katalon</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/keepalived/" rel="tag">keepalived</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/latex/" rel="tag">latex</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/life/" rel="tag">life</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/linux-kernel/" rel="tag">linux kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/load-balance/" rel="tag">load balance</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/log/" rel="tag">log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/log4j/" rel="tag">log4j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/log4j12/" rel="tag">log4j12</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/logback/" rel="tag">logback</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/lombok/" rel="tag">lombok</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/lru/" rel="tag">lru</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/lucene/" rel="tag">lucene</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/magnet/" rel="tag">magnet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/make/" rel="tag">make</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/makefile/" rel="tag">makefile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/manjaro/" rel="tag">manjaro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/math/" rel="tag">math</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/maven/" rel="tag">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/md5/" rel="tag">md5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/mhtml/" rel="tag">mhtml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/microservice/" rel="tag">microservice</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/music/" rel="tag">music</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/mybatis/" rel="tag">mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/notebook/" rel="tag">notebook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/npm/" rel="tag">npm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/nvidia/" rel="tag">nvidia</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/oauth/" rel="tag">oauth</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/openstack/" rel="tag">openstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/optimization/" rel="tag">optimization</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pandas/" rel="tag">pandas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pandoc/" rel="tag">pandoc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pgsql/" rel="tag">pgsql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/probability/" rel="tag">probability</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/pyspark/" rel="tag">pyspark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/python/" rel="tag">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/quartz/" rel="tag">quartz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/react/" rel="tag">react</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/resource/" rel="tag">resource</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/review/" rel="tag">review</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/sbt/" rel="tag">sbt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/scala/" rel="tag">scala</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/slf4j/" rel="tag">slf4j</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spark/" rel="tag">spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spring/" rel="tag">spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spring-cloud/" rel="tag">spring cloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/spring-boot/" rel="tag">spring-boot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/springboot/" rel="tag">springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/sql/" rel="tag">sql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/sqlserver/" rel="tag">sqlserver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ssh/" rel="tag">ssh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/statistics/" rel="tag">statistics</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/syslog/" rel="tag">syslog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/term/" rel="tag">term</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/test/" rel="tag">test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/texlive/" rel="tag">texlive</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/thread/" rel="tag">thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/tomcat/" rel="tag">tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/tool/" rel="tag">tool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/ubuntu/" rel="tag">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/urban-computing/" rel="tag">urban computing</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/video/" rel="tag">video</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vim/" rel="tag">vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vpn/" rel="tag">vpn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vscode/" rel="tag">vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/vue/" rel="tag">vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/web-dav/" rel="tag">web-dav</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/webpack/" rel="tag">webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/week/" rel="tag">week</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/wordcloud/" rel="tag">wordcloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/work/" rel="tag">work</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/xml/" rel="tag">xml</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/zipkin/" rel="tag">zipkin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/zookeeper/" rel="tag">zookeeper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" rel="tag">云计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E5%85%83%E7%BC%96%E7%A8%8B/" rel="tag">元编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E5%9F%8E%E5%B8%82%E8%AE%A1%E7%AE%97/" rel="tag">城市计算</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E6%A6%82%E5%BF%B5/" rel="tag">概念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E6%B5%8B%E8%AF%95/" rel="tag">测试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/history/tags/%E8%BF%90%E7%BB%B4/" rel="tag">运维</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/history/tags/AI/" style="font-size: 10.53px;">AI</a> <a href="/history/tags/UI-test/" style="font-size: 10px;">UI test</a> <a href="/history/tags/algorithm/" style="font-size: 10.53px;">algorithm</a> <a href="/history/tags/android/" style="font-size: 10.53px;">android</a> <a href="/history/tags/annotation/" style="font-size: 10px;">annotation</a> <a href="/history/tags/ansible/" style="font-size: 13.16px;">ansible</a> <a href="/history/tags/ant/" style="font-size: 10px;">ant</a> <a href="/history/tags/aop/" style="font-size: 10px;">aop</a> <a href="/history/tags/archiva/" style="font-size: 10px;">archiva</a> <a href="/history/tags/asciidoc/" style="font-size: 10px;">asciidoc</a> <a href="/history/tags/awk/" style="font-size: 10px;">awk</a> <a href="/history/tags/axios/" style="font-size: 10px;">axios</a> <a href="/history/tags/basic/" style="font-size: 13.16px;">basic</a> <a href="/history/tags/big-data/" style="font-size: 10.53px;">big data</a> <a href="/history/tags/blockchain/" style="font-size: 10px;">blockchain</a> <a href="/history/tags/centos/" style="font-size: 12.11px;">centos</a> <a href="/history/tags/cglib/" style="font-size: 10px;">cglib</a> <a href="/history/tags/checkstyle/" style="font-size: 10px;">checkstyle</a> <a href="/history/tags/chrome/" style="font-size: 11.05px;">chrome</a> <a href="/history/tags/computer-principle/" style="font-size: 10px;">computer principle</a> <a href="/history/tags/cors/" style="font-size: 10.53px;">cors</a> <a href="/history/tags/data-structure/" style="font-size: 10px;">data structure</a> <a href="/history/tags/design-pattern/" style="font-size: 10.53px;">design-pattern</a> <a href="/history/tags/docker/" style="font-size: 17.89px;">docker</a> <a href="/history/tags/elasticsearch/" style="font-size: 13.16px;">elasticsearch</a> <a href="/history/tags/es/" style="font-size: 10px;">es</a> <a href="/history/tags/eureka/" style="font-size: 10px;">eureka</a> <a href="/history/tags/firefox/" style="font-size: 10px;">firefox</a> <a href="/history/tags/flask/" style="font-size: 10px;">flask</a> <a href="/history/tags/geohash/" style="font-size: 10px;">geohash</a> <a href="/history/tags/geomesa/" style="font-size: 10px;">geomesa</a> <a href="/history/tags/git/" style="font-size: 13.16px;">git</a> <a href="/history/tags/gitlab/" style="font-size: 11.05px;">gitlab</a> <a href="/history/tags/gradle/" style="font-size: 10px;">gradle</a> <a href="/history/tags/groovy/" style="font-size: 10px;">groovy</a> <a href="/history/tags/hadoop/" style="font-size: 10.53px;">hadoop</a> <a href="/history/tags/hbase/" style="font-size: 11.58px;">hbase</a> <a href="/history/tags/hexo/" style="font-size: 10.53px;">hexo</a> <a href="/history/tags/html/" style="font-size: 10.53px;">html</a> <a href="/history/tags/http/" style="font-size: 10px;">http</a> <a href="/history/tags/idea/" style="font-size: 11.05px;">idea</a> <a href="/history/tags/ip/" style="font-size: 10px;">ip</a> <a href="/history/tags/java/" style="font-size: 20px;">java</a> <a href="/history/tags/javascript/" style="font-size: 11.58px;">javascript</a> <a href="/history/tags/js/" style="font-size: 13.16px;">js</a> <a href="/history/tags/junit/" style="font-size: 10px;">junit</a> <a href="/history/tags/jupyter/" style="font-size: 10px;">jupyter</a> <a href="/history/tags/jupyterhub/" style="font-size: 10.53px;">jupyterhub</a> <a href="/history/tags/jvm/" style="font-size: 10px;">jvm</a> <a href="/history/tags/jwt/" style="font-size: 10px;">jwt</a> <a href="/history/tags/k8s/" style="font-size: 11.05px;">k8s</a> <a href="/history/tags/kafka/" style="font-size: 10px;">kafka</a> <a href="/history/tags/katalon/" style="font-size: 10px;">katalon</a> <a href="/history/tags/keepalived/" style="font-size: 10.53px;">keepalived</a> <a href="/history/tags/latex/" style="font-size: 11.05px;">latex</a> <a href="/history/tags/life/" style="font-size: 18.95px;">life</a> <a href="/history/tags/linux/" style="font-size: 19.47px;">linux</a> <a href="/history/tags/linux-kernel/" style="font-size: 10px;">linux kernel</a> <a href="/history/tags/load-balance/" style="font-size: 10px;">load balance</a> <a href="/history/tags/log/" style="font-size: 10px;">log</a> <a href="/history/tags/log4j/" style="font-size: 10px;">log4j</a> <a href="/history/tags/log4j12/" style="font-size: 10px;">log4j12</a> <a href="/history/tags/logback/" style="font-size: 10px;">logback</a> <a href="/history/tags/lombok/" style="font-size: 10px;">lombok</a> <a href="/history/tags/lru/" style="font-size: 10px;">lru</a> <a href="/history/tags/lucene/" style="font-size: 10px;">lucene</a> <a href="/history/tags/magnet/" style="font-size: 10px;">magnet</a> <a href="/history/tags/make/" style="font-size: 10px;">make</a> <a href="/history/tags/makefile/" style="font-size: 10px;">makefile</a> <a href="/history/tags/manjaro/" style="font-size: 10px;">manjaro</a> <a href="/history/tags/math/" style="font-size: 11.05px;">math</a> <a href="/history/tags/maven/" style="font-size: 15.26px;">maven</a> <a href="/history/tags/md5/" style="font-size: 10px;">md5</a> <a href="/history/tags/mhtml/" style="font-size: 10px;">mhtml</a> <a href="/history/tags/microservice/" style="font-size: 14.21px;">microservice</a> <a href="/history/tags/music/" style="font-size: 10px;">music</a> <a href="/history/tags/mybatis/" style="font-size: 11.05px;">mybatis</a> <a href="/history/tags/mysql/" style="font-size: 12.11px;">mysql</a> <a href="/history/tags/nginx/" style="font-size: 12.63px;">nginx</a> <a href="/history/tags/notebook/" style="font-size: 10px;">notebook</a> <a href="/history/tags/npm/" style="font-size: 10px;">npm</a> <a href="/history/tags/nvidia/" style="font-size: 10px;">nvidia</a> <a href="/history/tags/oauth/" style="font-size: 10px;">oauth</a> <a href="/history/tags/openstack/" style="font-size: 12.11px;">openstack</a> <a href="/history/tags/optimization/" style="font-size: 10px;">optimization</a> <a href="/history/tags/pandas/" style="font-size: 10px;">pandas</a> <a href="/history/tags/pandoc/" style="font-size: 10px;">pandoc</a> <a href="/history/tags/pgsql/" style="font-size: 11.58px;">pgsql</a> <a href="/history/tags/probability/" style="font-size: 10px;">probability</a> <a href="/history/tags/pyspark/" style="font-size: 10px;">pyspark</a> <a href="/history/tags/python/" style="font-size: 17.37px;">python</a> <a href="/history/tags/quartz/" style="font-size: 10.53px;">quartz</a> <a href="/history/tags/react/" style="font-size: 10px;">react</a> <a href="/history/tags/redis/" style="font-size: 15.79px;">redis</a> <a href="/history/tags/resource/" style="font-size: 10px;">resource</a> <a href="/history/tags/review/" style="font-size: 10px;">review</a> <a href="/history/tags/sbt/" style="font-size: 10px;">sbt</a> <a href="/history/tags/scala/" style="font-size: 14.74px;">scala</a> <a href="/history/tags/shell/" style="font-size: 12.63px;">shell</a> <a href="/history/tags/slf4j/" style="font-size: 10px;">slf4j</a> <a href="/history/tags/spark/" style="font-size: 14.74px;">spark</a> <a href="/history/tags/spring/" style="font-size: 15.79px;">spring</a> <a href="/history/tags/spring-cloud/" style="font-size: 12.11px;">spring cloud</a> <a href="/history/tags/spring-boot/" style="font-size: 13.68px;">spring-boot</a> <a href="/history/tags/springboot/" style="font-size: 11.05px;">springboot</a> <a href="/history/tags/sql/" style="font-size: 11.05px;">sql</a> <a href="/history/tags/sqlserver/" style="font-size: 10.53px;">sqlserver</a> <a href="/history/tags/ssh/" style="font-size: 12.11px;">ssh</a> <a href="/history/tags/statistics/" style="font-size: 10px;">statistics</a> <a href="/history/tags/syslog/" style="font-size: 10px;">syslog</a> <a href="/history/tags/term/" style="font-size: 10px;">term</a> <a href="/history/tags/test/" style="font-size: 10px;">test</a> <a href="/history/tags/texlive/" style="font-size: 10px;">texlive</a> <a href="/history/tags/thread/" style="font-size: 10px;">thread</a> <a href="/history/tags/tomcat/" style="font-size: 13.16px;">tomcat</a> <a href="/history/tags/tool/" style="font-size: 16.84px;">tool</a> <a href="/history/tags/ubuntu/" style="font-size: 16.32px;">ubuntu</a> <a href="/history/tags/urban-computing/" style="font-size: 10px;">urban computing</a> <a href="/history/tags/video/" style="font-size: 10px;">video</a> <a href="/history/tags/vim/" style="font-size: 10.53px;">vim</a> <a href="/history/tags/vpn/" style="font-size: 10px;">vpn</a> <a href="/history/tags/vscode/" style="font-size: 10px;">vscode</a> <a href="/history/tags/vue/" style="font-size: 11.05px;">vue</a> <a href="/history/tags/web/" style="font-size: 10px;">web</a> <a href="/history/tags/web-dav/" style="font-size: 10px;">web-dav</a> <a href="/history/tags/webpack/" style="font-size: 10.53px;">webpack</a> <a href="/history/tags/week/" style="font-size: 18.42px;">week</a> <a href="/history/tags/windows/" style="font-size: 10px;">windows</a> <a href="/history/tags/wordcloud/" style="font-size: 10px;">wordcloud</a> <a href="/history/tags/work/" style="font-size: 10px;">work</a> <a href="/history/tags/xml/" style="font-size: 10px;">xml</a> <a href="/history/tags/zipkin/" style="font-size: 10px;">zipkin</a> <a href="/history/tags/zookeeper/" style="font-size: 10px;">zookeeper</a> <a href="/history/tags/%E4%BA%91%E8%AE%A1%E7%AE%97/" style="font-size: 12.63px;">云计算</a> <a href="/history/tags/%E5%85%83%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">元编程</a> <a href="/history/tags/%E5%9F%8E%E5%B8%82%E8%AE%A1%E7%AE%97/" style="font-size: 10px;">城市计算</a> <a href="/history/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">架构</a> <a href="/history/tags/%E6%A6%82%E5%BF%B5/" style="font-size: 10px;">概念</a> <a href="/history/tags/%E6%B5%8B%E8%AF%95/" style="font-size: 10px;">测试</a> <a href="/history/tags/%E7%88%AC%E8%99%AB/" style="font-size: 10px;">爬虫</a> <a href="/history/tags/%E8%BF%90%E7%BB%B4/" style="font-size: 10px;">运维</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2022/03/">三月 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/09/">九月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/08/">八月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/07/">七月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/06/">六月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/05/">五月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/04/">四月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2019/01/">一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/12/">十二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/09/">九月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/05/">五月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/history/archives/2017/12/">十二月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/history/2022/03/31/redis/000-redis-interview/">Redis面试总结202203</a>
          </li>
        
          <li>
            <a href="/history/2019/10/27/maven/009-maven-deploy/">使用IDEA部署jar包到maven仓库(maven deploy)</a>
          </li>
        
          <li>
            <a href="/history/2019/10/24/java/075-pluggable-annotation-processing-lombok/">Pluggable Annotation Processing的讲解与实践</a>
          </li>
        
          <li>
            <a href="/history/2019/10/18/life/036-weekly-learn/">2019-42-周报</a>
          </li>
        
          <li>
            <a href="/history/2019/10/15/shell/003-carriage-linechange/">r command not found</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2022 Jackpler<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/history/" class="mobile-nav-link">home</a>
  
    <a href="/history/archives" class="mobile-nav-link">archives</a>
  
    <a href="/history/about" class="mobile-nav-link">about</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/history/fancybox/jquery.fancybox.css">

  
<script src="/history/fancybox/jquery.fancybox.pack.js"></script>




<script src="/history/js/script.js"></script>




  </div>
</body>
</html>